<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRISMA 3.42</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="https://i.imgur.com/enKOWs3.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        .form-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }

        .info-text {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .submit-button {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            width: 100%;
            text-align: center;
            cursor: pointer;
            margin-top: 1rem;
        }

        .submit-button:hover {
            background-color: #1d4ed8;
        }

        .results-section {
            background: #f8fafc;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .highlight-box {
            background: #eef2ff;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .form-section {
                padding: 1rem;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            .form-label {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            
            .info-text {
                font-size: 0.75rem;
            }
        }

        .render-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .render-image {
            max-width: 300px;
            max-height: 200px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .render-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .render-image {
                max-width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-green-500 min-h-screen p-4">
    <div class="max-w-4xl mx-auto bg-white bg-opacity-50 rounded-lg shadow-lg p-6">
        <div class="flex justify-center mb-6">
            <div class="relative">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 306.71 153.03" class="h-24 w-auto relative z-10">
                    <defs><style>.cls-1{fill:#fff;}.cls-2{fill:none;}.cls-3{fill:#60b22f;}.cls-4{fill:#9cc42c;}.cls-5{fill:#bbd02c;}.cls-6{fill:#dadb1a;}.cls-7{fill:#ebe320;}</style></defs>
                    <g id="Livello_2" data-name="Livello 2"><g id="Livello_1-2" data-name="Livello 1">
                        <path class="cls-1" d="M33.34,83.42A72.18,72.18,0,0,1,14.52,81,48.77,48.77,0,0,1,0,74.83L7.35,58.22a51.66,51.66,0,0,0,12.26,5.6A45.55,45.55,0,0,0,33.45,66,28.26,28.26,0,0,0,41,65.23,8.43,8.43,0,0,0,45,63a5.14,5.14,0,0,0,1.29-3.5,4.64,4.64,0,0,0-2.48-4.13,24.64,24.64,0,0,0-6.5-2.6c-2.68-.71-5.57-1.39-8.7-2a86.34,86.34,0,0,1-9.55-2.55A36.22,36.22,0,0,1,10.28,44,19.94,19.94,0,0,1,3.9,37.2,20.64,20.64,0,0,1,1.47,26.69,22.47,22.47,0,0,1,5.32,13.92Q9.15,8.16,17,4.66T36.39,1.15A67.79,67.79,0,0,1,51.71,2.9,45.12,45.12,0,0,1,65,8.16L58.2,24.66A48.24,48.24,0,0,0,47,20a41.77,41.77,0,0,0-10.74-1.47,22.49,22.49,0,0,0-7.46,1,9,9,0,0,0-4.06,2.6,5.4,5.4,0,0,0-1.24,3.39A4.75,4.75,0,0,0,26,29.8a22.51,22.51,0,0,0,6.45,2.48q3.95,1,8.75,2a96.06,96.06,0,0,1,9.55,2.53,38.78,38.78,0,0,1,8.76,4.07A20.13,20.13,0,0,1,66,47.54a19.82,19.82,0,0,1,2.49,10.34,22.46,22.46,0,0,1-3.9,12.72,26.79,26.79,0,0,1-11.7,9.32C47.7,82.26,41.17,83.42,33.34,83.42Z"/><path class="cls-1" d="M174.37,81.84V2.73h22.38V64.1h37.63V81.84Z"/><polygon class="cls-1" points="265.35 64.44 265.35 49.97 300.49 49.97 300.49 33.36 265.35 33.36 265.35 20.14 305.24 20.14 305.24 2.73 243.3 2.73 243.3 81.84 306.71 81.84 306.71 64.44 265.35 64.44"/><polygon class="cls-1" points="46.19 105.84 46.19 92.86 0 92.86 0 151.85 16.69 151.85 16.69 131.63 42.65 131.63 42.65 118.73 16.69 118.73 16.69 105.84 46.19 105.84"/><path class="cls-1" d="M95.92,151.86h17.36l-26.13-59H70.72l-26,59h17l4.63-11.55h25ZM71.24,128.09l7.57-18.86,7.57,18.86Z"/><path class="cls-1" d="M146.58,153a36.11,36.11,0,0,1-12.9-2.23,31.22,31.22,0,0,1-10.29-6.32,28.77,28.77,0,0,1-6.82-9.73,32.68,32.68,0,0,1,0-24.78,28.81,28.81,0,0,1,6.82-9.74,31.22,31.22,0,0,1,10.29-6.32,38.89,38.89,0,0,1,27.52.59,27.42,27.42,0,0,1,10.74,8.3l-10.62,9.61a20.73,20.73,0,0,0-6.32-5.14,16.37,16.37,0,0,0-7.58-1.77,18.13,18.13,0,0,0-6.66,1.18,14.4,14.4,0,0,0-5.18,3.41,16,16,0,0,0-3.37,5.35,20.05,20.05,0,0,0,0,13.83,15.88,15.88,0,0,0,3.37,5.35,14.14,14.14,0,0,0,5.18,3.41,18.13,18.13,0,0,0,6.66,1.18,16.37,16.37,0,0,0,7.58-1.77,20.32,20.32,0,0,0,6.32-5.22l10.62,9.6a27.73,27.73,0,0,1-10.74,8.35A35.68,35.68,0,0,1,146.58,153Z"/><path class="cls-1" d="M179.44,151.86v-59h16.69v59Z"/><path class="cls-1" d="M208,151.86v-59H224.7v45.76h28.07v13.24Z"/><polygon class="cls-1" points="275.86 138.88 275.86 128.09 302.07 128.09 302.07 115.7 275.86 115.7 275.86 105.84 305.61 105.84 305.61 92.86 259.42 92.86 259.42 151.85 306.71 151.85 306.71 138.88 275.86 138.88"/><path class="cls-2" d="M118.55,83.42a48.93,48.93,0,0,1-17.47-3,41,41,0,0,1-14-8.65A40,40,0,0,1,74.59,42.18,39.47,39.47,0,0,1,77.92,25.9,40.74,40.74,0,0,1,101,4.2a51.82,51.82,0,0,1,35,0A41.59,41.59,0,0,1,150,12.79a40.17,40.17,0,0,1,9.21,13,39.57,39.57,0,0,1,3.34,16.39,41.22,41.22,0,0,1-3.27,16.55A39.11,39.11,0,0,1,150,71.78a41.93,41.93,0,0,1-14,8.59A48.69,48.69,0,0,1,118.55,83.42Z"/><path class="cls-1" d="M159.79,25a40.58,40.58,0,0,0-9.35-13.19A42,42,0,0,0,136.32,3.1a52.54,52.54,0,0,0-35.56,0,41.38,41.38,0,0,0-23.46,22,40.14,40.14,0,0,0-3.38,16.52,40.82,40.82,0,0,0,3.38,16.7,41.18,41.18,0,0,0,23.52,22.08,52.37,52.37,0,0,0,35.5,0A42.71,42.71,0,0,0,150.5,71.7a39.64,39.64,0,0,0,9.35-13.25,41.55,41.55,0,0,0,3.33-16.81A40.24,40.24,0,0,0,159.79,25Z"/><path class="cls-3" d="M146,22.77c0,.81.07,1.63.07,2.46a41.07,41.07,0,0,1-3.28,16.56,39.08,39.08,0,0,1-9.21,13.05,42,42,0,0,1-14,8.59,48.76,48.76,0,0,1-17.51,3.05c-1.82,0-3.6-.09-5.34-.26-.46-.35-.92-.71-1.36-1.07a31.47,31.47,0,0,0,9.17,5.27,41.85,41.85,0,0,0,27.91,0,32.15,32.15,0,0,0,10.68-6.54,28.93,28.93,0,0,0,6.85-9.72,30.85,30.85,0,0,0,2.43-12.53A29.36,29.36,0,0,0,150,29.37,30.21,30.21,0,0,0,146,22.77Z"/><path class="cls-4" d="M102.14,66.48a48.76,48.76,0,0,0,17.51-3.05,42,42,0,0,0,14-8.59,39.08,39.08,0,0,0,9.21-13.05,41.07,41.07,0,0,0,3.28-16.56c0-.83,0-1.65-.07-2.46h0c-.4-.5-.82-1-1.25-1.46L144.5,21c-.45-.48-.91-1-1.39-1.41-.75-.7-1.52-1.36-2.33-2a30.92,30.92,0,0,0-3.87-2.51c-.66-.37-1.35-.7-2-1,.62.29,1.24.59,1.83.91,0,.29,0,.57,0,.86a41,41,0,0,1-3.27,16.55,39.25,39.25,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48.9,48.9,0,0,1-17.51,3c-1.42,0-2.81-.05-4.19-.16-.26-.46-.52-.93-.76-1.41a30.75,30.75,0,0,0,3.17,5,28.22,28.22,0,0,0,2,2.28c.36.37.72.73,1.09,1.09h0c.43.41.88.8,1.33,1.18l.08.07c.44.36.9.72,1.36,1.07C98.54,66.39,100.32,66.48,102.14,66.48Z"/><path class="cls-5" d="M87.8,55.52c.24.48.5.95.76,1.41,1.38.11,2.77.16,4.19.16a48.9,48.9,0,0,0,17.51-3,42.26,42.26,0,0,0,14-8.59,39.25,39.25,0,0,0,9.22-13.06,41,41,0,0,0,3.27-16.55c0-.29,0-.57,0-.86-.59-.32-1.21-.62-1.83-.91l-.37-.17c-.64-.28-1.29-.56-2-.82h0c-.52-.2-1.05-.38-1.59-.56-1.08-.35-2.19-.65-3.32-.9l-.57-.11a39.52,39.52,0,0,1-3,11.49,38.91,38.91,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48,48,0,0,1-15.72,3c0,.15,0,.31.08.47A27.85,27.85,0,0,0,87.08,54c.23.51.46,1,.71,1.49Z"/><path class="cls-6" d="M85.15,47.67a48,48,0,0,0,15.72-3,42.26,42.26,0,0,0,14-8.59A38.91,38.91,0,0,0,124.05,23a39.52,39.52,0,0,0,3-11.49h0c-.64-.13-1.29-.24-1.94-.34l-.21,0c-.58-.08-1.17-.16-1.76-.22l-.37,0c-.55-.05-1.1-.09-1.66-.12l-.46,0c-.68,0-1.38-.05-2.08-.05h0c-1,0-1.88,0-2.81.09-.32,1-.68,1.91-1.08,2.83a38.91,38.91,0,0,1-9.22,13.06,42.16,42.16,0,0,1-14,8.59,45.69,45.69,0,0,1-6.57,1.93,33.57,33.57,0,0,0-.29,4.44c0,.54,0,1.08,0,1.6s0,.85.08,1.26c0,.09,0,.17,0,.25.09,1,.22,2,.4,2.92Z"/><path class="cls-7" d="M105.44,26.68a38.91,38.91,0,0,0,9.22-13.06c.4-.92.76-1.87,1.08-2.83h0a42,42,0,0,0-5.72.74l-.15,0c-.86.18-1.69.39-2.52.62l-.4.12c-.81.24-1.61.5-2.39.79h0A30.88,30.88,0,0,0,94,19.62a29.91,29.91,0,0,0-4.8,5.83c-.42.65-.8,1.33-1.17,2s-.69,1.33-1,2-.47,1.12-.68,1.69c0,.14-.09.28-.14.42-.17.47-.32.95-.46,1.43l-.09.33a28.07,28.07,0,0,0-.78,3.84h0a45.69,45.69,0,0,0,6.57-1.93A42.16,42.16,0,0,0,105.44,26.68Z"/>
                    </g></g>
                </svg>
            </div>
        </div>
        <h1 style="font-size: 2.25rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center;">
            <span style="color: rgb(255, 255, 0);">PRISM</span>
            <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" style="width: 3rem; height: 3rem; margin-left: -0.3rem; transform: translateY(0.0rem);">
                <!-- Prisma triangolare - modificato per renderlo proporzionalmente più alto -->
                <polygon points="256,80 70,400 442,400" fill="#fff" stroke="#333" stroke-width="6"/>
                
                <!-- Spettro luminoso all'interno del prisma - anche questo adattato -->
                <defs>
                    <linearGradient id="rainbow" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#ff0000"/>
                        <stop offset="14%" stop-color="#ff7f00"/>
                        <stop offset="28%" stop-color="#ffff00"/>
                        <stop offset="42%" stop-color="#00ff00"/>
                        <stop offset="57%" stop-color="#0000ff"/>
                        <stop offset="71%" stop-color="#4b0082"/>
                        <stop offset="85%" stop-color="#9400d3"/>
                        <stop offset="100%" stop-color="#ff00ff"/>
                    </linearGradient>
                </defs>
                
                <!-- Strisce di colore all'interno del prisma - adattate -->
                <polygon points="256,110 100,380 412,380" fill="url(#rainbow)" opacity="0.8"/>
            </svg>
        </h1>
        <h3 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 0.5rem;">
            <span style="color: #000000;">Pricing Reliable Intelligence System</span>
        </h3>
        <h3 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem;">
            <span style="color: #000000;">for Management and Analysis</span>
        </h3>

        <form id="preventivoForm">
            <!-- Dati Impianto -->
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    Dati Impianto
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Nome e Cognome Cliente</label>
                        <input id="nomeCognomeCliente" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Indirizzo Impianto (completo di città)</label>
                        <input id="indirizzoImpianto" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Dati Struttura -->
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" />
                    </svg>
                    Dati Struttura
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Tipo di Tetto</label>
                        <select id="tipoTetto" class="form-select">
                            <option value="lamiera">Lamiera Grecata</option>
                            <option value="tegole">Tetto con Tegole</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Influisce sul costo del montaggio</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Altezza Edificio (m)</label>
                        <input type="number" id="altezzaCapannone" class="form-input" value="10" min="0" required>
                        <p class="text-xs text-gray-500 mt-1">Influisce sul totale dei cavi</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Lunghezza Edificio (m)</label>
                        <input type="number" id="profonditaCapannone" class="form-input" value="40" min="0" required>
                        <p class="text-xs text-gray-500 mt-1">Influisce sul totale dei cavi</p>
                    </div>
                </div>
                
                <!-- Gestione Falde - fuori dalla griglia -->
                <div class="mt-6">
                    <h3 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#2E8B57">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                        Falde
                    </h3>
                    <div id="faldeContainer">
                        <!-- Le falde dinamiche verranno inserite qui -->
                    </div>
                    <button type="button" id="aggiungiFalda" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Falda
                    </button>
                </div>
            </div>

            <!-- Componenti -->
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    Componenti
                </h2>
                
                <!-- Inverter -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#2E8B57">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                        </svg>
                        Inverter
                    </h3>
                    <div id="invertersContainer">
                        <!-- Gli inverter dinamici verranno inseriti qui -->
                    </div>
                    <button type="button" id="aggiungiInverter" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Inverter
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <select id="inverter" class="form-select hidden">
                                <option value="none">Nessun Inverter</option>

                                <optgroup label="Micro Inverter">
                                    <option value="x1-micro-800" data-prezzo="122">X1-Micro 800 - X1-Micro 800 0.8kw 2MPPT (€122/cad)</option>
                                    <option value="x1-micro-900" data-prezzo="128">X1-Micro 900 - X1-Micro 900 0.9kw 2MPPT (€128/cad)</option>
                                    <option value="x1-micro-1000" data-prezzo="142">X1-Micro 1000 - X1-Micro 1000 1.0kw 2MPPT (€142/cad)</option>
                                    <option value="x1-micro-1200" data-prezzo="155">X1-Micro 1200 - X1-Micro 1200 0.12kw 2MPPT (€155/cad)</option>
                                    <option value="x1-micro-1300" data-prezzo="215">X1-Micro 1300 - X1-Micro 1300 1.3kw 2MPPT (€215/cad)</option>
                                    <option value="x1-micro-1500" data-prezzo="222">X1-Micro 1500 - X1-Micro 1500 1.5kw 2MPPT (€222/cad)</option>
                                    <option value="x1-micro-1600" data-prezzo="229">X1-Micro 1600 - X1-Micro 1600 1.6kw 2MPPT (€229/cad)</option>
                                    <option value="x1-micro-1800" data-prezzo="244">X1-Micro 1800 - X1-Micro 1800 1.8kw 2MPPT (€244/cad)</option>
                                    <option value="x1-micro-2000" data-prezzo="263">X1-Micro 2000 - X1-Micro 2000 2.0kw 2MPPT (€263/cad)</option>
                                    <option value="x1-micro-2200" data-prezzo="297">X1-Micro 2200 - X1-Micro 2200 2.2kw 2MPPT (€297/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Monofase">
                                    <option value="x1-mini-0-6k-g4" data-potenza="600" data-prezzo="237">X1-MINI-0.6K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€237/cad)</option>
                                    <option value="x1-mini-0-7k-g4" data-potenza="700" data-prezzo="250">X1-MINI-0.7K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€250/cad)</option>
                                    <option value="x1-mini-1-1k-g4" data-potenza="1100" data-prezzo="262">X1-MINI-1.1K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€262/cad)</option>
                                    <option value="x1-mini-1-5k-g4" data-potenza="1500" data-prezzo="280">X1-MINI-1.5K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€280/cad)</option>
                                    <option value="x1-mini-2-0k-g4" data-potenza="2000" data-prezzo="307">X1-MINI-2.0K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€307/cad)</option>
                                    <option value="x1-mini-2-5k-g4" data-potenza="2500" data-prezzo="345">X1-MINI-2.5K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€345/cad)</option>
                                    <option value="x1-mini-3-0k-g4" data-potenza="3000" data-prezzo="374">X1-MINI-3.0K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€374/cad)</option>
                                    <option value="x1-mini-3-3k-g4" data-potenza="3300" data-prezzo="394">X1-MINI-3.3K-G4 - Inverter monofase 1 MPPT singolo - quarta generazione (€394/cad)</option>
                                    <option value="x1-boost-2-5k-g4" data-potenza="2500" data-prezzo="442">X1-BOOST-2.5K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€442/cad)</option>
                                    <option value="x1-boost-3-0k-g4" data-potenza="3000" data-prezzo="447">X1-BOOST-3.0K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€447/cad)</option>
                                    <option value="x1-boost-3-3k-g4" data-potenza="3300" data-prezzo="452">X1-BOOST-3.3K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€452/cad)</option>
                                    <option value="x1-boost-3-6k-g4" data-potenza="3600" data-prezzo="475">X1-BOOST-3.6K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€475/cad)</option>
                                    <option value="x1-boost-4-2k-g4" data-potenza="4200" data-prezzo="493">X1-BOOST-4.2K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€493/cad)</option>
                                    <option value="x1-boost-5-0k-g4" data-potenza="5000" data-prezzo="553">X1-BOOST-5.0K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€553/cad)</option>
                                    <option value="x1-boost-6-0k-g4" data-potenza="6000" data-prezzo="592">X1-BOOST-6.0K-G4 - Inverter monofase 2 MPPT singolo - quarta generazione (€592/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Trifase">
                                    <option value="x3-mic-4k-g2" data-potenza="4000" data-prezzo="660">X3-MIC-4K-G2 - Inverter trifase 2 MPPT singoli - seconda generazione (€660/cad)</option>
                                    <option value="x3-mic-5k-g2" data-potenza="5000" data-prezzo="686">X3-MIC-5K-G2 - Inverter trifase 2 MPPT singoli - seconda generazione (€686/cad)</option>
                                    <option value="x3-mic-6k-g2" data-potenza="6000" data-prezzo="715">X3-MIC-6K-G2 - Inverter trifase 2 MPPT singoli - seconda generazione (€715/cad)</option>
                                    <option value="x3-mic-8k-g2" data-potenza="8000" data-prezzo="761">X3-MIC-8K-G2 - Inverter trifase 2 MPPT singoli - seconda generazione (€761/cad)</option>
                                    <option value="x3-mic-10k-g2" data-potenza="10000" data-prezzo="796">X3-MIC-10K-G2 - Inverter trifase 2 MPPT singoli - seconda generazione (€796/cad)</option>
                                    <option value="x3-pro-8k-g2" data-potenza="8000" data-prezzo="951">X3-PRO-8K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€951/cad)</option>
                                    <option value="x3-pro-10k-g2" data-potenza="10000" data-prezzo="984">X3-PRO-10K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€984/cad)</option>
                                    <option value="x3-pro-12k-g2" data-potenza="12000" data-prezzo="1025">X3-PRO-12K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€1.025/cad)</option>
                                    <option value="x3-pro-15k-g2" data-potenza="15000" data-prezzo="1073">X3-PRO-15K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€1.073/cad)</option>
                                    <option value="x3-pro-17k-g2" data-potenza="17000" data-prezzo="1109">X3-PRO-17K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€1.109/cad)</option>
                                    <option value="x3-pro-17-0" data-potenza="17000" data-prezzo="1460">X3-PRO-17.0 - Inverter trifase 3 MPPT doppi - seconda generazione (€1.460/cad)</option>
                                    <option value="x3-pro-20-0" data-potenza="20000" data-prezzo="1656">X3-PRO-20.0 - Inverter trifase 3 MPPT doppi - seconda generazione (€1.656/cad)</option>
                                    <option value="x3-pro-25-0" data-potenza="25000" data-prezzo="1809">X3-PRO-25.0 - Inverter trifase 3 MPPT doppi - seconda generazione (€1.809/cad)</option>
                                    <option value="x3-pro-30-0" data-potenza="30000" data-prezzo="1961">X3-PRO-30.0 - Inverter trifase 3 MPPT doppi - seconda generazione (€1.961/cad)</option>
                                    <option value="x3-pro-20k-g2" data-potenza="20000" data-prezzo="1263">X3-PRO-20K-G2 - Inverter trifase 2 MPPT doppi - seconda generazione (€1.263/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Mega">
                                    <option value="x3-mga-40k-g2" data-potenza="40000" data-prezzo="1785">X3-MGA-40K-G2 - Inverter trifase 5 MPPT doppi - seconda generazione (€1.785/cad)</option>
                                    <option value="x3-mga-50k-g2" data-potenza="50000" data-prezzo="1918">X3-MGA-50K-G2 - Inverter trifase 5 MPPT doppi - seconda generazione (€1.918/cad)</option>
                                    <option value="x3-mga-60k-g2" data-potenza="60000" data-prezzo="1984">X3-MGA-60K-G2 - Inverter trifase 5 MPPT doppi - seconda generazione (€1.984/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Forth">
                                    <option value="x3-80k" data-potenza="80000" data-prezzo="2843">X3-80K - Inverter trifase 9 MPPT doppi (€2.843/cad)</option>
                                    <option value="x3-100k" data-potenza="100000" data-prezzo="2909">X3-100K - Inverter trifase 9 MPPT doppi (€2.909/cad)</option>
                                    <option value="x3-110k" data-potenza="110000" data-prezzo="2975">X3-110K - Inverter trifase 9 MPPT doppi (€2.975/cad)</option>
                                    <option value="x3-120k" data-potenza="120000" data-prezzo="3042">X3-120K - Inverter trifase 9 MPPT doppi (€3.042/cad)</option>
                                    <option value="x3-125k" data-potenza="125000" data-prezzo="3099">X3-125K - Inverter trifase 9 MPPT doppi (€3.099/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Aelio">
                                    <option value="x3-aelio-50k" data-potenza="50000" data-prezzo="5653">X3-AELIO-50K - Inverter DC Couple BESS 50kW (€5.653/cad)</option>
                                    <option value="x3-aelio-60k" data-potenza="60000" data-prezzo="5967">X3-AELIO-60K - Inverter DC Couple BESS 60kW (€5.967/cad)</option>
                                </optgroup>

                                <optgroup label="Inverter Grand">
                                    <option value="x3-grd-300k-hv" data-potenza="300000" data-prezzo="7472">X3-GRD-300K-HV - Inverter di grande potenza 300kW (€7.472/cad)</option>
                                    <option value="x3-grd-320k-hv" data-potenza="320000" data-prezzo="7604">X3-GRD-320K-HV - Inverter di grande potenza 320kW (€7.604/cad)</option>
                                    <option value="x3-grd-333k-hv" data-potenza="333000" data-prezzo="7737">X3-GRD-333K-HV - Inverter di grande potenza 333kW (€7.737/cad)</option>
                                    <option value="x3-grd-350k-hv" data-potenza="350000" data-prezzo="7869">X3-GRD-350K-HV - Inverter di grande potenza 350kW (€7.869/cad)</option>
                                </optgroup>

                                <optgroup label="Hybrid Low Voltage">
                                    <option value="x1-hyb-3-0-lv" data-potenza="3000" data-prezzo="931">X1-HYB-3.0-LV - Inverter Hybrid LV Entry Level 3.0kW (€931/cad)</option>
                                    <option value="x1-hyb-3-7-lv" data-potenza="3700" data-prezzo="944">X1-HYB-3.7-LV - Inverter Hybrid LV Entry Level 3.7kW (€944/cad)</option>
                                    <option value="x1-hyb-4-0-lv" data-potenza="4000" data-prezzo="957">X1-HYB-4.0-LV - Inverter Hybrid LV Entry Level 4.0kW (€957/cad)</option>
                                    <option value="x1-hyb-4-6-lv" data-potenza="4600" data-prezzo="971">X1-HYB-4.6-LV - Inverter Hybrid LV Entry Level 4.6kW (€971/cad)</option>
                                    <option value="x1-hyb-5-0-lv" data-potenza="5000" data-prezzo="1012">X1-HYB-5.0-LV - Inverter Hybrid LV Entry Level 5.0kW (€1.012/cad)</option>
                                    <option value="x1-hyb-6-0-lv" data-potenza="6000" data-prezzo="1025">X1-HYB-6.0-LV - Inverter Hybrid LV Entry Level 6.0kW (€1.025/cad)</option>
                                </optgroup>

                                <optgroup label="Hybrid G4 Monofase">
                                    <option value="x1-hybrid-3-0d-g4" data-potenza="3000" data-prezzo="913">X1-Hybrid-3.0D G4 - Inverter Hybrid ESS G4 monofase 3.0kW (€913/cad)</option>
                                    <option value="x1-hybrid-3-7d-g4" data-potenza="3700" data-prezzo="950">X1-Hybrid-3.7D G4 - Inverter Hybrid ESS G4 monofase 3.7kW (€950/cad)</option>
                                    <option value="x1-hybrid-5-0d-g4" data-potenza="5000" data-prezzo="992">X1-Hybrid-5.0D G4 - Inverter Hybrid ESS G4 monofase 5.0kW (€992/cad)</option>
                                    <option value="x1-hybrid-6-0d-g4" data-potenza="6000" data-prezzo="1048">X1-Hybrid-6.0D G4 - Inverter Hybrid ESS G4 monofase 6.0kW (€1.048/cad)</option>
                                    <option value="x1-hybrid-7-5d-g4" data-potenza="7500" data-prezzo="1096">X1-Hybrid-7.5D G4 - Inverter Hybrid ESS G4 monofase 7.5kW (€1.096/cad)</option>
                                </optgroup>

                                <optgroup label="Hybrid G4 Trifase">
                                    <option value="x3-hybrid-5-0d-g4" data-potenza="5000" data-prezzo="1281">X3-Hybrid-5.0D G4 - Inverter Hybrid ESS G4 trifase 5.0kW (€1.281/cad)</option>
                                    <option value="x3-hybrid-6-0d-g4" data-potenza="6000" data-prezzo="1454">X3-Hybrid-6.0D G4 - Inverter Hybrid ESS G4 trifase 6.0kW (€1.454/cad)</option>
                                    <option value="x3-hybrid-8-0d-g4" data-potenza="8000" data-prezzo="1528">X3-Hybrid-8.0D G4 - Inverter Hybrid ESS G4 trifase 8.0kW (€1.528/cad)</option>
                                    <option value="x3-hybrid-10-0d-g4" data-potenza="10000" data-prezzo="1677">X3-Hybrid-10.0D G4 - Inverter Hybrid ESS G4 trifase 10.0kW (€1.677/cad)</option>
                                    <option value="x3-hybrid-12-0d-g4" data-potenza="12000" data-prezzo="1749">X3-Hybrid-12.0D G4 - Inverter Hybrid ESS G4 trifase 12.0kW (€1.749/cad)</option>
                                    <option value="x3-hybrid-15-0d-g4" data-potenza="15000" data-prezzo="1804">X3-Hybrid-15.0D G4 - Inverter Hybrid ESS G4 trifase 15.0kW (€1.804/cad)</option>
                                </optgroup>

                                <optgroup label="Ultra Serie">
                                    <option value="x3-ult-15k" data-potenza="15000" data-prezzo="2307">X3-ULT-15K - Inverter Ultra Hybrid 15kW (€2.307/cad)</option>
                                    <option value="x3-ult-19-9k" data-potenza="19900" data-prezzo="2426">X3-ULT-19.9K - Inverter Ultra Hybrid 19.9kW (€2.426/cad)</option>
                                    <option value="x3-ult-20k" data-potenza="20000" data-prezzo="2426">X3-ULT-20K - Inverter Ultra Hybrid 20kW (€2.426/cad)</option>
                                    <option value="x3-ult-25k" data-potenza="25000" data-prezzo="2525">X3-ULT-25K - Inverter Ultra Hybrid 25kW (€2.525/cad)</option>
                                    <option value="x3-ult-30k" data-potenza="30000" data-prezzo="2651">X3-ULT-30K - Inverter Ultra Hybrid 30kW (€2.651/cad)</option>
                                </optgroup>

                                <optgroup label="Sistema IES">
                                    <option value="x1-ies-3k" data-potenza="3000" data-prezzo="986">X1-IES-3K - Sistema IES Alta Gamma 3.0kW (€986/cad)</option>
                                    <option value="x1-ies-3-7k" data-potenza="3700" data-prezzo="1025">X1-IES-3.7K - Sistema IES Alta Gamma 3.7kW (€1.025/cad)</option>
                                    <option value="x1-ies-5k" data-potenza="5000" data-prezzo="1070">X1-IES-5K - Sistema IES Alta Gamma 5.0kW (€1.070/cad)</option>
                                    <option value="x1-ies-6k" data-potenza="6000" data-prezzo="1130">X1-IES-6K - Sistema IES Alta Gamma 6.0kW (€1.130/cad)</option>
                                    <option value="x1-ies-8k" data-potenza="8000" data-prezzo="1185">X1-IES-8K - Sistema IES Alta Gamma 8.0kW (€1.185/cad)</option>
                                    <option value="x3-ies-5k" data-potenza="5000" data-prezzo="1370">X3-IES-5K - Sistema IES Alta Gamma 5.0kW (€1.370/cad)</option>
                                    <option value="x3-ies-6k" data-potenza="6000" data-prezzo="1554">X3-IES-6K - Sistema IES Alta Gamma 6.0kW (€1.554/cad)</option>
                                    <option value="x3-ies-8k" data-potenza="8000" data-prezzo="1630">X3-IES-8K - Sistema IES Alta Gamma 8.0kW (€1.630/cad)</option>
                                    <option value="x3-ies-10k" data-potenza="10000" data-prezzo="1784">X3-IES-10K - Sistema IES Alta Gamma 10.0kW (€1.784/cad)</option>
                                    <option value="x3-ies-12k" data-potenza="12000" data-prezzo="1872">X3-IES-12K - Sistema IES Alta Gamma 12.0kW (€1.872/cad)</option>
                                    <option value="x3-ies-15k" data-potenza="15000" data-prezzo="1930">X3-IES-15K - Sistema IES Alta Gamma 15.0kW (€1.930/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sistema di Accumulo -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#2E8B57">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                        </svg>
                        Sistema di Accumulo
                    </h3>
                    <div id="batterieContainer">
                        <!-- Le batterie dinamiche verranno inserite qui -->
                    </div>
                    <button type="button" id="aggiungiBatteria" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Aggiungi Batteria
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <select id="batterieTipo" class="form-select hidden">
                                <option value="none">Nessuna Batteria</option>

                                <optgroup label="Batterie T30">
                                    <option value="t30-battery" data-prezzo="850">T30 Battery - Batteria litio-ferro-fosfato T30 (€850/cad)</option>
                                </optgroup>

                                <optgroup label="Batterie T58">
                                    <option value="t58-master" data-prezzo="1918">T58 Master - Batteria T58 con BMS (€1.918/cad)</option>
                                    <option value="t58-slave" data-prezzo="1653">T58 Slave - Batteria T58 slave (€1.653/cad)</option>
                                </optgroup>

                                <optgroup label="Batterie HS">
                                    <option value="tp-hs36" data-prezzo="1034">TP-HS36 - Batteria HS 3.6kWh (€1.034/cad)</option>
                                    <option value="tp-hs25" data-prezzo="746">TP-HS25 - Batteria HS 2.5kWh (€746/cad)</option>
                                </optgroup>

                                <optgroup label="Batterie Rack">
                                    <option value="tb-hr140" data-prezzo="3174">TB-HR140 - Batteria Rack 14kWh (€3.174/cad)</option>
                                </optgroup>

                                <optgroup label="Batterie">
                                    <option value="tp-ld53" data-prezzo="1034">TP-LD53 - Batteria IES 5.3kWh Low Voltage (€1.034/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori Batterie">
                                    <option value="tbms-r15" data-prezzo="1323">TBMS-R15 - BMS per batteria rack (€1.323/cad)</option>
                                    <option value="battery-rack-cabinet" data-prezzo="860">Battery Rack Cabinet - Cabinet per 7 batterie rack (€860/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori T30">
                                    <option value="t30-bms" data-prezzo="507">T30 BMS - BMS per batterie T30 (€507/cad)</option>
                                    <option value="bms-parallel-box-g2-t30" data-prezzo="715">BMS Parallel Box G2 T30 - Parallel Box per BMS T30 (€715/cad)</option>
                                    <option value="accessory-pack-t30" data-prezzo="159">Accessory Pack T30 - Kit accessori per batteria T30 (€159/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori T58">
                                    <option value="bms-parallel-box-ii" data-prezzo="540">BMS Parallel Box II - Parallel Box per batterie T58 (€540/cad)</option>
                                    <option value="bms-parallel-box-g2-t58" data-prezzo="688">BMS Parallel Box G2 T58 - Parallel Box G2 per T58 (€688/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori HS">
                                    <option value="tbms-mcs0800" data-prezzo="540">TBMS-MCS0800 - BMS per batterie HS (€540/cad)</option>
                                    <option value="tc-pbox70" data-prezzo="216">TC-PBOX70 - Parallel Box per batterie HS (€216/cad)</option>
                                </optgroup>

                                <optgroup label="Carica Batterie">
                                    <option value="triple-power-charge-box" data-prezzo="1005">Triple Power Charge Box - Caricabatterie tripla potenza (€1.005/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <!-- ESS Cabinet section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd" />
                                </svg>
                                ESS Cabinet
                            </label>
                            <select id="essCabinet" class="form-select">
                                <option value="none">Nessun Cabinet</option>

                                <optgroup label="ESS Cabinet">
                                    <option value="aelio-p50b100" data-prezzo="52086">AELIO-P50B100 - DC Couple BESS Cabinet 50kW 100kWh (€52.086/cad)</option>
                                    <option value="aelio-p50b200" data-prezzo="66967">AELIO-P50B200 - DC Couple BESS Cabinet 50kW 200kWh (€66.967/cad)</option>
                                </optgroup>

                                <optgroup label="ESS Trene">
                                    <option value="trene-p100b215-i" data-prezzo="81849">TRENE-P100B215-I - AC Couple BESS Cabinet 100kW 215kWh (€81.849/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group" id="numeroEssCabinetContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità ESS Cabinet
                            </label>
                            <input type="number" id="numeroEssCabinet" class="form-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- Parallel Box section -->
                    <div id="parallelBoxContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                                </svg>
                                Parallel Box
                            </label>
                            <select id="parallelBox" class="form-select">
                                <option value="none">Nessuna Parallel box</option>

                                <optgroup label="Adapter Box">
                                    <option value="adapter-box" data-prezzo="38">Adapter Box - Adattatore per pompe di calore (€38/cad)</option>
                                    <option value="adapter-box-g2" data-prezzo="60">Adapter Box G2 - Adattatore G2 per pompe di calore (€60/cad)</option>
                                </optgroup>

                                <optgroup label="EPS Box">
                                    <option value="x1-eps-box" data-prezzo="212">X1-EPS Box - Sistema backup monofase (€212/cad)</option>
                                    <option value="x3-eps-box" data-prezzo="278">X3-EPS Box - Sistema backup trifase (€278/cad)</option>
                                    <option value="x3-eps-box-p5-e" data-prezzo="1597">X3-EPS-BOX-P5-E - Sistema backup parallelo P5 (€1.597/cad)</option>
                                    <option value="x3-pbox-60kw-g2" data-prezzo="1103">X3-PBOX-60KW G2 - Parallel Box 60kW per backup multiplo (€1.103/cad)</option>
                                    <option value="x3-pbox-150kw-g2" data-prezzo="1812">X3-PBOX-150KW G2 - Parallel Box 150kW per backup multiplo (€1.812/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group" id="numeroParallelBoxContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità Parallel Box
                            </label>
                            <input type="number" id="numeroParallelBox" class="form-input" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Ricarica Elettrica -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="#2E8B57">
                            <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        </svg>
                        Ricarica Elettrica
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Tipo Caricatore EV</label>
                            <select id="evCharger" class="form-select">
                                <option value="none">Nessun Caricatore</option>
                                <option value="x1-evc-7-2k-sxh-" data-prezzo="399">X1-EVC-7.2K(SXH) - Caricatore monofase 7.2kW senza cavo (€399/cad)</option>
                                <option value="x1-evc-7-2k-pxh-" data-prezzo="439">X1-EVC-7.2K(PXH) - Caricatore monofase 7.2kW con cavo (€439/cad)</option>
                                <option value="x3-evc-11k-sxh-" data-prezzo="488">X3-EVC-11K(SXH) - Caricatore trifase 11kW senza cavo (€488/cad)</option>
                                <option value="x3-evc-11k-pxh-" data-prezzo="546">X3-EVC-11K(PXH) - Caricatore trifase 11kW con cavo (€546/cad)</option>
                                <option value="x3-evc-22k-sxh-" data-prezzo="555">X3-EVC-22K(SXH) - Caricatore trifase 22kW senza cavo (€555/cad)</option>
                                <option value="x3-evc-22k-pxh-" data-prezzo="624">X3-EVC-22K(PXH) - Caricatore trifase 22kW con cavo (€624/cad)</option>
                            </select>
                        </div>
                        <div class="form-group" id="numeroEvChargerContainer">
                            <label class="form-label">Numero Caricatori EV</label>
                            <input type="number" id="numeroEvCharger" class="form-input" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Accessori e Monitoraggio -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#2E8B57">
                            <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                        </svg>
                        Accessori e Monitoraggio
                    </h3>
                    
                    <!-- Connettività -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                                Connettività
                            </label>
                            <select id="connettivita" class="form-select">
                                <option value="none">Nessuna Connettività</option>
                                <option value="pocket-wifi-3-0" data-prezzo="17">Pocket WiFi 3.0 - Modulo WiFi base (€17/cad)</option>
                                <option value="pocket-wifi-plus-3-0" data-prezzo="24">Pocket WiFi Plus 3.0 - Modulo WiFi potenziato (€24/cad)</option>
                                <option value="pocket-wifi-plus-3-0-lm" data-prezzo="26">Pocket WiFi Plus 3.0 LM - Modulo WiFi Plus con monitoraggio (€26/cad)</option>
                                <option value="pocket-lan-3-0" data-prezzo="25">Pocket LAN 3.0 - Modulo LAN (€25/cad)</option>
                                <option value="pocket-wifi-lan" data-prezzo="45">Pocket WiFi+LAN - Modulo WiFi e LAN (€45/cad)</option>
                                <option value="pocket-4g-v3" data-prezzo="45">Pocket 4G V3 - Modulo 4G con SIM (€45/cad)</option>
                            </select>
                        </div>
                        <div class="form-group" id="numeroConnettivitaContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità Connettività
                            </label>
                            <input type="number" id="numeroConnettivita" class="form-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- Backup e Controllo -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                                </svg>
                                Backup e Controllo
                            </label>
                            <select id="backupControllo" class="form-select">
                                <option value="none">Nessun Backup/Controllo</option>

                                <optgroup label="EPS Box">
                                    <option value="x1-eps-box" data-prezzo="212">X1-EPS Box - Sistema backup monofase (€212/cad)</option>
                                    <option value="x3-eps-box" data-prezzo="278">X3-EPS Box - Sistema backup trifase (€278/cad)</option>
                                    <option value="x3-eps-box-p5-e" data-prezzo="1597">X3-EPS-BOX-P5-E - Sistema backup parallelo P5 (€1.597/cad)</option>
                                    <option value="x3-pbox-60kw-g2" data-prezzo="1103">X3-PBOX-60KW G2 - Parallel Box 60kW per backup multiplo (€1.103/cad)</option>
                                    <option value="x3-pbox-150kw-g2" data-prezzo="1812">X3-PBOX-150KW G2 - Parallel Box 150kW per backup multiplo (€1.812/cad)</option>
                                </optgroup>

                                <optgroup label="Matebox">
                                    <option value="x1-matebox-advanced" data-prezzo="583">X1 Matebox Advanced - Quadro comando monofase (€583/cad)</option>
                                    <option value="x3-matebox-advanced" data-prezzo="1083">X3 Matebox Advanced - Quadro comando trifase (€1.083/cad)</option>
                                </optgroup>

                                <optgroup label="Adapter Box">
                                    <option value="adapter-box" data-prezzo="38">Adapter Box - Adattatore per pompe di calore (€38/cad)</option>
                                    <option value="adapter-box-g2" data-prezzo="60">Adapter Box G2 - Adattatore G2 per pompe di calore (€60/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori Wireless">
                                    <option value="wi-br" data-prezzo="62">Wi-BR - Bridge wireless per comunicazione (€62/cad)</option>
                                </optgroup>

                                <optgroup label="Data Hub">
                                    <option value="datahub1000" data-prezzo="380">DataHub1000 - Hub dati per gestione multipla (€380/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group" id="numeroBackupControlloContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità backup e controllo
                            </label>
                            <input type="number" id="numeroBackupControllo" class="form-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- Meter e CT -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-2 0a6 6 0 11-12 0 6 6 0 0112 0zm-1.5 0a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" clip-rule="evenodd" />
                                </svg>
                                Meter e CT
                            </label>
                            <select id="meterCT" class="form-select">
                                <option value="none">Nessun Meter/CT</option>

                                <optgroup label="Meter">
                                    <option value="ddsu666-d" data-prezzo="62">DDSU666-D - Meter monofase (€62/cad)</option>
                                    <option value="dtsu666-d" data-prezzo="83">DTSU666-D - Meter trifase (€83/cad)</option>
                                    <option value="sdm630m-ct-v2" data-prezzo="144">SDM630M-CT V2 - Meter trifase con CT (€144/cad)</option>
                                    <option value="sdm230-modbus" data-prezzo="75">SDM230-Modbus - Meter monofase Modbus (€75/cad)</option>
                                </optgroup>

                                <optgroup label="Current Transformer">
                                    <option value="ct-200" data-prezzo="17">CT 200 - Current Transformer 200A (€17/cad)</option>
                                    <option value="ct-600" data-prezzo="35">CT 600 - Current Transformer 600A (€35/cad)</option>
                                    <option value="ct-1500" data-prezzo="71">CT 1500 - Current Transformer 1500A (€71/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori Wireless">
                                    <option value="wi-br" data-prezzo="62">Wi-BR - Bridge wireless per comunicazione (€62/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group" id="numeroMeterCTContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità Meter e CT
                            </label>
                            <input type="number" id="numeroMeterCT" class="form-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- Cavi e Accessori -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                                Cavi e Accessori
                            </label>
                            <select id="caviAccessori" class="form-select">
                                <option value="none">Nessun Cavo/Accessorio</option>

                                <optgroup label="Accessori Micro">
                                    <option value="ac-trunk-end-cap" data-prezzo="3">AC Trunk End Cap - Tappo terminale per trunk AC (€3/cad)</option>
                                    <option value="ac-trunk-connector" data-prezzo="5">AC Trunk Connector - Connettore per trunk AC (€5/cad)</option>
                                    <option value="ac-trunk-port-disconnect" data-prezzo="5">AC Trunk Port Disconnect - Disconnettore porta trunk AC (€5/cad)</option>
                                </optgroup>

                                <optgroup label="Cavi Micro">
                                    <option value="ac-trunk-cable-2-4m-10awg" data-prezzo="26">AC Trunk Cable 2.4m 10AWG - Cavo trunk AC 2.4m 10AWG (€26/cad)</option>
                                    <option value="ac-trunk-cable-2-4m-12awg" data-prezzo="33">AC Trunk Cable 2.4m 12AWG - Cavo trunk AC 2.4m 12AWG (€33/cad)</option>
                                    <option value="ac-end-cable-m" data-prezzo="3">AC End Cable-M - Cavo terminale AC maschio (€3/cad)</option>
                                    <option value="dc-extension-cable-1-0m" data-prezzo="7">DC Extension Cable 1.0m - Cavo prolunga DC 1.0m (€7/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori">
                                    <option value="power-cable-1-2m" data-prezzo="41">Power Cable 1.2m - Cavo alimentazione 1.2m (€41/cad)</option>
                                    <option value="power-cable-1-8m" data-prezzo="45">Power Cable 1.8m - Cavo alimentazione 1.8m (€45/cad)</option>
                                    <option value="comm-cable-1-2m" data-prezzo="10">Comm Cable 1.2m - Cavo comunicazione 1.2m (€10/cad)</option>
                                    <option value="comm-cable-1-8m" data-prezzo="12">Comm Cable 1.8m - Cavo comunicazione 1.8m (€12/cad)</option>
                                    <option value="series-box" data-prezzo="351">Series Box - Box per connessioni in serie (€351/cad)</option>
                                    <option value="heat-box-g2" data-prezzo="71">Heat Box G2 - Box controllo pompa calore (€71/cad)</option>
                                </optgroup>

                                <optgroup label="Accessori Vari">
                                    <option value="wall-configuration-package" data-prezzo="161">Wall Configuration Package - Kit configurazione a parete (€161/cad)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group" id="numeroCaviAccessoriContainer">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità cavi e accessori
                            </label>
                            <input type="number" id="numeroCaviAccessori" class="form-input" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Manodopera e Sicurezza -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                            <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                            <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z" />
                        </svg>
                        Manodopera e Sicurezza
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Costo Manodopera (per kW)</label>
                            <input type="number" id="costoManodopera" class="form-input" value="180" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Fresia</label>
                            <input type="number" id="costoFresia" class="form-input" value="800" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Sicurezza (0 se escluso)</label>
                            <input type="number" id="costoSicurezza" class="form-input" value="2500" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Margine di Guadagno (%)</label>
                            <input type="number" id="margineGuadagno" class="form-input" value="30" min="0" required>
                        </div>
                    </div>
                </div>

                <!-- Costi Unitari -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        Costi Unitari (€)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label class="form-label">Costo Morsetti Centrali</label>
                            <input type="number" id="costoMorsettiCentrali" class="form-input" value="1.3" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Morsetti Finali</label>
                            <input type="number" id="costoMorsettiFinali" class="form-input" value="1.5" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Guide Lamiera (m)</label>
                            <input type="number" id="costoGuideLamiera" class="form-input" value="17.2" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Guide Tegole (m)</label>
                            <input type="number" id="costoGuideTegole" class="form-input" value="17" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Prolunga Guide Tegole</label>
                            <input type="number" id="costoProlungaGuide" class="form-input" value="3" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Staffe Tegole</label>
                            <input type="number" id="costoStaffeTegole" class="form-input" value="8.4" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Cavi CA (per m)</label>
                            <input type="number" id="costoCaviCA" class="form-input" value="5" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lunghezza Cavi CA (m)</label>
                            <input type="number" id="lunghezzaCaviCA" class="form-input" value="10" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Cavi DC (per m)</label>
                            <input type="number" id="costoCavi" class="form-input" value="3" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Quadri Elettrici</label>
                            <input type="number" id="costoQuadri" class="form-input" value="500" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Costo Mezzi al Giorno</label>
                            <input type="number" id="costoMezzi" class="form-input" value="0" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Giorni Utilizzo Mezzi</label>
                            <input type="number" id="giorniMezzi" class="form-input" value="1" step="0.1" min="0" required>
                        </div>
                    </div>
                    <div id="dettagliCosti"></div>
            </div>
        </form>

        <!-- Dati Energetici Cliente -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd" />
                </svg>
                Dati Energetici Cliente (Bolletta)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Consumo Annuo (kWh)</label>
                    <input type="number" id="consumoAnnuo" class="form-input" value="0" min="0">
                    <p class="text-xs text-gray-500 mt-1">Se compilato, genera l'analisi economica</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Costo Energia Attuale (€/kWh)</label>
                    <input type="number" id="costoEnergiaAttuale" class="form-input" value="0.16" min="0.1" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Spesa Annua Energia (€)</label>
                    <input type="number" id="spesaAnnuaEnergia" class="form-input" value="0" min="0">
                    <p class="text-xs text-gray-500 mt-1">Se compilato, sostituisce il calcolo automatico</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Autoconsumo Stimato (%)</label>
                    <input type="number" id="autoconsumoStimato" class="form-input" value="0" min="0" max="100">
                </div>
            </div>
        </div>

        <!-- Parametri Economici -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                Parametri Economici
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Produzione Annua Stimata (kWh da PVGIS)</label>
                    <input type="number" id="produzioneAnnuaKw" class="form-input" value="1200" min="800" max="1600">
                    <p class="text-xs text-gray-500 mt-1">Se caricato il PVGIS viene compilato in automatico</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Percentuale IVA (%)</label>
                    <input type="number" id="percentualeIva" class="form-input" value="10" min="0" max="22">
                </div>
                <div class="form-group">
                    <label class="form-label">Percentuale Detrazione Fiscale (%)</label>
                    <input type="number" id="percentualeDetrazione" class="form-input" value="50" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Anni Detrazione</label>
                    <input type="number" id="anniDetrazione" class="form-input" value="10" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Risparmio Bolletta Stimato (%)</label>
                    <input type="number" id="risparmioStimato" class="form-input" value="80" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo di Cessione Energia</label>
                    <select id="tipoCessione" class="form-select">
                        <option value="ritiro">Ritiro Dedicato</option>
                        <option value="cessioneTotale">Cessione Totale</option>
                        <option value="cessioneParziale">Cessione Parziale</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Dati Preventivo -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>
                Dati Preventivo
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Validità Preventivo<br>(giorni)</label>
                    <input type="number" id="validitaPreventivo" class="form-input" value="20" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Riferimento Preventivo<br>(lasciare vuoto per autogenerato)</label>
                    <input id="riferimentoPreventivo" class="form-input" placeholder="PRV-YYYYMMDD-HHMM">
                </div>
            </div>
            
            <!-- Percentuali di Pagamento -->
            <div class="mt-6">
                <h3 class="text-lg font-medium mb-3 text-gray-700">Percentuali di Pagamento</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Prima Tranche<br>(Ordine Materiali %)</label>
                        <input type="number" id="percentualePrimaPagamento" class="form-input" value="50" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seconda Tranche<br>(Fine Lavori %)</label>
                        <input type="number" id="percentualeSecondaPagamento" class="form-input" value="40" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Terza Tranche<br>(Collaudo %)</label>
                        <input type="number" id="percentualeTerzaPagamento" class="form-input" value="10" min="0" max="100">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">La somma delle percentuali deve essere 100%</p>
                <div id="errorePercentuali" class="hidden mt-2 text-red-600 text-sm"></div>
            </div>
        </div>

        <!-- Premessa Personalizzata -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
                Premessa Personalizzata
            </h2>
            <div class="form-group">
                <label class="form-label">Testo introduttivo (apparirà all'inizio del preventivo, lasciare vuoto per autogenerazione)</label>
                <textarea id="premessaPersonalizzata" class="form-input" rows="6" style="width: 100%;" placeholder="Offerta economica per installazione di un impianto fotovoltaico con accumulo.

Vi trasmettiamo la nostra migliore offerta per l'esecuzione dei lavori da effettuare sull'edificio.

A seguito di sopralluogo tecnico, abbiamo valutato la migliore soluzione per le vostre esigenze..."></textarea>
            </div>
            <p class="text-xs text-gray-500 mt-1">Allarga il box del testo dall'angolo in basso a destra</p>
        </div>

        <!-- Note Personalizzate -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                </svg>
                Note Personalizzate
            </h2>
            <div class="form-group">
                <label class="form-label">Note Aggiuntive (appariranno nel preventivo sotto alle note standard)</label>
                <textarea id="notePersonalizzate" class="form-input" rows="4" style="width: 100%;" placeholder="Inserisci qui eventuali note aggiuntive per il preventivo..."></textarea>
            </div>
            <p class="text-xs text-gray-500 mt-1">Allarga il box del testo dall'angolo in basso a destra</p>
        </div>

        <!-- Dati PVGIS -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z" />
                </svg>
                Dati PVGIS
            </h2>
            
            <div class="highlight-box mb-5 p-4 bg-blue-50 border-l-4 border-blue-500">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#3B82F6">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Come utilizzare PVGIS
                </h3>
                <ol class="list-decimal pl-5 space-y-2 text-sm">
                    <li>Vai su <a href="https://re.jrc.ec.europa.eu/pvg_tools/en/" target="_blank" class="text-blue-600 hover:underline font-medium">PVGIS (Photovoltaic Geographical Information System)</a></li>
                    <li>Inserisci le coordinate del tuo impianto o cerca l'indirizzo nella mappa</li>
                    <li>Nella sezione "PERFORMANCE OF GRID-CONNECTED PV", specifica:
                        <ul class="list-disc pl-5 mt-1">
                            <li>Potenza installata (in kWp)</li>
                            <li>Inclinazione (in gradi)</li>
                            <li>Orientamento (azimut, 0° = Sud, -90° = Est, 90° = Ovest)</li>
                        </ul>
                    </li>
                    <li>Clicca su "Visualize results" e poi sul tasto "json" come formato del file e scarica</li>
                    <li>Carica il file JSON scaricato qui sotto per ottenere calcoli di produzione precisi</li>
                </ol>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label class="form-label flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#4A5568">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Carica file JSON PVGIS
                    </label>
                    <input type="file" id="pvgisFileInput" class="form-input border-2 border-dashed border-gray-300 rounded-lg p-4 w-full cursor-pointer hover:border-blue-500 transition duration-300" accept=".json">
                    <p class="text-xs text-gray-500 mt-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Carica un file JSON esportato da PVGIS per calcoli precisi sulla produzione fotovoltaica
                    </p>
                </div>
                
                <div class="form-group">
                    <div id="pvgisInfo" class="p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border border-blue-100 shadow-sm hidden">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#3B82F6">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Dati PVGIS rilevati
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center border-b border-blue-100 pb-2">
                                <span class="font-medium text-gray-700">Stato:</span>
                                <span id="pvgisStatus" class="font-semibold text-green-600 bg-green-100 px-2 py-1 rounded-full text-sm">Nessun file caricato</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-700">Produzione annuale:</span>
                                <span id="pvgisAnnualProduction" class="font-semibold text-blue-800">-</span>
                                <span class="text-gray-600 ml-1">kWh</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-700">Irradiazione annuale:</span>
                                <span id="pvgisAnnualIrradiation" class="font-semibold text-blue-800">-</span>
                                <span class="text-gray-600 ml-1">kWh/m²</span>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-gray-500 italic">
                            I dati PVGIS migliorano l'accuratezza delle stime di produzione energetica e rendimento economico
                        </div>
                    </div>
                    <div id="pvgisPlaceholder" class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            <p class="font-medium">Nessun file PVGIS caricato</p>
                            <p class="text-xs mt-1">I dati caricati verranno visualizzati qui</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pvgisMapContainer" class="hidden" style="margin-top: 20px;">
                <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#3B82F6">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    Posizione dell'impianto
                </h3>
                <div id="pvgisMap" style="height: 300px; border-radius: 8px;"></div>
            </div>
        </div>

        <!-- Aggiungi immagini render -->
        <div class="form-section">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                </svg>
                Immagini Render Impianto
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                <div class="form-group">
                    <label class="form-label">Immagine Render 1</label>
                    <input type="file" id="renderImage1" class="form-input" accept="image/*">
                    <div id="preview1" class="mt-2 hidden">
                        <img src="" alt="Anteprima immagine 1" class="max-h-32 border rounded">
                        <button type="button" class="mt-1 text-red-500 text-sm remove-image" data-id="1">Rimuovi</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Immagine Render 2</label>
                    <input type="file" id="renderImage2" class="form-input" accept="image/*">
                    <div id="preview2" class="mt-2 hidden">
                        <img src="" alt="Anteprima immagine 2" class="max-h-32 border rounded">
                        <button type="button" class="mt-1 text-red-500 text-sm remove-image" data-id="2">Rimuovi</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Immagine Render 3</label>
                    <input type="file" id="renderImage3" class="form-input" accept="image/*">
                    <div id="preview3" class="mt-2 hidden">
                        <img src="" alt="Anteprima immagine 3" class="max-h-32 border rounded">
                        <button type="button" class="mt-1 text-red-500 text-sm remove-image" data-id="3">Rimuovi</button>
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Carica fino a 3 immagini dei render dell'impianto che verranno visualizzate nel preventivo.</p>
        </div>

        <!-- Risultati -->
        <div id="risultati" class="mt-8 form-section"></div>
            <div class="mt-6 text-center">
                <button id="generaPreventivo" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition duration-300 flex items-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Genera Preventivo
                </button>
            </div>
            </div>
        </div>

    <script>
        // Definizione della versione corrente dell'applicazione
        const CURRENT_APP_VERSION = "3.42";  // La versione attuale di PRISMA
        const FORMATO_FILE = "2.0";  // La versione attuale del file .prisma

        let isPvgisDataAvailable = false;
        let faldeCounter = 0;
        let numeroPreventivo = '';

        // Variabile globale per la mappa e il marker
        let pvgisMap = null;
        let pvgisMarker = null;

        // Variabili globali per il preventivo
        let valoriDefault = {
            costoModuli: 0,
            costoMorsetti: 0,
            costoGuide: 0,
            costoStaffe: 0,
            costoProlunghe: 0,
            costoInverter: 0,
            costoParallelBox: 0,
            costoBatterie: 0,
            costoEssCabinet: 0,
            costoEVCharger: 0,
            costoConnettivita: 0,
            costoBackupControllo: 0,
            costoMeterCT: 0,
            costoCaviAccessori: 0,
            costoQuadri: 0,
            costoCavi: 0,
            costoCaviCA: 0,
            costoFresia: 0,
            costoMezzi: 0,
            costoSicurezza: 0, 
            costoManodoperaTotale: 0
        };

        // Funzione per mostrare le informazioni di versione
        function showVersionInfo() {
            // Rimuovi il dialog esistente se presente
            const existingDialog = document.getElementById('version-info-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            // Crea un overlay per il dialog
            const overlay = document.createElement('div');
            overlay.id = 'version-info-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';
            
            // Crea il dialog
            const dialog = document.createElement('div');
            dialog.id = 'version-info-dialog';
            dialog.style.width = '400px';
            dialog.style.maxWidth = '90%';
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            dialog.style.padding = '20px';
            
            // DETTAGLI CHANGELOG NUOVA VERSIONE FILE E PRISMA
            dialog.innerHTML = `
                <h2 style="margin-top: 0; font-size: 1.5rem; color: #0F3460; margin-bottom: 1rem; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Informazioni Versione
                </h2>
                <div style="max-height: 60vh; overflow-y: auto; margin-bottom: 20px; padding-right: 5px;">
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 8px;"><strong>PRISMA Versione:</strong> ${CURRENT_APP_VERSION}</p>
                        <p style="margin-bottom: 8px;"><strong>Formato File:</strong> ${FORMATO_FILE}</p>
                        <p style="margin-bottom: 0;"><strong>Data rilascio:</strong> 8 ottobre 2025</p>
                    </div>
                    <div style="background-color: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; font-size: 1rem; margin-bottom: 8px; color: #0F3460;">Note di rilascio</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>aggiornato il listino prezzi</li>
                            
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; position: sticky; bottom: 0; background-color: white; padding-top: 10px; border-top: 1px solid #eaeaea;">
                    <button id="close-version-info" style="padding: 8px 16px; background-color: #0F3460; color: white; border: none; border-radius: 4px; cursor: pointer;">Chiudi</button>
                </div>
            `;
            
            // Aggiungi il dialog all'overlay e l'overlay al body
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Aggiungi event listener per chiudere
            document.getElementById('close-version-info').addEventListener('click', function() {
                overlay.remove();
            });
        }

        function createFaldaTemplate(id) {
            return `
                <div class="falda-group mb-4 p-4 border rounded-lg bg-gray-50" data-falda-id="${id}">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4 w-full">
                            <input type="text" 
                                class="falda-nome form-input w-full max-w-xs" 
                                placeholder="Nome Falda" 
                                value="Falda ${id + 1}">
                            <button type="button" class="rimuovi-falda text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label class="form-label">Larghezza (m)</label>
                            <input type="number" class="form-input falda-larghezza" name="larghezza_${id}" value="4" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Lunghezza (m)</label>
                            <input type="number" class="form-input falda-lunghezza" name="lunghezza_${id}" value="10" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Inclinazione (gradi)</label>
                            <input type="number" class="form-input falda-inclinazione" name="inclinazione_${id}" value="30" min="0" max="90" required>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="text-lg font-medium mb-3 text-gray-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#2E8B57">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM14 11a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" />
                            </svg>
                            Gruppi di Moduli
                        </h4>
                        <div class="gruppi-moduli-container" data-falda-id="${id}">
                            <!-- I gruppi di moduli verranno inseriti qui dinamicamente -->
                        </div>
                        <button type="button" class="aggiungi-gruppo-moduli mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Aggiungi Gruppo Moduli
                        </button>
                        <div class="form-group mt-4">
                            <label class="form-label">Potenza Totale Falda</label>
                            <p class="potenza-falda-totale text-lg font-semibold p-2 bg-gray-100 rounded">0 kW</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createGruppoModuliTemplate(faldaId, gruppoId) {
            return `
                <div class="gruppo-moduli-item mb-4 p-4 border rounded-lg bg-gray-100" data-falda-id="${faldaId}" data-gruppo-id="${gruppoId}">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4 w-full">
                            <input type="text" 
                                class="gruppo-nome form-input w-full max-w-xs" 
                                placeholder="Nome Gruppo" 
                                value="Gruppo ${gruppoId + 1}">
                            <button type="button" class="rimuovi-gruppo-moduli text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Orientamento Moduli</label>
                            <select class="form-select gruppo-orientamento" name="orientamento_${faldaId}_${gruppoId}">
                                <option value="verticale">Verticale</option>
                                <option value="orizzontale">Orizzontale</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Influisce sulle guide</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modulo Fotovoltaico</label>
                            <div class="relative">
                                <select class="form-select gruppo-modulo" name="modulo_${faldaId}_${gruppoId}">
                                    <option value="longi440" 
                                            data-potenza="440" 
                                            data-prezzo="71.5"
                                            data-larghezza="1.134"
                                            data-altezza="1.724">
                                        Longi 440W HTH Mono (€71,50)
                                    </option>
                                    <option value="lr5-580" 
                                            data-potenza="580" 
                                            data-prezzo="98"
                                            data-larghezza="1.134"
                                            data-altezza="2.278">
                                        Longi LR5-72HGD 580W (€98,00)
                                    </option>
                                    <option value="lr7-540" 
                                            data-potenza="480" 
                                            data-prezzo="65"
                                            data-larghezza="1.134"
                                            data-altezza="1.800">
                                        Longi LR7-54HVH 480W (€65,00)
                                    </option>
                                    <option value="lr7-540" 
                                            data-potenza="480" 
                                            data-prezzo="71"
                                            data-larghezza="1.134"
                                            data-altezza="1.800">
                                        Longi LR7-54HVH 480W (€71,00)
                                    </option>
                                </select>
                                <p class="dimensioni-modulo-${faldaId}-${gruppoId} text-xs text-gray-600 mt-1"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numero File</label>
                            <input type="number" class="form-input gruppo-numero-file" name="numeroFile_${faldaId}_${gruppoId}" value="2" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Moduli per Fila</label>
                            <input type="number" class="form-input gruppo-moduli-fila" name="moduliPerFila_${faldaId}_${gruppoId}" value="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Info Guide</label>
                            <div class="info-text">
                                <p>Distanza tra moduli: 3cm (morsetti centrali)</p>
                                <p>Guide: 2 guide da 3.1m per fila</p>
                                <p class="guide-totali-gruppo">Guide totali: --</p>
                                <p class="staffe-totali-gruppo text-sm text-gray-600"></p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Potenza Gruppo</label>
                            <p class="potenza-gruppo text-lg font-semibold p-2 bg-gray-100 rounded">0 kW</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Variabile per tenere traccia dei contatori di gruppi per ogni falda
        let gruppiCounters = {};

        // Funzione per aggiungere un gruppo di moduli a una falda
        function aggiungiGruppoModuli(faldaId) {
            // Inizializza il contatore se non esiste
            if (!gruppiCounters[faldaId]) {
                gruppiCounters[faldaId] = 0;
            }
            
            const gruppoId = gruppiCounters[faldaId];
            const container = document.querySelector(`.gruppi-moduli-container[data-falda-id="${faldaId}"]`);
            
            if (container) {
                container.insertAdjacentHTML('beforeend', createGruppoModuliTemplate(faldaId, gruppoId));
                
                const newGruppo = container.lastElementChild;
                setupGruppoModuliEventListeners(newGruppo, faldaId, gruppoId);
                
                gruppiCounters[faldaId]++;
                calcolaPreventivoInRealTime();
            }
        }

        // Funzione per configurare gli event listeners per un gruppo di moduli
        function setupGruppoModuliEventListeners(gruppoElement, faldaId, gruppoId) {
            gruppoElement.querySelector('.rimuovi-gruppo-moduli').addEventListener('click', function() {
                gruppoElement.remove();
                rinumeraGruppi(faldaId);
                calcolaPreventivoInRealTime();
            });
            
            gruppoElement.querySelector('.gruppo-orientamento').addEventListener('change', calcolaPreventivoInRealTime);
            gruppoElement.querySelector('.gruppo-numero-file').addEventListener('input', calcolaPreventivoInRealTime);
            gruppoElement.querySelector('.gruppo-moduli-fila').addEventListener('input', calcolaPreventivoInRealTime);
            gruppoElement.querySelector('.gruppo-modulo').addEventListener('change', function() {
                aggiornaDimensioniModuloGruppo(faldaId, gruppoId);
                calcolaPreventivoInRealTime();
            });
            
            aggiornaDimensioniModuloGruppo(faldaId, gruppoId);
        }

        // Funzione per aggiornare le dimensioni del modulo visualizzate
        function aggiornaDimensioniModuloGruppo(faldaId, gruppoId) {
            const moduloSelect = document.querySelector(`.gruppo-moduli-item[data-falda-id="${faldaId}"][data-gruppo-id="${gruppoId}"] .gruppo-modulo`);
            const dimensioniElement = document.querySelector(`.dimensioni-modulo-${faldaId}-${gruppoId}`);
            
            if (moduloSelect && dimensioniElement) {
                const larghezza = moduloSelect.options[moduloSelect.selectedIndex].dataset.larghezza;
                const altezza = moduloSelect.options[moduloSelect.selectedIndex].dataset.altezza;
                dimensioniElement.textContent = `Dimensioni: ${larghezza * 1000} x ${altezza * 1000} mm`;
            }
        }

        function setupFaldaEventListeners(newFalda) {
            // Aggiungi controllo di esistenza
            if (newFalda.querySelector('.rimuovi-falda')) {
                newFalda.querySelector('.rimuovi-falda').addEventListener('click', function() {
                    newFalda.remove();
                    calcolaPreventivoInRealTime();
                });
            }
            
            // Controlla l'esistenza prima di aggiungere gli event listener
            if (newFalda.querySelector('.falda-larghezza')) {
                newFalda.querySelector('.falda-larghezza').addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            if (newFalda.querySelector('.falda-inclinazione')) {
                newFalda.querySelector('.falda-inclinazione').addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            if (newFalda.querySelector('.falda-lunghezza')) {
                newFalda.querySelector('.falda-lunghezza').addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            // Questi elementi sembrano essere quelli che causano il problema - controlla la loro esistenza
            const orientamento = newFalda.querySelector('.falda-orientamento');
            if (orientamento) {
                orientamento.addEventListener('change', calcolaPreventivoInRealTime);
            }
            
            const numeroFile = newFalda.querySelector('.falda-numero-file');
            if (numeroFile) {
                numeroFile.addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            const moduliFila = newFalda.querySelector('.falda-moduli-fila');
            if (moduliFila) {
                moduliFila.addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            const modulo = newFalda.querySelector('.falda-modulo');
            if (modulo) {
                modulo.addEventListener('change', calcolaPreventivoInRealTime);
            }

            // Aggiungi event listener per il pulsante "Aggiungi Gruppo Moduli"
            if (newFalda.querySelector('.aggiungi-gruppo-moduli')) {
                newFalda.querySelector('.aggiungi-gruppo-moduli').addEventListener('click', function() {
                    const faldaId = newFalda.getAttribute('data-falda-id');
                    aggiungiGruppoModuli(faldaId);
                });
            }
        }

        // Aggiungi una falda di default al caricamento
        function initializeFalde() {
            const container = document.getElementById('faldeContainer');
            if (container) {
                container.innerHTML = '';
                faldeCounter = 0; // Reset counter
                gruppiCounters = {}; // Reset gruppi counters
                
                const newFaldaHTML = createFaldaTemplate(faldeCounter);
                container.insertAdjacentHTML('beforeend', newFaldaHTML);
                
                const newFalda = container.lastElementChild;
                setupFaldaEventListeners(newFalda);
                
                // Inizializza il contenitore dei gruppi con un gruppo predefinito
                const faldaId = newFalda.getAttribute('data-falda-id');
                
                // Inizializza il contatore per questa falda se non esiste
                if (!gruppiCounters[faldaId]) {
                    gruppiCounters[faldaId] = 0;
                }
                
                // Aggiungi un gruppo di moduli predefinito alla falda
                aggiungiGruppoModuli(faldaId);
                
                faldeCounter++; // Increment counter after adding falda
                
                calcolaPreventivoInRealTime();
            }
        }

        function getFaldeData() {
            const falde = [];
            const faldaGroups = document.querySelectorAll('.falda-group');
            
            if (faldaGroups.length === 0) {
                // Forza la creazione di almeno una falda se non esistono
                initializeFalde();
            }
            
            // Dopo aver assicurato l'esistenza di almeno una falda, raccogliere i dati
            document.querySelectorAll('.falda-group').forEach(group => {
                const larghezza = parseFloat(group.querySelector('.falda-larghezza').value);
                const lunghezza = parseFloat(group.querySelector('.falda-lunghezza').value);
                const inclinazione = parseFloat(group.querySelector('.falda-inclinazione').value);
                falde.push({ larghezza, lunghezza, inclinazione });
            });
            
            return falde;
        }

        document.getElementById('aggiungiFalda').addEventListener('click', function() {
            const container = document.getElementById('faldeContainer');
            // Calcola il numero corretto della nuova falda basato sul numero di falde esistenti
            const numeroFalda = container.children.length + 1;
            
            // Usa il nuovo numero nella creazione del template
            const newFaldaHTML = createFaldaTemplate(numeroFalda - 1); // -1 perché l'ID parte da 0
            container.insertAdjacentHTML('beforeend', newFaldaHTML);
            
            const newFalda = container.lastElementChild;
            
            // Imposta il nome corretto nel campo input
            const nomeInput = newFalda.querySelector('.falda-nome');
            nomeInput.value = `Falda ${numeroFalda}`;
            
            // Setup event listeners
            newFalda.querySelector('.rimuovi-falda').addEventListener('click', function() {
                newFalda.remove();
                // Rinumera tutte le falde dopo la rimozione
                rinumeraFalde();
                calcolaPreventivoInRealTime();
            });
            
            newFalda.querySelector('.falda-larghezza').addEventListener('input', calcolaPreventivoInRealTime);
            newFalda.querySelector('.falda-inclinazione').addEventListener('input', calcolaPreventivoInRealTime);
            newFalda.querySelector('.falda-lunghezza').addEventListener('input', calcolaPreventivoInRealTime);
            
            // Verifica l'esistenza degli elementi prima di aggiungere event listener
            const orientamentoElement = newFalda.querySelector('.falda-orientamento');
            if (orientamentoElement) {
                orientamentoElement.addEventListener('change', calcolaPreventivoInRealTime);
            }
            
            const numeroFileElement = newFalda.querySelector('.falda-numero-file');
            if (numeroFileElement) {
                numeroFileElement.addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            const moduliFilaElement = newFalda.querySelector('.falda-moduli-fila');
            if (moduliFilaElement) {
                moduliFilaElement.addEventListener('input', calcolaPreventivoInRealTime);
            }
            
            const moduloElement = newFalda.querySelector('.falda-modulo');
            if (moduloElement) {
                moduloElement.addEventListener('change', calcolaPreventivoInRealTime);
            }
            
            // Aggiungi event listener per il pulsante "Aggiungi Gruppo Moduli"
            const aggiungGruppoButton = newFalda.querySelector('.aggiungi-gruppo-moduli');
            if (aggiungGruppoButton) {
                aggiungGruppoButton.addEventListener('click', function() {
                    const faldaId = newFalda.getAttribute('data-falda-id');
                    aggiungiGruppoModuli(faldaId);
                });
            }
            
            // Aggiungi automaticamente il primo gruppo di moduli se necessario
            const faldaId = newFalda.getAttribute('data-falda-id');
            if (faldaId) {
                // Verifica se il gruppo è già stato aggiunto dalla funzione setupFaldaEventListeners
                const gruppiContainer = newFalda.querySelector('.gruppi-moduli-container');
                if (gruppiContainer && gruppiContainer.children.length === 0) {
                    aggiungiGruppoModuli(faldaId);
                }
            }
            
            calcolaPreventivoInRealTime();
        });

        // Nuova funzione per rinumerare le falde
        function rinumeraFalde() {
            const falde = document.querySelectorAll('.falda-group');
            falde.forEach((falda, index) => {
                const nomeInput = falda.querySelector('.falda-nome');
                nomeInput.value = `Falda ${index + 1}`;
            });
        }

        // Nuova funzione per rinumerare i gruppi di moduli in una falda
        function rinumeraGruppi(faldaId) {
            const gruppi = document.querySelectorAll(`.gruppo-moduli-item[data-falda-id="${faldaId}"]`);
            gruppi.forEach((gruppo, index) => {
                const nomeInput = gruppo.querySelector('.gruppo-nome');
                // Aggiorna solo se il nome sembra essere il default (contiene la parola "Gruppo" seguito da un numero)
                if (nomeInput.value.match(/Gruppo \d+/)) {
                    nomeInput.value = `Gruppo ${index + 1}`;
                }
            });
        }

        function toggleParallelBoxVisibility() {
            const batterie = document.querySelectorAll('.batteria-group');
            const parallelBoxContainer = document.getElementById('parallelBoxContainer');
            
            // Mostra il parallel box container se c'è almeno una batteria
            const hasBatterie = batterie.length > 0;
            parallelBoxContainer.style.display = hasBatterie ? 'block' : 'none';
            
            // Update Parallel Box number visibility
            toggleParallelBoxNumber();
        }

        // Aggiungi questo nei tuoi event listener esistenti
        document.getElementById('aggiungiBatteria').addEventListener('click', toggleParallelBoxVisibility);
        document.querySelectorAll('.rimuovi-batteria').forEach(button => {
            button.addEventListener('click', toggleParallelBoxVisibility);
        });

        // Calcolo potenza totale
        function calcolaPotenzaTotale() {
            let potenzaTotaleKw = 0;
            
            document.querySelectorAll('.falda-group').forEach(falda => {
                let potenzaFaldaKw = 0;
                const faldaId = falda.getAttribute('data-falda-id');
                
                // Itera su tutti i gruppi di moduli della falda
                falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                    const moduloSelect = gruppo.querySelector('.gruppo-modulo');
                    const potenzaModulo = parseFloat(moduloSelect.options[moduloSelect.selectedIndex].dataset.potenza) || 0;
                    const numeroFile = parseFloat(gruppo.querySelector('.gruppo-numero-file').value) || 0;
                    const moduliPerFila = parseFloat(gruppo.querySelector('.gruppo-moduli-fila').value) || 0;
                    
                    const totaleModuli = numeroFile * moduliPerFila;
                    const potenzaGruppoWatt = totaleModuli * potenzaModulo;
                    const potenzaGruppoKw = potenzaGruppoWatt / 1000;
                    
                    // Aggiorna il display della potenza del gruppo
                    const potenzaGruppoElement = gruppo.querySelector('.potenza-gruppo');
                    if (potenzaGruppoElement) {
                        potenzaGruppoElement.textContent = `${totaleModuli} moduli = ${potenzaGruppoKw.toFixed(2)} kW`;
                    }
                    
                    potenzaFaldaKw += potenzaGruppoKw;
                });
                
                // Aggiorna il display della potenza totale della falda
                const potenzaFaldaTotaleElement = falda.querySelector('.potenza-falda-totale');
                if (potenzaFaldaTotaleElement) {
                    potenzaFaldaTotaleElement.textContent = `${potenzaFaldaKw.toFixed(2)} kW`;
                }
                
                potenzaTotaleKw += potenzaFaldaKw;
            });
            
            return potenzaTotaleKw;
        }

        // Aggiorna il numero di guide totali
        function aggiornaGuideTotali() {
            let guideTotali = 0;
            let staffeTotali = 0;
            let prolungheTotali = 0;
            const tipoTetto = document.getElementById('tipoTetto').value;
            const lunghezzaGuida = 3.1;

            const faldaGroups = document.querySelectorAll('.falda-group');
            if (faldaGroups.length === 0) {
                return { 
                    guideTotali: 0, 
                    staffeTotali: 0, 
                    prolungheTotali: 0, 
                    lunghezzaGuida: lunghezzaGuida 
                };
            }

            document.querySelectorAll('.falda-group').forEach(falda => {
                // Verifica che la falda esista prima di procedere
                if (falda) {
                    // Itera su tutti i gruppi di moduli della falda
                    falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                        // Verifica che il gruppo esista
                        if (!gruppo) return;
                        
                        const numeroFileElement = gruppo.querySelector('.gruppo-numero-file');
                        const moduliPerFilaElement = gruppo.querySelector('.gruppo-moduli-fila');
                        
                        // Verifica che gli elementi necessari esistano
                        if (!numeroFileElement || !moduliPerFilaElement) return;
                        
                        const numeroFile = parseFloat(numeroFileElement.value) || 0;
                        const moduliPerFila = parseFloat(moduliPerFilaElement.value) || 0;
                        
                        if (numeroFile && moduliPerFila) {
                            const moduloSelect = gruppo.querySelector('.gruppo-modulo');
                            const orientamentoElement = gruppo.querySelector('.gruppo-orientamento');
                            
                            // Verifica che moduloSelect e orientamentoElement esistano
                            if (!moduloSelect || !orientamentoElement) return;
                            
                            const orientamento = orientamentoElement.value;
                            
                            // Verifica che moduloSelect.options e selectedIndex esistano
                            if (!moduloSelect.options || moduloSelect.selectedIndex < 0) return;
                            
                            const selectedOption = moduloSelect.options[moduloSelect.selectedIndex];
                            
                            // Verifica che l'opzione selezionata e i dataset esistano
                            if (!selectedOption || !selectedOption.dataset) return;
                            
                            // Get dimensions from module data
                            const larghezzaModulo = parseFloat(selectedOption.dataset.larghezza) || 0;
                            const altezzaModulo = parseFloat(selectedOption.dataset.altezza) || 0;
                            
                            // Use the correct dimension based on orientation
                            const larghezzaEffettiva = orientamento === 'verticale' ? larghezzaModulo : altezzaModulo;
                            
                            const lunghezzaTotaleFila = 0.03 + (moduliPerFila * larghezzaEffettiva) + 
                                ((moduliPerFila - 1) * 0.03) + 0.03;
                            
                            const guidePerCoprituraLunghezza = Math.ceil(lunghezzaTotaleFila / lunghezzaGuida);
                            const guideFalda = guidePerCoprituraLunghezza * 2 * numeroFile;
                            
                            guideTotali += guideFalda;
                            
                            if (tipoTetto === 'tegole') {
                                staffeTotali += Math.ceil((guideFalda * lunghezzaGuida) / 2);
                                prolungheTotali += (guidePerCoprituraLunghezza - 1) * 2 * numeroFile;
                            }
                            
                            // Aggiorna info guide per questo gruppo
                            const guideElement = gruppo.querySelector('.guide-totali-gruppo');
                            if (guideElement) {
                                guideElement.textContent = `Guide totali: ${guideFalda}`;
                            }
                            
                            const staffeElement = gruppo.querySelector('.staffe-totali-gruppo');
                            if (staffeElement) {
                                if (tipoTetto === 'tegole') {
                                    const staffeGruppo = Math.ceil((guideFalda * lunghezzaGuida) / 2);
                                    const prolungheGruppo = (guidePerCoprituraLunghezza - 1) * 2 * numeroFile;
                                    staffeElement.innerHTML = `Staffe totali: ${staffeGruppo}<br>Prolunghe totali: ${prolungheGruppo}`;
                                    staffeElement.style.display = 'block';
                                } else {
                                    staffeElement.textContent = '';
                                    staffeElement.style.display = 'none';
                                }
                            }
                        }
                    });
                }
            });
            
            return { 
                guideTotali, 
                staffeTotali, 
                prolungheTotali, 
                lunghezzaGuida
            };
        }

        function toggleStaffeInput() {
            const tipoTetto = document.getElementById('tipoTetto').value;
            // Seleziona tutti i campi relativi alle tegole
            const staffeContainer = document.querySelector('.form-group:has([id="costoStaffeTegole"])');
            const guideTegoleContainer = document.querySelector('.form-group:has([id="costoGuideTegole"])');
            const prolungaGuideContainer = document.querySelector('.form-group:has([id="costoProlungaGuide"])');
            
            // Imposta la visibilità in base al tipo di tetto
            const display = tipoTetto === 'tegole' ? 'block' : 'none';
            staffeContainer.style.display = display;
            guideTegoleContainer.style.display = display;
            prolungaGuideContainer.style.display = display;
        }

        // Aggiungi questo event listener
        document.getElementById('tipoTetto').addEventListener('change', function() {
            toggleStaffeInput();
            calcolaPreventivoInRealTime();
        });

        function aggiornaDimensioniModulo() {
            document.querySelectorAll('.falda-group').forEach(falda => {
                const moduloSelect = falda.querySelector('.falda-modulo');
                const dimensioniElement = falda.querySelector('[class^="dimensioni-modulo-"]');
                if (moduloSelect && dimensioniElement) {
                    const larghezza = moduloSelect.options[moduloSelect.selectedIndex].dataset.larghezza;
                    const altezza = moduloSelect.options[moduloSelect.selectedIndex].dataset.altezza;
                    dimensioniElement.textContent = `Dimensioni: ${larghezza * 1000} x ${altezza * 1000} mm`;
                }
            });
        }

        // Add event listener for module change
        document.querySelectorAll('.falda-modulo').forEach(modulo => {
            modulo.addEventListener('change', aggiornaDimensioniModulo);
        });

        let inverterCounter = 0;

        function createInverterTemplate(id) {
            return `
                <div class="inverter-group mb-4 p-4 border rounded-lg bg-gray-50" data-inverter-id="${id}">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium">Inverter ${id + 1}</h4>
                        <button type="button" class="rimuovi-inverter text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Modello Inverter</label>
                            <select class="form-select inverter-select" name="inverter_${id}">
                                <option value="none">Seleziona Inverter</option>
                                ${document.getElementById('inverter').innerHTML}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numero Stringhe</label>
                            <input type="number" class="form-input numero-stringhe" name="stringhe_${id}" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità Inverter
                            </label>
                            <input type="number" class="form-input numero-inverter" name="quantita_${id}" value="1" min="1">
                        </div>
                    </div>
                </div>
            `;
        }

        function getInvertersData() {
            const inverters = [];
            document.querySelectorAll('.inverter-group').forEach(group => {
                const select = group.querySelector('.inverter-select');
                const stringhe = group.querySelector('.numero-stringhe');
                const quantita = group.querySelector('.numero-inverter');
                if (select.value !== 'none') {
                    inverters.push({
                        modello: select.value,
                        prezzo: parseFloat(select.options[select.selectedIndex].dataset.prezzo),
                        stringhe: parseInt(stringhe.value),
                        quantita: parseInt(quantita.value)
                    });
                }
            });
            return inverters;
        }

        document.getElementById('aggiungiInverter').addEventListener('click', function() {
            const container = document.getElementById('invertersContainer');
            container.insertAdjacentHTML('beforeend', createInverterTemplate(inverterCounter));
            
            const newInverter = container.lastElementChild;
            newInverter.querySelector('.rimuovi-inverter').addEventListener('click', function() {
                newInverter.remove();
                calcolaPreventivoInRealTime();
            });
            
            newInverter.querySelector('.inverter-select').addEventListener('change', calcolaPreventivoInRealTime);
            newInverter.querySelector('.numero-stringhe').addEventListener('input', calcolaPreventivoInRealTime);
            newInverter.querySelector('.numero-inverter').addEventListener('input', calcolaPreventivoInRealTime);
            
            inverterCounter++;
            calcolaPreventivoInRealTime();
        });

        function toggleParallelBoxNumber() {
            const parallelBoxValue = document.getElementById('parallelBox').value;
            const numeroParallelBoxContainer = document.getElementById('numeroParallelBoxContainer');
            numeroParallelBoxContainer.style.display = parallelBoxValue === 'none' ? 'none' : 'block';
        }

        function toggleEssCabinetNumber() {
            const essCabinetValue = document.getElementById('essCabinet').value;
            const numeroEssCabinetContainer = document.getElementById('numeroEssCabinetContainer');
            numeroEssCabinetContainer.style.display = essCabinetValue === 'none' ? 'none' : 'block';
        }

        document.getElementById('essCabinet').addEventListener('change', toggleEssCabinetNumber);
        document.getElementById('essCabinet').addEventListener('change', calcolaPreventivoInRealTime);

        document.getElementById('parallelBox').addEventListener('change', toggleParallelBoxNumber);
        document.getElementById('parallelBox').addEventListener('change', calcolaPreventivoInRealTime);
        document.getElementById('parallelBox').addEventListener('change', function() {
            toggleParallelBoxNumber();
            calcolaPreventivoInRealTime();
        });
        document.getElementById('numeroParallelBox').addEventListener('input', calcolaPreventivoInRealTime);

        function toggleEvChargerNumber() {
            const evChargerValue = document.getElementById('evCharger').value;
            const numeroEvChargerContainer = document.getElementById('numeroEvChargerContainer');
            numeroEvChargerContainer.style.display = evChargerValue === 'none' ? 'none' : 'block';
        }

        function toggleAccessoryVisibility(selectId, containerId) {
            const selectElement = document.getElementById(selectId);
            const containerElement = document.getElementById(containerId);
            if (selectElement && containerElement) {
                containerElement.style.display = selectElement.value === 'none' ? 'none' : 'block';
            }
        }

        let batterieCounter = 0;

        function createBatteriaTemplate(id) {
            return `
                <div class="batteria-group mb-4 p-4 border rounded-lg bg-gray-50" data-batteria-id="${id}">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium">Batteria ${id + 1}</h4>
                        <button type="button" class="rimuovi-batteria text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M13 7H7v6h6V7z" />
                                    <path fill-rule="evenodd" d="M7 2a1 1 0 00-.707 1.707L7 4.414v1.586H5a1 1 0 00-1 1v9a1 1 0 001 1h10a1 1 0 001-1v-9a1 1 0 00-1-1h-2V4.414l.707-.707A1 1 0 0013 2H7zm2 3V4h2v1H9z" clip-rule="evenodd" />
                                </svg>
                                Modello Batteria
                            </label>
                            <select class="form-select batteria-select" name="batteria_${id}">
                                <option value="none">Seleziona Batteria</option>
                                ${document.getElementById('batterieTipo').innerHTML}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="#718096">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z" />
                                </svg>
                                Quantità Batterie
                            </label>
                            <input type="number" class="form-input numero-batterie" name="quantita_${id}" value="1" min="1">
                        </div>
                    </div>
                </div>
            `;
        }

        function getBatterieData() {
            const batterie = [];
            document.querySelectorAll('.batteria-group').forEach(group => {
                const select = group.querySelector('.batteria-select');
                const quantita = group.querySelector('.numero-batterie');
                if (select.value !== 'none') {
                    batterie.push({
                        modello: select.value,
                        prezzo: parseFloat(select.options[select.selectedIndex].dataset.prezzo),
                        quantita: parseInt(quantita.value)
                    });
                }
            });
            return batterie;
        }

        document.getElementById('aggiungiBatteria').addEventListener('click', function() {
            const container = document.getElementById('batterieContainer');
            container.insertAdjacentHTML('beforeend', createBatteriaTemplate(batterieCounter));
            
            const newBatteria = container.lastElementChild;
            newBatteria.querySelector('.rimuovi-batteria').addEventListener('click', function() {
                newBatteria.remove();
                calcolaPreventivoInRealTime();
            });
            
            newBatteria.querySelector('.batteria-select').addEventListener('change', calcolaPreventivoInRealTime);
            newBatteria.querySelector('.numero-batterie').addEventListener('input', calcolaPreventivoInRealTime);
            
            batterieCounter++;
            calcolaPreventivoInRealTime();
        });

        // Funzione principale di calcolo preventivo
        function calcolaPreventivoInRealTime() {
            valoriDefault = {
                costoModuli: 0,
                costoMorsetti: 0,
                costoGuide: 0,
                costoStaffe: 0,
                costoProlunghe: 0,
                costoMezzi: 0,
                costoModuli: 0,
                costoInverter: 0,
                costoParallelBox: 0,
                costoBatterie: 0,
                costoEssCabinet: 0,
                costoWifi: 0,
                costoMateBox: 0,
                costoMeter: 0,
                costoCT: 0,
                costoEVCharger: 0,
                costoBatterie: 0,
                costoConnettivita: 0,
                costoBackupControllo: 0,
                costoMeterCT: 0,
                costoCaviAccessori: 0,
                costoQuadri: 0,
                costoCavi: 0,
                costoCaviCA: 0,
                costoFresia: 0,
                costoMezzi: 0,
                costoSicurezza: 0,
                totaleNumeroFile: 0,
                totaleModuliPerFila: 0,
                costoManodoperaTotale: 0
            };

            Object.entries(valoriDefault).forEach(([chiave, valore]) => {
                if (isNaN(window[chiave])) {
                    window[chiave] = valore;
                }
            });

            let prezzoModulo = 0;
            let costoModuliTotale = 0;
            let totaleModuli = 0;
            let potenzaTotaleKw = 0;

            document.querySelectorAll('.falda-group').forEach(falda => {
                falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                    const moduloSelect = gruppo.querySelector('.gruppo-modulo');
                    const potenzaModulo = parseFloat(moduloSelect.options[moduloSelect.selectedIndex].dataset.potenza) || 0;
                    const numeroFile = parseFloat(gruppo.querySelector('.gruppo-numero-file').value) || 0;
                    const moduliPerFila = parseFloat(gruppo.querySelector('.gruppo-moduli-fila').value) || 0;
                    
                    totaleNumeroFile += numeroFile;
                    totaleModuliPerFila += moduliPerFila;
                    
                    const totaleModuliGruppo = numeroFile * moduliPerFila;
                    const potenzaGruppoWatt = totaleModuliGruppo * potenzaModulo;
                    const potenzaGruppoKw = potenzaGruppoWatt / 1000;
                    
                    potenzaTotaleKw += potenzaGruppoKw;
                    totaleModuli += totaleModuliGruppo;
                    costoModuliTotale += totaleModuliGruppo * parseFloat(moduloSelect.options[moduloSelect.selectedIndex].dataset.prezzo || 0);
                    
                    if (prezzoModulo === 0) {
                        prezzoModulo = parseFloat(moduloSelect.options[moduloSelect.selectedIndex].dataset.prezzo || 0);
                    }
                });
            });

            const costoModuli = costoModuliTotale;

            const potenzaTotale = calcolaPotenzaTotale();

            const numeroBatterie = document.getElementById('batterieTipo').value !== 'none' ? parseFloat(document.getElementById('numeroBatterie').value) : 0;
            aggiornaGuideTotali();

            const tipoTetto = document.getElementById('tipoTetto').value;
            const { guideTotali, lunghezzaGuida, staffeTotali, prolungheTotali } = aggiornaGuideTotali();
            
            let quantitaMorsettiCentrali = 0;
            let quantitaMorsettiFinali = 0;

            document.querySelectorAll('.falda-group').forEach(falda => {
                falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                    const numeroFile = parseFloat(gruppo.querySelector('.gruppo-numero-file').value) || 0;
                    const moduliPerFila = parseFloat(gruppo.querySelector('.gruppo-moduli-fila').value) || 0;
                    
                    // Per ogni fila
                    if (numeroFile && moduliPerFila) {
                        // Morsetti centrali: 2 per ogni spazio tra moduli in una fila
                        const morsettiCentraliPerFila = (moduliPerFila - 1) * 2;
                        quantitaMorsettiCentrali += morsettiCentraliPerFila * numeroFile;
                        
                        // Morsetti finali: 2 all'inizio e 2 alla fine di ogni fila
                        const morsettiFinaliPerFila = 4;  // 2 all'inizio + 2 alla fine
                        quantitaMorsettiFinali += morsettiFinaliPerFila * numeroFile;
                    }
                });
            });

            // Funzione per validare le percentuali di pagamento
            function verificaPercentualiPagamento() {
                const prima = parseFloat(document.getElementById('percentualePrimaPagamento').value) || 0;
                const seconda = parseFloat(document.getElementById('percentualeSecondaPagamento').value) || 0;
                const terza = parseFloat(document.getElementById('percentualeTerzaPagamento').value) || 0;
                
                const somma = prima + seconda + terza;
                const erroreElem = document.getElementById('errorePercentuali');
                
                if (somma !== 100) {
                    erroreElem.textContent = `La somma delle percentuali è ${somma}%. Deve essere esattamente 100%.`;
                    erroreElem.classList.remove('hidden');
                    return false;
                } else {
                    erroreElem.classList.add('hidden');
                    return true;
                }
            }

            // Aggiungi event listeners per validare quando i valori cambiano
            document.getElementById('percentualePrimaPagamento').addEventListener('input', verificaPercentualiPagamento);
            document.getElementById('percentualeSecondaPagamento').addEventListener('input', verificaPercentualiPagamento);
            document.getElementById('percentualeTerzaPagamento').addEventListener('input', verificaPercentualiPagamento);

            const costoUnitarioMorsettiCentrali = parseFloat(document.getElementById('costoMorsettiCentrali').value);
            const costoCentrali = quantitaMorsettiCentrali * costoUnitarioMorsettiCentrali;

            const costoUnitarioMorsettiFinali = parseFloat(document.getElementById('costoMorsettiFinali').value);
            const costoFinali = quantitaMorsettiFinali * costoUnitarioMorsettiFinali;

            // Calcolo costo morsetti totale
            const costoMorsetti = costoCentrali + costoFinali;
            
            // Calcolo spazio per moduli
            const orientamento = document.querySelector('.falda-orientamento') 
                ? document.querySelector('.falda-orientamento').value 
                : 'verticale';
            const larghezzaModulo = orientamento === 'verticale' ? 1.134 : 1.724;

            // Calcolo costo inverter
            const invertersData = getInvertersData();
            const costoInverter = invertersData.reduce((total, inv) => total + (inv.prezzo * inv.quantita), 0);

            // Calcolo costo parallel box
            const parallelBoxSelezionato = document.getElementById('parallelBox');
            const prezzoParallelBox = parseFloat(parallelBoxSelezionato.options[parallelBoxSelezionato.selectedIndex].dataset.prezzo || 0);
            const numeroParallelBox = document.getElementById('parallelBox').value !== 'none' 
                ? parseFloat(document.getElementById('numeroParallelBox').value || 0) 
                : 0;
            const costoParallelBox = prezzoParallelBox * numeroParallelBox;

            // Calcolo costo batterie
            const batterieData = getBatterieData();
            const costoBatterie = batterieData.reduce((total, batt) => total + (batt.prezzo * batt.quantita), 0);

            // Calculate accessories costs
            const connettivitaSelect = document.getElementById('connettivita');
            const prezzoConnettivita = parseFloat(connettivitaSelect.options[connettivitaSelect.selectedIndex].dataset.prezzo || 0);
            const numeroConnettivita = document.getElementById('connettivita').value !== 'none' ? parseFloat(document.getElementById('numeroConnettivita').value) : 0;
            const costoConnettivita = prezzoConnettivita * numeroConnettivita;

            const backupControlloSelect = document.getElementById('backupControllo');
            const prezzoBackupControllo = parseFloat(backupControlloSelect.options[backupControlloSelect.selectedIndex].dataset.prezzo || 0);
            const numeroBackupControllo = document.getElementById('backupControllo').value !== 'none' ? parseFloat(document.getElementById('numeroBackupControllo').value) : 0;
            const costoBackupControllo = prezzoBackupControllo * numeroBackupControllo;

            const meterCTSelect = document.getElementById('meterCT');
            const prezzoMeterCT = parseFloat(meterCTSelect.options[meterCTSelect.selectedIndex].dataset.prezzo || 0);
            const numeroMeterCT = document.getElementById('meterCT').value !== 'none' ? parseFloat(document.getElementById('numeroMeterCT').value) : 0;
            const costoMeterCT = prezzoMeterCT * numeroMeterCT;

            const caviAccessoriSelect = document.getElementById('caviAccessori');
            const prezzoCaviAccessori = parseFloat(caviAccessoriSelect.options[caviAccessoriSelect.selectedIndex].dataset.prezzo || 0);
            const numeroCaviAccessori = document.getElementById('caviAccessori').value !== 'none' ? parseFloat(document.getElementById('numeroCaviAccessori').value) : 0;
            const costoCaviAccessori = prezzoCaviAccessori * numeroCaviAccessori;

            const costoAccessori = costoConnettivita + costoBackupControllo + costoMeterCT + costoCaviAccessori;
            
            // Calcolo spazio totale per fila
            const spazioMorsettiIniziali = 0.03;
            const spazioMorsettiFinali = 0.03;
            const spazioMorsettiCentrali = (totaleModuliPerFila - 1) * 0.03;
            const spazioModuli = totaleModuliPerFila * larghezzaModulo;
            
            const lunghezzaTotaleFila = spazioMorsettiIniziali + spazioModuli + 
                spazioMorsettiCentrali + spazioMorsettiFinali;
            
            // Calcolo guide necessarie
            const guidePerCoprituraLunghezza = Math.ceil(lunghezzaTotaleFila / 3.2);
            const guidePerFilaModuli = guidePerCoprituraLunghezza * 2;
            const numeroGuideTotali = guidePerFilaModuli * totaleNumeroFile;
            
            // Calcolo costi guide
            const costoUnitarioGuideLamiera = parseFloat(document.getElementById('costoGuideLamiera').value);
            const costoUnitarioGuideTegole = parseFloat(document.getElementById('costoGuideTegole').value);
            const costoGuide = tipoTetto === 'lamiera' 
                ? (guideTotali * costoUnitarioGuideLamiera)
                : (guideTotali * costoUnitarioGuideTegole);
            
            // Calcolo staffe e prolunghe per tetto con tegole
            let costoStaffe = 0;
            let costoProlunghe = 0;
            let quantitaStaffe = 0;
            let quantitaProlunghe = 0;
            if (tipoTetto === 'tegole') {
                const costoUnitarioStaffe = parseFloat(document.getElementById('costoStaffeTegole').value);
                const costoUnitarioProlunghe = parseFloat(document.getElementById('costoProlungaGuide').value);
                
                costoStaffe = staffeTotali * costoUnitarioStaffe;
                costoProlunghe = prolungheTotali * costoUnitarioProlunghe;
                
                quantitaStaffe = staffeTotali;
                quantitaProlunghe = prolungheTotali;
            }

            // Add calculations for new components
            const essCabinetSelect = document.getElementById('essCabinet');
            const essCabinetPrezzo = parseFloat(essCabinetSelect.options[essCabinetSelect.selectedIndex].dataset.prezzo || 0);
            const numeroEssCabinet = document.getElementById('essCabinet').value !== 'none' ? parseFloat(document.getElementById('numeroEssCabinet').value) : 0;
            const costoEssCabinet = essCabinetPrezzo * numeroEssCabinet;

            // Calculate EV charger cost
            const evChargerSelect = document.getElementById('evCharger');
            const prezzoEvCharger = parseFloat(evChargerSelect.options[evChargerSelect.selectedIndex].dataset.prezzo || 0);
            const numeroEvCharger = document.getElementById('evCharger').value !== 'none' ? parseFloat(document.getElementById('numeroEvCharger').value) : 0;
            const costoEVCharger = prezzoEvCharger * numeroEvCharger;

            // Calcolo altri costi
            // Calcolo lunghezza base con la nuova formula
            const altezzaCapannone = parseFloat(document.getElementById('altezzaCapannone').value) || 0;
            const profonditaCapannone = parseFloat(document.getElementById('profonditaCapannone').value) || 0;

            // Calcolo lunghezza totale con margine del 20%
            const margin = 1.2; // 20% margine
            const falde = getFaldeData();
            let baseLengthCavi = 0;
            for (const falda of falde) {
                baseLengthCavi += falda.larghezza + profonditaCapannone + altezzaCapannone + 10;
            }
            const totalLengthCavi = baseLengthCavi * margin;

            // Calcolo costi cavi DC (+ e -)
            const dcCableLength = totalLengthCavi;
            const dcCableCost = parseFloat(document.getElementById('costoCavi').value);
            const costoCavi = dcCableCost * dcCableLength * 2; // Moltiplicato per 2 per DC+ e DC-

            // Calcolo costi cavi CA
            const acCableLength = parseFloat(document.getElementById('lunghezzaCaviCA').value) || 0;
            const costoCaviCA = parseFloat(document.getElementById('costoCaviCA').value) * acCableLength;
            
            const costoQuadri = parseFloat(document.getElementById('costoQuadri').value || 0);
            const costoFresia = parseFloat(document.getElementById('costoFresia').value || 0);
            const costoMezzi = parseFloat(document.getElementById('costoMezzi').value || 0) * 
                parseFloat(document.getElementById('giorniMezzi').value || 0);
            const costoSicurezza = parseFloat(document.getElementById('costoSicurezza').value || 0);
            
            // Calcolo manodopera
            const costoManodoperaKw = parseFloat(document.getElementById('costoManodopera').value || 0);
            const costoManodoperaTotale = costoManodoperaKw * potenzaTotale;
            
            // Calcolo totali
            const costoMateriali = costoModuli + costoMorsetti + costoGuide + costoMezzi + costoCavi + costoBatterie + 
                costoQuadri + costoCaviCA + costoStaffe + costoProlunghe + costoParallelBox + costoInverter;
            
            const costoImpianto = costoMateriali + costoManodoperaTotale + costoEssCabinet + costoAccessori + costoEVCharger;
            const costoTotale = costoImpianto + costoFresia + costoSicurezza;
            
            // Applica margine
            const margine = parseFloat(document.getElementById('margineGuadagno').value) / 100;
            const percentualeIva = parseFloat(document.getElementById('percentualeIva').value);
            const preventivoFinale = costoTotale * (1 + margine);
            const preventivoFinaleConIva = preventivoFinale * (1 + (percentualeIva / 100));

            // Se ci sono dati PVGIS disponibili, usa quelli per il calcolo della produzione
            if (pvgisData && pvgisData.outputs && pvgisData.outputs.totals && pvgisData.outputs.totals.fixed) {
                const totalData = pvgisData.outputs.totals.fixed;
                if (totalData.E_y) {
                    // Aggiorna il valore della produzione annua nel preventivo
                    produzioneAnnua = totalData.E_y;
                }
            }

            // Aggiorna valoriDefault con i valori calcolati
            valoriDefault = {
                costoModuli,
                costoMorsetti,
                costoGuide,
                costoStaffe,
                costoProlunghe,
                costoInverter,
                costoParallelBox,
                costoBatterie,
                costoEssCabinet,
                costoEVCharger,
                costoConnettivita,
                costoBackupControllo,
                costoMeterCT,
                costoCaviAccessori,
                costoQuadri,
                costoCavi,
                costoCaviCA,
                costoFresia,
                costoMezzi,
                costoSicurezza,
                costoManodoperaTotale
            };
            
            // Visualizza risultati
            const risultati = document.getElementById('risultati');
            risultati.innerHTML = `
                <div class="highlight-box mt-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                        Riepilogo Finale
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-gray-600">Potenza Totale Impianto</p>
                            <p class="text-2xl font-bold text-blue-900">${potenzaTotale.toFixed(2)} kW</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Moduli Fotovoltaici</p>
                            <p class="text-lg">€${costoModuli.toFixed(2)}</p>
                        </div>
                        ${document.getElementById('inverter').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Inverter</p>
                            <p class="text-lg">€${costoInverter.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('parallelBox').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Parallel Box</p>
                            <p class="text-lg">€${costoParallelBox.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('essCabinet').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo ESS Cabinet</p>
                            <p class="text-lg">€${costoEssCabinet.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        <div>
                            <p class="text-sm text-gray-600">Costo Morsetti</p>
                            <p class="text-lg">€${costoMorsetti.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Guide</p>
                            <p class="text-lg">€${costoGuide.toFixed(2)}</p>
                        </div>
                        ${tipoTetto === 'tegole' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Staffe e Prolunghe</p>
                            <p class="text-lg">€${(costoStaffe + costoProlunghe).toFixed(2)}</p>
                        </div>
                        ` : ''}
                        <div>
                            <p class="text-sm text-gray-600">Costo Cavi DC</p>
                            <p class="text-lg">€${costoCavi.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Cavi CA</p>
                            <p class="text-lg">€${costoCaviCA.toFixed(2)}</p>
                        </div>
                        ${invertersData.length > 0 ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Inverter</p>
                            <p class="text-lg">€${costoInverter.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${batterieData.length > 0 ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Batterie</p>
                            <p class="text-lg">€${costoBatterie.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        <div>
                            <p class="text-sm text-gray-600">Costo Quadri Elettrici</p>
                            <p class="text-lg">€${costoQuadri.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Fresia</p>
                            <p class="text-lg">€${costoFresia.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Mezzi</p>
                            <p class="text-lg">€${costoMezzi.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Sicurezza</p>
                            <p class="text-lg">€${costoSicurezza.toFixed(2)}</p>
                        </div>
                        ${document.getElementById('evCharger').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Caricatore EV</p>
                            <p class="text-lg">€${costoEVCharger.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('connettivita').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Connettività</p>
                            <p class="text-lg">€${costoConnettivita.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('backupControllo').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Backup e Controllo</p>
                            <p class="text-lg">€${costoBackupControllo.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('meterCT').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Meter e CT</p>
                            <p class="text-lg">€${costoMeterCT.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        ${document.getElementById('caviAccessori').value !== 'none' ? `
                        <div>
                            <p class="text-sm text-gray-600">Costo Cavi e Accessori</p>
                            <p class="text-lg">€${costoCaviAccessori.toFixed(2)}</p>
                        </div>
                        ` : ''}
                        <div>
                            <p class="text-sm text-gray-600">Costo Manodopera</p>
                            <p class="text-lg">€${costoManodoperaTotale.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Impianto</p>
                            <p class="text-sm text-gray-600">esclusi fresia, mezzi e sicurezza </p>
                            <p class="text-lg font-bold">€${costoImpianto.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Costo Totale (senza margine)</p>
                            <p class="text-lg font-bold">€${costoTotale.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Preventivo Finale (IVA esclusa = Blu, IVA inclusa = Rosso)</p>
                            <p class="text-2xl font-bold text-blue-600">€${preventivoFinale.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Include margine del ${(margine*100).toFixed(0)}%</p>
                            <p class="text-2xl font-bold text-red-600">€${preventivoFinaleConIva.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;

            // Dettaglio costi unitari
            const dettagliCostiElement = document.getElementById('dettagliCosti');
            dettagliCostiElement.innerHTML = `
                <div class="mt-4 overflow-x-auto">
                    <h4 class="text-lg font-semibold mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="#0F3460">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm2.5 7a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm2.45 4a2.5 2.5 0 10-4.9 0h4.9zM12 9a1 1 0 100 2h3a1 1 0 100-2h-3zm-1 4a1 1
                    0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                        Dettaglio Costi Unitari
                    </h4>
                    <table class="w-full table-auto border-collapse text-sm md:text-base">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2 text-left w-4/12 md:w-auto">Voce</th>
                                <th class="border p-2 text-right w-2/12 md:w-auto">Quantità</th>
                                <th class="border p-2 text-right w-3/12 md:w-auto">Costo Unitario (€)</th>
                                <th class="border p-2 text-right w-3/12 md:w-auto">Costo Totale (€)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">Moduli Fotovoltaici</td>
                                <td class="border p-2 text-right">${totaleModuli}</td>
                                <td class="border p-2 text-right">${prezzoModulo.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoModuli.toFixed(2)}</td>
                            </tr>
                            ${invertersData.map((inv, index) => {
                                const inverterSelect = document.getElementById('inverter');
                                const selectedOption = Array.from(inverterSelect.options).find(option => option.value === inv.modello);
                                const modelText = selectedOption ? selectedOption.text : 'Non specificato';
                                return `
                                <tr>
                                    <td class="border p-2">Inverter ${index + 1} - ${modelText}</td>
                                    <td class="border p-2 text-right">${inv.quantita}</td>
                                    <td class="border p-2 text-right">${inv.prezzo.toFixed(2)}</td>
                                    <td class="border p-2 text-right">${(inv.prezzo * inv.quantita).toFixed(2)}</td>
                                </tr>
                                `;
                            }).join('')}
                            ${document.getElementById('parallelBox').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('parallelBox').options[document.getElementById('parallelBox').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroParallelBox}</td>
                                <td class="border p-2 text-right">${prezzoParallelBox.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoParallelBox.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            ${batterieData.map((batt, index) => {
                                const batteriaSelect = document.getElementById('batterieTipo');
                                const selectedOption = Array.from(batteriaSelect.options).find(option => option.value === batt.modello);
                                const modelText = selectedOption ? selectedOption.text : 'Non specificato';
                                return `
                                <tr>
                                    <td class="border p-2">Batteria ${index + 1} - ${modelText}</td>
                                    <td class="border p-2 text-right">${batt.quantita}</td>
                                    <td class="border p-2 text-right">${batt.prezzo.toFixed(2)}</td>
                                    <td class="border p-2 text-right">${(batt.prezzo * batt.quantita).toFixed(2)}</td>
                                </tr>
                                `;
                            }).join('')}
                            ${document.getElementById('essCabinet').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('essCabinet').options[document.getElementById('essCabinet').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroEssCabinet}</td>
                                <td class="border p-2 text-right">${essCabinetPrezzo.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoEssCabinet.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            ${document.getElementById('evCharger').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('evCharger').options[document.getElementById('evCharger').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroEvCharger}</td>
                                <td class="border p-2 text-right">${prezzoEvCharger.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoEVCharger.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td class="border p-2">Morsetti Centrali</td>
                                <td class="border p-2 text-right">${quantitaMorsettiCentrali}</td>
                                <td class="border p-2 text-right">${costoUnitarioMorsettiCentrali.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoCentrali.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Morsetti Finali</td>
                                <td class="border p-2 text-right">${quantitaMorsettiFinali}</td>
                                <td class="border p-2 text-right">${costoUnitarioMorsettiFinali.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoFinali.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Guide</td>
                                <td class="border p-2 text-right">${guideTotali}</td>
                                <td class="border p-2 text-right">${tipoTetto === 'lamiera' ? costoUnitarioGuideLamiera.toFixed(2) : costoUnitarioGuideTegole.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoGuide.toFixed(2)}</td>
                            </tr>
                            ${tipoTetto === 'tegole' ? `
                            <tr>
                                <td class="border p-2">Staffe Tegole</td>
                                <td class="border p-2 text-right">${quantitaStaffe}</td>
                                <td class="border p-2 text-right">${document.getElementById('costoStaffeTegole').value}</td>
                                <td class="border p-2 text-right">${costoStaffe.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Prolunghe Guide</td>
                                <td class="border p-2 text-right">${quantitaProlunghe}</td>
                                <td class="border p-2 text-right">${document.getElementById('costoProlungaGuide').value}</td>
                                <td class="border p-2 text-right">${costoProlunghe.toFixed(2)}</td>
                            </tr>` : ''}
                            <tr>
                                <td class="border p-2">Costo Mezzi</td>
                                <td class="border p-2 text-right">${parseFloat(document.getElementById('giorniMezzi').value || 0)}</td>
                                <td class="border p-2 text-right">${parseFloat(document.getElementById('costoMezzi').value || 0).toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoMezzi.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Quadri Elettrici</td>
                                <td class="border p-2 text-right">1</td>
                                <td class="border p-2 text-right">${costoQuadri.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoQuadri.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Cavi DC+ e DC-</td>
                                <td class="border p-2 text-right">${totalLengthCavi.toFixed(2)} m x 2</td>
                                <td class="border p-2 text-right">${parseFloat(document.getElementById('costoCavi').value).toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoCavi.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="border p-2">Cavi CA</td>
                                <td class="border p-2 text-right">${acCableLength.toFixed(2)} m</td>
                                <td class="border p-2 text-right">${parseFloat(document.getElementById('costoCaviCA').value).toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoCaviCA.toFixed(2)}</td>
                            </tr>
                            ${document.getElementById('connettivita').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('connettivita').options[document.getElementById('connettivita').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroConnettivita}</td>
                                <td class="border p-2 text-right">${prezzoConnettivita.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoConnettivita.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            ${document.getElementById('backupControllo').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('backupControllo').options[document.getElementById('backupControllo').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroBackupControllo}</td>
                                <td class="border p-2 text-right">${prezzoBackupControllo.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoBackupControllo.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            ${document.getElementById('meterCT').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('meterCT').options[document.getElementById('meterCT').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroMeterCT}</td>
                                <td class="border p-2 text-right">${prezzoMeterCT.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoMeterCT.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            ${document.getElementById('caviAccessori').value !== 'none' ? `
                            <tr>
                                <td class="border p-2">${document.getElementById('caviAccessori').options[document.getElementById('caviAccessori').selectedIndex].text}</td>
                                <td class="border p-2 text-right">${numeroCaviAccessori}</td>
                                <td class="border p-2 text-right">${prezzoCaviAccessori.toFixed(2)}</td>
                                <td class="border p-2 text-right">${costoCaviAccessori.toFixed(2)}</td>
                            </tr>
                            ` : ''}
                            <tr class="bg-gray-100 font-bold">
                                <td class="border p-2" colspan="3">Totale Costi Unitari</td>
                                <td class="border p-2 text-right">${(
                                    costoMorsetti + 
                                    costoGuide + 
                                    costoStaffe + 
                                    costoProlunghe + 
                                    costoMezzi +
                                    costoModuli +
                                    costoInverter +
                                    costoParallelBox +
                                    costoEssCabinet +
                                    costoEVCharger +
                                    costoBatterie +
                                    costoQuadri +
                                    costoCavi +
                                    costoCaviCA +
                                    costoFresia +
                                    costoConnettivita +
                                    costoBackupControllo +
                                    costoMeterCT +
                                    costoCaviAccessori
                                ).toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Add event listeners for accessory changes
        ['connettivita', 'backupControllo', 'meterCT', 'caviAccessori'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => {
                    toggleAccessoryVisibility(id, `numero${id.charAt(0).toUpperCase() + id.slice(1)}Container`);
                    calcolaPreventivoInRealTime();
                });
            }
        });

        // Add event listeners for quantity inputs
        ['numeroConnettivita', 'numeroBackupControllo', 'numeroMeterCT', 'numeroCaviAccessori'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', calcolaPreventivoInRealTime);
            }
        });

        // Initialize accessory visibility
        ['connettivita', 'backupControllo', 'meterCT', 'caviAccessori'].forEach(id => {
            toggleAccessoryVisibility(id, `numero${id.charAt(0).toUpperCase() + id.slice(1)}Container`);
        });

        // Event listeners per il calcolo in tempo reale
        const realTimeCalculationInputs = [
            'costoMorsettiCentrali', 'costoMorsettiFinali', 
            'costoGuideLamiera', 'costoGuideTegole', 'costoCavi', 'costoCaviCA', 
            'costoQuadri', 'costoFresia', 'costoMezzi', 'percentualeIva',
            'costoSicurezza', 'costoManodopera', 'margineGuadagno', 
            'costoStaffeTegole', 'giorniMezzi', 'inverter', 'parallelBox',
            'altezzaCapannone', 'profonditaCapannone', 'lunghezzaCaviCA', 'evCharger'
        ];

        realTimeCalculationInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calcolaPreventivoInRealTime);
            } else {
                console.warn(`Elemento con id '${id}' non trovato`);
            }
        });

        // Event listeners per calcoli real-time
            document.getElementById('consumoAnnuo').addEventListener('input', aggiornaSpesaEnergia);
            document.getElementById('costoEnergiaAttuale').addEventListener('input', aggiornaSpesaEnergia);
            document.getElementById('spesaAnnuaEnergia').addEventListener('input', calcolaPreventivoInRealTime);
            document.getElementById('autoconsumoStimato').addEventListener('input', calcolaPreventivoInRealTime);

            // Funzione per aggiornare automaticamente la spesa energetica
            function aggiornaSpesaEnergia() {
                const consumo = parseFloat(document.getElementById('consumoAnnuo').value) || 0;
                const costo = parseFloat(document.getElementById('costoEnergiaAttuale').value) || 0;
                
                // Solo se l'utente non ha inserito un valore personalizzato
                if ((!document.getElementById('spesaAnnuaEnergia').dataset.userModified) || (document.getElementById('spesaAnnuaEnergia') == 0)) {
                    document.getElementById('spesaAnnuaEnergia').value = (consumo * costo).toFixed(2);
                }
                
                calcolaPreventivoInRealTime();
            }

            // Flag per sapere se l'utente ha modificato manualmente la spesa
            document.getElementById('spesaAnnuaEnergia').addEventListener('focus', function() {
                this.dataset.userModified = 'true';
            });

        // Array per memorizzare le immagini base64
        let renderImages = [null, null, null];

        // Funzione per gestire il caricamento delle immagini
        function handleImageUpload(event, index) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Crea un'immagine temporanea per il ridimensionamento
                        console.log('creo una immagine temporanea per il ridimensioniamento')
                        const img = new Image();
                        img.onload = function() {
                            // Dimensione ottimale per stampa A4 (circa 1700px di larghezza)
                            console.log('Dimensione ottimale per stampa A4 (circa 1700px di larghezza)');
                            const maxWidth = 1700;
                            let width = img.width;
                            let height = img.height;
                            
                            // Ridimensiona solo se l'immagine è più grande del necessario
                            console.log("Ridimensiona solo se l'immagine è più grande del necessario");
                            console.log("larghezza immagine: " + width);
                            console.log("larghezza massima: " + maxWidth);
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            // Crea un canvas per ridimensionare l'immagine
                            console.log("Crea un canvas per ridimensionare l'immagine");
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            
                            // Disegna l'immagine ridimensionata sul canvas
                            console.log("Disegna l'immagine ridimensionata sul canvas");
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Converti in base64 con qualità ottimizzata (0.8 = 80%)
                            console.log("Converti in base64 con qualità ottimizzata (0.8 = 80%)");
                            const optimizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                            
                            // Salva l'immagine ottimizzata
                            console.log("Salva l'immagine ottimizzata");
                            renderImages[index] = optimizedBase64;
                            
                            // Mostra l'anteprima
                            console.log("Mostra l'anteprima");
                            const previewContainer = document.getElementById(`preview${index + 1}`);
                            if (previewContainer) {
                                const previewImage = previewContainer.querySelector('img');
                                if (previewImage) {
                                    previewImage.src = optimizedBase64;
                                    previewContainer.classList.remove('hidden');
                                }
                            }
                        };
                        img.src = e.target.result;
                    } catch (err) {
                        console.log("Errore nella visualizzazione dell'anteprima:", err);
                        alert("Impossibile visualizzare l'anteprima dell'immagine.");
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (err) {
                console.log("Errore nel caricamento dell'immagine:", err);
                alert("Problema nel caricamento dell'immagine.");
            }
        }

        // Funzione per rimuovere un'immagine
        function removeImage(index) {
            renderImages[index] = null;
            
            // Rimuovi l'anteprima
            const previewContainer = document.getElementById(`preview${index + 1}`);
            const fileInput = document.getElementById(`renderImage${index + 1}`);
            
            fileInput.value = "";
            previewContainer.classList.add('hidden');
        }

        function generateRiferimentoPreventivo() {
            return `PRV-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${String(new Date().getHours()).padStart(2, '0')}${String(new Date().getMinutes()).padStart(2, '0')}`;
        }

        // Funzione avanzata per determinare il range di giorni di installazione
        function calcolaGiorniInstallazione(potenzaTotale, tipoTetto, numeroBatterie, numeroInverter, altezzaCapannone, lunghezzaCapannone) {
            // Valori base per tetto in lamiera
            let giorniBase;
            
            // Calcolo giorni base in funzione della potenza
            if (potenzaTotale <= 6) {
                giorniBase = tipoTetto === 'lamiera' ? 3 : 5;
            } else if (potenzaTotale <= 15) {
                giorniBase = tipoTetto === 'lamiera' ? 5 : 8;
            } else if (potenzaTotale <= 30) {
                giorniBase = tipoTetto === 'lamiera' ? 10 : 15;
            } else if (potenzaTotale <= 50) {
                giorniBase = tipoTetto === 'lamiera' ? 15 : 25;
            } else {
                giorniBase = tipoTetto === 'lamiera' ? 25 : 35;
            }

            // Fattori di aggiustamento
            let fattoreBatterie = 0;
            if (numeroBatterie > 0) {
                // Ogni batteria aggiunge tempo, ma con rendimenti di scala decrescenti
                fattoreBatterie = Math.min(numeroBatterie * 0.5, 3); // Max 3 giorni extra per batterie
            }

            let fattoreInverter = 0;
            if (numeroInverter > 1) {
                // Inverter aggiuntivi richiedono più configurazione
                fattoreInverter = (numeroInverter - 1) * 0.5; // 0.5 giorni per ogni inverter oltre il primo
            }

            // Fattore edificio: edifici più grandi richiedono più tempo per cablaggio e logistica
            const fattoreEdificio = Math.sqrt(altezzaCapannone * lunghezzaCapannone) / 20; // Normalizzato

            // Tolleranza per imprevisti (10-20% del tempo totale)
            const tolleranzaMin = 0.1;
            const tolleranzaMax = 0.2;

            // Calcolo giorni totali
            const giorniTotali = giorniBase + fattoreBatterie + fattoreInverter + fattoreEdificio;
            
            // Calcolo range con tolleranza
            const giorniMin = Math.ceil(giorniTotali * (1 + tolleranzaMin));
            const giorniMax = Math.ceil(giorniTotali * (1 + tolleranzaMax));

            // Assicura che ci sia sempre una differenza di almeno 3 giorni tra min e max
            if (giorniMax - giorniMin < 3) {
                return { giorniMin, giorniMax: giorniMin + 3 };
            }
            
            return { giorniMin, giorniMax };
        }

        // Aggiungi event listener per il caricamento delle immagini
        document.getElementById('renderImage1').addEventListener('change', (e) => handleImageUpload(e, 0));
        document.getElementById('renderImage2').addEventListener('change', (e) => handleImageUpload(e, 1));
        document.getElementById('renderImage3').addEventListener('change', (e) => handleImageUpload(e, 2));

        // Aggiungi event listener per la rimozione delle immagini
        document.querySelectorAll('.remove-image').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-id')) - 1;
                removeImage(index);
            });
        });

        document.getElementById('numeroEssCabinet').addEventListener('input', calcolaPreventivoInRealTime);
        document.getElementById('giorniMezzi').addEventListener('input', calcolaPreventivoInRealTime);
        document.getElementById('costoProlungaGuide').addEventListener('input', calcolaPreventivoInRealTime);

        document.addEventListener('DOMContentLoaded', initializeFalde);

        // ========== GENERAZIONE PREVENTIVO HTML ===========

        document.getElementById('generaPreventivo').addEventListener('click', function() {
            // Pulisci la cache prima di generare il preventivo

            // Calcola i totali
            const costoTotale = document.querySelector('#risultati .highlight-box .grid div:nth-last-child(2) p:last-child').textContent.replace('€', '').trim();
            const preventivoFinale = document.querySelector('#risultati .highlight-box .grid div:last-child p:nth-child(2)').textContent.replace('€', '').trim();
            const { guideTotali, staffeTotali, prolungheTotali } = aggiornaGuideTotali();
            const acCableLength = parseFloat(document.getElementById('lunghezzaCaviCA').value) || 0;

            // Calculate totalLengthCavi the same way as in calcolaPreventivoInRealTime
            const altezzaCapannone = parseFloat(document.getElementById('altezzaCapannone').value) || 0;
            const profonditaCapannone = parseFloat(document.getElementById('profonditaCapannone').value) || 0;
            const margin = 1.2; // 20% margine
            const falde = getFaldeData();
            let baseLengthCavi = 0;
            for (const falda of falde) {
                baseLengthCavi += falda.larghezza + profonditaCapannone + altezzaCapannone + 10;
            }
            const totalLengthCavi = baseLengthCavi * margin;
            
            // Then collect other client data
            const nomeCognomeCliente = document.getElementById('nomeCognomeCliente').value || 'Cliente';
            const indirizzoImpianto = document.getElementById('indirizzoImpianto').value || 'Indirizzo non specificato';
            const potenzaTotale = calcolaPotenzaTotale();
            const margine = parseFloat(document.getElementById('margineGuadagno').value) / 100;
            
            // Retrieving all the key parameters that might be used in calculations
            const produzioneAnnuaKw = parseFloat(document.getElementById('produzioneAnnuaKw').value) || 0;
            const costoEnergiaAttuale = parseFloat(document.getElementById('costoEnergiaAttuale').value) || 0.16;
            const percentualeIva = parseFloat(document.getElementById('percentualeIva').value) || 10;
            const percentualeDetrazione = parseFloat(document.getElementById('percentualeDetrazione').value) || 0;
            const anniDetrazione = parseInt(document.getElementById('anniDetrazione').value) || 0;
            const detrazioniApplicabili = percentualeDetrazione > 0 && anniDetrazione > 0;
            const risparmioStimato = parseFloat(document.getElementById('risparmioStimato').value) || 0;
            const costoManodoperaKw = parseFloat(document.getElementById('costoManodopera').value) || 0;
            const costoFresia = parseFloat(document.getElementById('costoFresia').value) || 0;
            const costoSicurezza = parseFloat(document.getElementById('costoSicurezza').value) || 0;
            
            // Energy consumption data
            const consumoAnnuo = parseFloat(document.getElementById('consumoAnnuo').value) || 0;
            let spesaAnnuaEnergia = parseFloat(document.getElementById('spesaAnnuaEnergia').value) || 0;
            const autoconsumoStimato = parseFloat(document.getElementById('autoconsumoStimato').value) || 0;

            // If spesaAnnuaEnergia is 0, calculate it
            if (spesaAnnuaEnergia === 0 && consumoAnnuo > 0) {
                spesaAnnuaEnergia = consumoAnnuo * costoEnergiaAttuale;
            }

            // Calculate derived values
            const produzioneAnnua = potenzaTotale * produzioneAnnuaKw;
            const energiaAutoconsumata = consumoAnnuo * (autoconsumoStimato / 100);
            const energiaImmessa = produzioneAnnua - energiaAutoconsumata;
            const risparmioAutoconsumo = energiaAutoconsumata * costoEnergiaAttuale;
            const risparmioScambioSulPosto = energiaImmessa * (costoEnergiaAttuale * 0.7); 
            const risparmioTotale = risparmioAutoconsumo + risparmioScambioSulPosto;
            const tempoRientro = detrazioniApplicabili 
                ? Math.round(parseFloat(preventivoFinale) * (1 - percentualeDetrazione/100) / risparmioTotale)
                : Math.round(parseFloat(preventivoFinale) / risparmioTotale);
            
            // Cost calculations
            const costoManodoperaTotale = costoManodoperaKw * potenzaTotale;

            // Calcolo range per montare l'impianto
            const tipoTetto = document.getElementById('tipoTetto').value;
            const lunghezzaCapannone = parseFloat(document.getElementById('profonditaCapannone').value) || 0;

            // Conta il numero di batterie
            const numeroBatterie = getBatterieData().reduce((total, batt) => total + parseInt(batt.quantita), 0);

            // Conta il numero di inverter
            const numeroInverter = getInvertersData().reduce((total, inv) => total + parseInt(inv.quantita), 0);

            const { giorniMin, giorniMax } = calcolaGiorniInstallazione(
                potenzaTotale, 
                tipoTetto, 
                numeroBatterie, 
                numeroInverter, 
                altezzaCapannone, 
                lunghezzaCapannone
            );

            // Prendi il tipo di cessione
            const tipoSessioneSelect = document.getElementById('tipoCessione');
            const tipoCessione = tipoSessioneSelect.options[tipoSessioneSelect.selectedIndex].text;

            // Get data about roof slopes
            const faldeData = [];
            document.querySelectorAll('.falda-group').forEach(falda => {
                const nomeFalda = falda.querySelector('.falda-nome').value;
                const potenzaFaldaElement = falda.querySelector('.potenza-falda-totale');
                const potenzaFalda = potenzaFaldaElement ? potenzaFaldaElement.textContent : '0 kW';
                
                // Raccogli tutti i gruppi di moduli per questa falda
                const gruppiModuli = falda.querySelectorAll('.gruppo-moduli-item');
                
                // Se non ci sono gruppi, salta questa falda
                if (gruppiModuli.length === 0) return;
                
                // Prepara gli array per raccogliere dati da tutti i gruppi
                const moduliTypes = [];
                let totalNumeroFile = 0;
                let totalModuliPerFila = 0;
                let totalModuli = 0;
                
                // Raccogli dati da tutti i gruppi
                gruppiModuli.forEach(gruppo => {
                    const modulo = gruppo.querySelector('.gruppo-modulo');
                    if (modulo && modulo.options && modulo.selectedIndex >= 0) {
                        const moduloText = modulo.options[modulo.selectedIndex].text.replace(/\s*\(€[\d,.]+\)$/, '');
                        if (!moduliTypes.includes(moduloText)) {
                            moduliTypes.push(moduloText);
                        }
                    }
                    
                    const numeroFile = parseInt(gruppo.querySelector('.gruppo-numero-file')?.value || '0');
                    const moduliPerFila = parseInt(gruppo.querySelector('.gruppo-moduli-fila')?.value || '0');
                    
                    totalNumeroFile += numeroFile;
                    totalModuliPerFila += moduliPerFila;
                    totalModuli += numeroFile * moduliPerFila;
                });
                
                faldeData.push({
                    nome: nomeFalda,
                    potenza: potenzaFalda,
                    // Mostra tutti i tipi di modulo usati nella falda
                    modulo: moduliTypes.join(', '),
                    // Mostra il totale di tutti i gruppi
                    numeroFile: totalNumeroFile,
                    moduliPerFila: totalModuliPerFila,
                    totaleModuli: totalModuli
                });
            });

            // Recupera dati degli inverter
            const invertersData = getInvertersData().map(inv => {
                const select = document.getElementById('inverter');
                const option = Array.from(select.options).find(opt => opt.value === inv.modello);
                return {
                    ...inv,
                    nome: option ? option.text.replace(/\s*\(€[\d,.]+\/cad\)$/, '') : 'Inverter non specificato'
                };
            });
            
            // Recupera dati delle batterie
            const batterieData = getBatterieData().map(batt => {
                const select = document.getElementById('batterieTipo');
                const option = Array.from(select.options).find(opt => opt.value === batt.modello);
                return {
                    ...batt,
                    nome: option ? option.text.replace(/\s*\(€[\d,.]+\/cad\)$/, '') : 'Batteria non specificata'
                };
            });
            
            // Recupera dati degli accessori
            const accessoriData = [];
            
            // Funzione per aggiungere un accessorio se selezionato
            function aggiungiAccessorioSeSelezionato(selectId, containerId) {
                const select = document.getElementById(selectId);
                const container = document.getElementById(containerId);
                
                if (select.value !== 'none') {
                    const option = select.options[select.selectedIndex];
                    const quantita = document.querySelector(`#${containerId} input`).value;
                    const prezzo = parseFloat(option.dataset.prezzo || 0);
                    
                    accessoriData.push({
                        nome: option.text.replace(/\s*\(€[\d,.]+\/cad\)$/, ''),
                        quantita: quantita,
                        prezzoUnitario: prezzo,
                        prezzoTotale: prezzo * quantita
                    });
                }
            }
            
            // Controlla tutti gli accessori
            if (document.getElementById('evCharger').value !== 'none') {
                aggiungiAccessorioSeSelezionato('evCharger', 'numeroEvChargerContainer');
            }
            
            if (document.getElementById('connettivita').value !== 'none') {
                aggiungiAccessorioSeSelezionato('connettivita', 'numeroConnettivitaContainer');
            }
            
            if (document.getElementById('backupControllo').value !== 'none') {
                aggiungiAccessorioSeSelezionato('backupControllo', 'numeroBackupControlloContainer');
            }
            
            if (document.getElementById('meterCT').value !== 'none') {
                aggiungiAccessorioSeSelezionato('meterCT', 'numeroMeterCTContainer');
            }
            
            if (document.getElementById('caviAccessori').value !== 'none') {
                aggiungiAccessorioSeSelezionato('caviAccessori', 'numeroCaviAccessoriContainer');
            }
            
            if (document.getElementById('parallelBox').value !== 'none') {
                aggiungiAccessorioSeSelezionato('parallelBox', 'numeroParallelBoxContainer');
            }
            
            if (document.getElementById('essCabinet').value !== 'none') {
                aggiungiAccessorioSeSelezionato('essCabinet', 'numeroEssCabinetContainer');
            }
            
            // Recupera i dati aziendali
            const pIva = 'IT 09557480010';
            const indirizzoAzienda = 'Via Nizza 108, 10126 Torino, Italia';
            const nomeConsulente = 'Debasis';
            const telefonoAzienda = '+39 3200103380';
            const emailAzienda = 'solefacilesrl@gmail.com';
            const websiteAzienda = 'www.solefacilesrl.com';

            // Recupera parametri preventivo
            numeroPreventivo = generateRiferimentoPreventivo();
            const validitaPreventivo = document.getElementById('validitaPreventivo').value || '20';
            const riferimentoPreventivo = document.getElementById('riferimentoPreventivo').value || numeroPreventivo;

            // Ottieni le percentuali di pagamento
            const percentualePrima = parseFloat(document.getElementById('percentualePrimaPagamento').value) || 0;
            const percentualeSeconda = parseFloat(document.getElementById('percentualeSecondaPagamento').value) || 0;
            const percentualeTerza = parseFloat(document.getElementById('percentualeTerzaPagamento').value) || 0;

            // Note personalizzate
            const notePersonalizzate = (document.getElementById('notePersonalizzate').value || '').replace(/\n/g, '<br>');

            

            // =========== Crea HTML del preventivo ===========
            const dataOdierna = new Date().toLocaleDateString('it-IT');

            // Crea una variabile per memorizzare il grafico di produzione energetica
            let dettaglioProduzioneHTML = '';

            // Se abbiamo dati PVGIS, usa quelli
            if (pvgisData && pvgisData.outputs && pvgisData.outputs.monthly && pvgisData.outputs.monthly.fixed) {
                const monthlyData = pvgisData.outputs.monthly.fixed;
                const maxProduction = Math.max(...monthlyData.map(m => m.E_m || 0));
                const totalData = pvgisData.outputs.totals.fixed;
                const annualProduction = totalData.E_y ? totalData.E_y.toFixed(0) : Math.round(potenzaTotale * produzioneAnnuaKw);
                
                dettaglioProduzioneHTML = `
                    <div class="details-box">
                        <h3 class="details-heading">Produzione Energetica Stimata (PVGIS)</h3>
                        <div style="height: 320px; position: relative; margin-top: 25px;"> <!-- Aggiunto margin-top: 25px -->
                            <div style="display: flex; height: 250px; align-items: flex-end; justify-content: space-between; margin-top: 20px;">
                            ${monthlyData.map((data, i) => {
                                const production = data.E_m || 0;
                                const percentage = (production / maxProduction) * 100;
                                const height = Math.max(5, (percentage * 230) / 100);
                                const mese = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'][i];
                                
                                return `
                                <div style="display: flex; flex-direction: column; align-items: center; width: 30px;">
                                <div style="height: ${height}px; width: 25px; background-color: var(--accent-color); border-radius: 2px 2px 0 0;" title="${production.toFixed(0)} kWh"></div>
                                <div style="margin-top: 5px; font-size: 12px;">${mese}</div>
                                <div style="font-size: 10px; margin-top: 2px; color: #666;">${production.toFixed(0)}</div>
                                </div>`;
                            }).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #666; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 4px;">
                            Produzione annuale stimata: ${annualProduction} kWh (dati PVGIS)
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Nascondi il grafico
                dettaglioProduzioneHTML = ``;
            }

            // Recupera il contenuto della premessa
            const premessaPersonalizzata = (document.getElementById('premessaPersonalizzata').value || '').replace(/\n/g, '<br>');

            // Recupera i costi
            const costiFinali = {
                moduli: valoriDefault.costoModuli * (1 + margine),
                morsetti: valoriDefault.costoMorsetti * (1 + margine),
                guide: valoriDefault.costoGuide * (1 + margine),
                staffe: valoriDefault.costoStaffe * (1 + margine),
                prolunghe: valoriDefault.costoProlunghe * (1 + margine),
                inverter: valoriDefault.costoInverter * (1 + margine),
                batterie: valoriDefault.costoBatterie * (1 + margine),
                mezzi: valoriDefault.costoMezzi * (1 + margine),
                quadri: valoriDefault.costoQuadri * (1 + margine),
                caviDC: valoriDefault.costoCavi * (1 + margine),
                caviAC: valoriDefault.costoCaviCA * (1 + margine), 
                fresia: valoriDefault.costoFresia * (1 + margine),
                sicurezza: valoriDefault.costoSicurezza * (1 + margine),
                manodopera: valoriDefault.costoManodoperaTotale * (1 + margine)
            };

            let preventivoHTML = `
            <!DOCTYPE html>
            <html lang="it">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Preventivo Impianto Fotovoltaico - ${nomeCognomeCliente}</title>
                <style>
                    :root {
                        --primary-color: #0F3460; /* Blu più professionale */
                        --secondary-color: #2E8B57; /* Verde più elegante */
                        --accent-color: #E6B31E; /* Giallo per elementi di risalto */
                        --light-bg: #f8f9fa; /* Sfondo chiaro più gradevole */
                    }
                    
                    body {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        line-height: 1.6;
                        color: var(--text-color);
                        max-width: 1000px;
                        margin: 0 auto;
                        padding: 20px;
                        background-color: #fff;
                    }
                    
                    .header {
                        background: linear-gradient(135deg, #0F3460, #243b55);
                        color: white;
                        border-radius: 12px;
                        padding: 30px;
                        margin-bottom: 40px;
                        box-shadow: 0 10px 15px rgba(15, 52, 96, 0.1);
                        border: none;
                    }
                    
                    .logo-container {
                        flex: 0 0 40%;
                    }
                    
                    .logo {
                        max-width: 250px;
                        height: auto;
                        color: white;
                    }
                    
                    .header-info {
                        flex: 0 0 55%;
                        text-align: right;
                    }
                    
                    .doc-title {
                        color: white;
                        font-weight: 700;
                    }
                    
                    .doc-subtitle {
                        color: rgba(255, 255, 255, 0.8);
                    }
                    
                    .cliente-info, .impianto-info, .riepilogo {
                        margin-bottom: 30px;
                        padding: 25px;
                        background-color: var(--light-gray);
                        border-radius: 8px;
                        box-shadow: var(--box-shadow);
                        border-left: 4px solid var(--primary-color);
                    }

                    .client-box, .tech-box {
                        transition: all 0.3s ease;
                        border-left: 4px solid var(--primary-color);
                        position: relative;
                    }

                    .client-box:hover, .tech-box:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 10px 15px rgba(15, 52, 96, 0.1);
                    }

                    .info-label {
                        color: #718096;
                        font-size: 16px;
                        margin-bottom: 4px;
                    }

                    .info-value {
                        font-weight: 600;
                        font-size: 16px;
                        color: #2D3748;
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                    }

                    .info-value svg {
                        width: 18px;
                        height: 18px;
                        margin-right: 8px;
                        fill: var(--primary-color);
                    }

                    .stats-container {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 15px;
                        justify-content: space-between;
                        margin-top: 15px;
                    }

                    .stat-item {
                        flex: 1 1 40%;
                        background-color: #f8fafc;
                        border-radius: 8px;
                        padding: 15px;
                        text-align: center;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    }

                    .stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: var(--primary-color);
                        margin-bottom: 5px;
                    }

                    .stat-label {
                        font-size: 12px;
                        color: #718096;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .eco-impact {
                        background-color: #f0f9ff;
                        border-radius: 8px;
                        padding: 15px;
                        margin-top: 20px;
                        border-left: 4px solid var(--secondary-color);
                    }

                    .eco-title {
                        font-weight: 600;
                        color: var(--secondary-color);
                        margin-bottom: 10px;
                        display: flex;
                        align-items: center;
                    }

                    .eco-title svg {
                        width: 18px;
                        height: 18px;
                        margin-right: 8px;
                    }

                    .eco-stats {
                        display: flex;
                        justify-content: space-around;
                        text-align: center;
                    }

                    .eco-stat {
                        flex: 1;
                    }

                    .eco-value {
                        font-size: 18px;
                        font-weight: 700;
                        color: var(--secondary-color);
                    }

                    .eco-label {
                        font-size: 12px;
                        color: #718096;
                    }
                    
                    .section-title {
                        font-family: 'Montserrat', sans-serif;
                        letter-spacing: 0.5px;
                        color: var(--primary-color);
                        border-bottom: 2px solid var(--secondary-color);
                        padding-bottom: 10px;
                        margin-bottom: 20px;
                        font-size: 20px;
                        display: flex;
                        align-items: center;
                        padding-left: 10px;
                    }
                    
                    .section-title::before {
                        content: "";
                        display: inline-block;
                        width: 18px;
                        height: 18px;
                        background-color: var(--secondary-color);
                        margin-right: 10px;
                        border-radius: 50%;
                    }
                    
                    .section-content {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                    }
                    
                    .info-item {
                        margin-bottom: 15px;
                    }
                    
                    .info-item strong {
                        color: var(--primary-color);
                    }
                    
                    table {
                        border-collapse: separate;
                        border-spacing: 0;
                        width: 100%;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 1px 3px rgba(15, 52, 96, 0.1);
                    }

                    th {
                        background-color: #0F3460;
                        color: white;
                        font-weight: 500;
                        text-transform: uppercase;
                        font-size: 18px;
                        letter-spacing: 1px;
                        padding: 14px 16px;
                        text-align: center;
                    }

                    td {
                        padding: 12px 16px;
                        border-bottom: 1px solid #edf2f7;
                        text-align: center;
                        font-size: 16px;
                    }

                    td:first-child {
                        text-align: left !important;
                    }
                    
                    tr:last-child td {
                        border-bottom: none;
                    }

                    tr:hover td {
                        background-color: rgba(46, 139, 87, 0.05);
                    }
                    
                    .total-row {
                        font-weight: bold;
                        background-color: #eef2ff !important;
                        border-top: 2px solid var(--primary-color);
                    }

                    .energy-chart-bar {
                        background: linear-gradient(to top, #2E8B57, #5dc990);
                        border-radius: 4px 4px 0 0;
                        position: relative;
                    }

                    .energy-chart-bar:hover::after {
                        content: attr(data-value) "kWh";
                        position: absolute;
                        top: -30px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #0F3460;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        white-space: nowrap;
                    }
                    
                    .price {
                        text-align: right;
                        font-weight: 500;
                    }
                    
                    .final-price-container {
                        background: linear-gradient(135deg, #0F3460, #243b55);
                        color: white;
                        border-radius: 12px;
                        padding: 30px;
                        margin-top: 40px;
                        text-align: right;
                        position: relative;
                        overflow: hidden;
                    }

                    .final-price-container::before {
                        content: "";
                        position: absolute;
                        top: -50%;
                        left: -50%;
                        width: 200%;
                        height: 200%;
                        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
                        opacity: 0.6;
                    }

                    .final-price-label {
                        font-size: 16px;
                        color: rgba(255, 255, 255, 0.9);
                        margin-bottom: 10px;
                    }

                    .final-price {
                        font-size: 36px;
                        font-weight: 700;
                        color: white;
                        letter-spacing: -0.5px;
                    }
                    
                    .note-container {
                        margin-top: 40px;
                        padding: 20px;
                        background-color: #fffde7;
                        border-radius: 8px;
                        border-left: 4px solid #f9a825;
                    }
                    
                    .note-title {
                        color: #f57f17;
                        margin-top: 0;
                        display: flex;
                        align-items: center;
                    }
                    
                    .note-title::before {
                        content: "!";
                        display: inline-block;
                        width: 20px;
                        height: 20px;
                        line-height: 20px;
                        text-align: center;
                        background-color: #f57f17;
                        color: white;
                        border-radius: 50%;
                        margin-right: 10px;
                        font-weight: bold;
                    }
                    
                    .note-list {
                        margin-top: 15px;
                        padding-left: 20px;
                    }
                    
                    .note-list li {
                        margin-bottom: 8px;
                        position: relative;
                    }
                    
                    .note-list li::marker {
                        color: #f57f17;
                    }
                    
                    .footer {
                        background-color: #0F3460;
                        border-radius: 12px;
                        padding: 30px;
                        margin-top: 40px;
                        box-shadow: 0 -2px 10px rgba(15, 52, 96, 0.05);
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    }
                    
                    .footer-logo {
                        max-width: 150px;
                    }
                    
                    .footer-text {
                        text-align: right;
                        color: white;
                        font-size: 0.9em;
                        display: flex;
                        flex-direction: column;
                        align-items: flex-end;
                    }
                    
                    .contact-info {
                        text-align: right;
                        margin-top: 15px;
                        font-size: 0.9em;
                        display: flex;
                        justify-content: flex-end;
                        flex-wrap: wrap;
                        width: 100%;
                        padding-left: 20%;
                    }
                    
                    .contact-item {
                        text-align: right;
                        background-color: rgba(15, 52, 96, 0.05);
                        padding: 8px 12px;
                        border-radius: 50px;
                        margin-right: 10px;
                        display: inline-flex;
                        align-items: center;
                    }
                    
                    .contact-item svg {
                        width: 16px;
                        height: 16px;
                        margin-right: 5px;
                        fill: var(--primary-color);
                    }

                    ul, ol {
                        padding-left: 40px;
                    }

                    @media print {
                        @page {
                            margin: 20mm 16mm;  /* Margini superiore/inferiore e sinistro/destro */
                            size: A4;          /* Dimensione pagina standard */
                            @bottom-center {
                                content: "SoleFacile S.r.l. - P.IVA IT 09557480010 - Via Nizza 108, 10126 Torino | Tel: +39 3200103380";
                                color: white;
                                background-color: #0F3460;
                                padding: 5mm;
                                border-radius: 2mm;
                                margin-bottom: 25mm;
                                font-size: 10pt;
                            }
                        }

                        @page:last {
                            @bottom-center {
                                content: "";
                            }
                        }

                        body {
                            padding: 0;
                            margin: 0;
                            font-size: 14px;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                        }
                        
                        .no-print {
                            display: none;
                        }
                        
                        .header, .footer {
                            padding: 15px 5px;
                            width: 100%;
                            box-sizing: border-box;
                            background: linear-gradient(135deg, #0F3460, #243b55) !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 15px 20px !important;  /* Riduci il padding ma mantieni spazio */
                            margin-bottom: 20px !important;
                        }

                        .header-info {
                            font-size: 14px
                        }

                        .logo-container {
                            flex: 0 0 40%;
                        }

                        .logo {
                            max-width: 180px !important;
                        }

                        .doc-title {
                            font-size: 18px;     /* Riduci le dimensioni del titolo */
                        }
                        
                        .cliente-info, .impianto-info, .riepilogo, .note-container {
                            padding: 15px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                            border-left: 4px solid var(--primary-color) !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        .client-box, .tech-box, .details-box, .eco-impact, .stat-item {
                            background: white !important; /* Usa colore solido invece di trasparente */
                            background-color: white !important;
                            box-shadow: none !important; /* Rimuovi le ombre durante la stampa */
                            border: 1px solid #e2e8f0 !important; /* Aggiungi un sottile bordo per la delimitazione */
                        }

                        .eco-impact {
                            background: #f0f9ff !important;
                            background-color: #f0f9ff !important;
                        }

                        .stat-item {
                            background: #f8fafc !important;
                            background-color: #f8fafc !important;
                        }

                        .footer {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                            position: bottom;
                            background: #0F3460 !important;
                            border-radius: 12px;
                            padding: 30px;
                            width: 100%;
                            box-sizing: border-box;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        .footer-text {
                            text-align: right;
                            color: white;
                            font-size: 0.9em;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }

                        .footer-logo {
                            max-width: 130px;
                        }

                        .contact-info {
                            text-align: right;
                            margin-top: 15px;
                            font-size: 0.9em;
                            display: flex;
                            justify-content: flex-end;
                            flex-wrap: wrap;
                            width: 100%;
                            padding-left: 20%;
                        }

                        .contact-item {
                            background: transparent !important;
                            text-align: right;
                            padding: 6px 10px;
                            margin-right: 5px;
                            font-size: 12px;
                        }
                        
                        .contact-item svg {
                            width: 10px;
                            height: 10px;
                        }

                        .two-columns {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px;
                            page-break-inside: avoid;
                            break-inside: avoid;
                        }

                        .section-title, .info-label, .info-value {
                            font-size: 16;
                            margin-bottom: initial;
                        }
                        
                        table {
                            font-size: 16px;
                            background-color: transparent !important;
                        }
                        
                        th {
                            background-color: #0F3460 !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            forced-color-adjust: none !important;
                            text-align: center;
                            font-size: 18px;
                        }
                        
                        td {
                            font-size: 16px;
                            padding: 8px;
                        }

                        th, td {
                            background-color: transparent !important;
                            print-color-adjust: exact !important;
                            text-align: center;
                        }
                        
                        .details-box {
                            font-size: 14px;
                            page-break-inside: avoid;
                            background: transparent !important;
                            background-color: transparent !important;
                        }

                        .two-columns div:last-child > div:last-child {
                            border-color: var(--secondary-color) !important;
                            print-color-adjust: exact !important;
                            -webkit-print-color-adjust: exact !important;
                        }

                        .details-box:nth-of-type(2) .two-columns > div:first-child {
                            background-color: transparent !important;
                        }

                        .details-box:nth-of-type(2) .two-columns table {
                            background: none !important;
                            box-shadow: none !important;
                        }

                        .details-box table th {
                            background-color: #0F3460 !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            padding: 8px !important;
                        }
                        
                        .details-box table {
                            background-color: transparent !important;
                            box-shadow: none !important;
                        }

                        .details-box table tbody tr {
                            background-color: transparent !important;
                        }

                        .details-box table tbody td {
                            background-color: transparent !important;
                        }

                        .details-box, .details-box > div {
                            background-color: transparent !important;
                        }
                            
                        .details-heading {
                            background-color: #f8f9fc !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        .final-price-container {
                            background: linear-gradient(135deg, #0F3460, #243b55);
                            color: white;
                            border-radius: 12px;
                            padding: 30px;
                            margin-top: 40px;
                            text-align: right;
                            position: relative;
                            overflow: hidden;
                            page-break-inside: avoid;
                            break-inside: avoid;
                        }
                        
                        .energy-chart-bar {
                            background-color: var(--accent-color) !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        .note-container {
                            background-color: #fffde7 !important;
                            border-left: 4px solid #f9a825 !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        .note-list li {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }

                        .note-list li ul {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }

                        .note-list li ul.inner-list {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                            margin-top: 5px;
                        }

                        /* Questa regola mantiene insieme ciascun elemento principale della lista con i suoi sottoelementi */
                        .note-list > li {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                            margin-bottom: 15px;
                        }

                        .highlight-row {
                            font-size: 12px;
                            background-color: #f0f9ff !important;
                        }

                        .badge {
                            padding: 5px 12px;
                            border-radius: 50px;
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            display: inline-flex;
                            align-items: center;
                            margin-left: 10px;
                        }
                        
                        .badge-primary {
                            background-color: #0F3460 !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        .badge-eco {
                            background-color: #2E8B57 !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        .badge-accent {
                            background-color: #E6B31E !important;
                            color: #2D3748 !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        .badge svg {
                            width: 12px;
                            height: 12px;
                            margin-right: 4px;
                        }

                        .signature-area {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                            display: block !important;
                            margin-top: 60px !important;
                            padding-top: 40px !important;
                        }

                        .signature-box {
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }

                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                        }

                        /* Fix specifico per il grafico PVGIS */
                        [style*="background:"] {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        [style*="background-color:"] {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        [style*="background: linear-gradient"] {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }

                        [style*="background: conic-gradient"] {
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            -webkit-print-color-adjust: exact !important;
                            forced-color-adjust: none !important;
                        }

                        .details-box .two-columns div:last-child > div:last-child {
                            background: transparent !important;
                            background-color: transparent !important;
                            page-break-inside: avoid !important;
                        }
                    }
                    
                    .two-columns {
                        display: flex;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                    }

                    .two-columns p {
                        margin-bottom: 15px;
                        display: block;
                    }
                    
                    .badge {
                        padding: 5px 12px;
                        border-radius: 50px;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        display: inline-flex;
                        align-items: center;
                        margin-left: 10px;
                    }
                    
                    .badge-primary {
                        background-color: #0F3460;
                        color: white;
                    }
                    
                    .badge-eco {
                        background-color: #2E8B57;
                        color: white;
                    }

                    .badge-accent {
                        background-color: #E6B31E;
                        color: #2D3748;
                    }

                    .badge svg {
                        width: 12px;
                        height: 12px;
                        margin-right: 4px;
                    }
                    
                    .details-box {
                        border-radius: 12px;
                        box-shadow: 0 4px 6px rgba(15, 52, 96, 0.05), 0 1px 3px rgba(15, 52, 96, 0.1);
                        transition: all 0.2s ease;
                        border: none;
                        overflow: hidden;
                        padding: 20px;
                        margin: 20px 0;
                    }

                    .details-box p {
                        padding-left: 15px;
                        margin: 8px 0;
                    }

                    .details-box:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 10px 15px rgba(15, 52, 96, 0.1);
                    }

                    .details-box .two-columns div {
                        padding: 0 15px;
                    }

                    .details-box .two-columns div:last-child {
                        display: flex;
                        justify-content: center;
                        align-items: center;
                    }

                    .details-box .two-columns p {
                        padding-left: 0;
                        margin-bottom: 15px;
                    }
                    
                    .details-box .two-columns div:last-child > div:last-child {
                        width: 150px;
                        height: 150px;
                        border-radius: 50%;
                        position: relative;
                        margin: 20px auto;
                        box-sizing: border-box;
                    }

                    .details-box .two-columns div:last-child > div:last-child > div {
                        position: absolute;
                        background: white;
                        width: 110px;
                        height: 110px;
                        border-radius: 50%;
                        left: 50%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        flex-direction: column;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        box-sizing: border-box;
                    }

                    .details-heading {
                        background-color: #f8f9fc;
                        margin: -20px -20px 20px -20px;
                        padding: 15px 20px;
                        border-bottom: 1px solid rgba(15, 52, 96, 0.1);
                        padding-left: 20px;
                    }
                    
                    .details-heading svg {
                        width: 16px;
                        height: 16px;
                        margin-right: 5px;
                        fill: var(--primary-color);
                    }

                    .details-box table {
                        margin: 15px auto;
                    }

                    .details-box table td:first-child {
                        padding-left: 20px;
                    }
                    
                    .signature-area {
                        margin-top: 60px;
                        padding-top: 40px;
                        border-top: 1px dashed rgba(15, 52, 96, 0.2);
                        page-break-inside: avoid;
                        break-inside: avoid;
                        display: block;
                    }
                    
                    .signature-box {
                        position: relative;
                        min-height: 100px;
                        border-bottom: 1px solid rgba(15, 52, 96, 0.2);
                        padding-bottom: 15px;
                    }
                        
                    .signature-box::before {
                        content: "";
                        position: absolute;
                        top: -15px;
                        left: 0;
                        font-size: 14px;
                        color: #718096;
                    }

                    .signature-box:first-child::before {
                        content: "Timbro e firma";
                    }

                    .signature-box:last-child::before {
                        content: "Per accettazione";
                        padding-top: 40px;
                    }
                    
                    .signature-label {
                        font-size: 14px;
                        color: #666;
                        margin-top: 10px;
                    }

                    .price-saving {
                        color: var(--secondary-color);
                        font-weight: bold;
                        font-size: 14px;
                    }

                    .highlight-row {
                        font-size: 14px;
                        background-color: #f0f9ff !important;
                    }

                    .comparison-label {
                        font-size: 12px;
                        color: #666;
                        margin-top: 5px;
                        text-align: center;
                    }

                    .energy-saving-badge {
                        display: inline-block;
                        padding: 8px 15px;
                        background-color: var(--secondary-color);
                        color: white;
                        border-radius: 20px;
                        font-weight: bold;
                        margin-top: 15px;
                        text-align: center;
                    }

                    .note-personalizzata {
                        border-top: 1px dashed #f9a825;
                        margin-top: 15px !important;
                        padding-top: 15px !important;
                        font-style: italic;
                        color: #333;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 306.71 153.03" class="logo">
                            <defs><style>.cls-1{fill:#fff;}.cls-2{fill:none;}.cls-3{fill:#60b22f;}.cls-4{fill:#9cc42c;}.cls-5{fill:#bbd02c;}.cls-6{fill:#dadb1a;}.cls-7{fill:#ebe320;}</style></defs>
                            <g id="Livello_2" data-name="Livello 2"><g id="Livello_1-2" data-name="Livello 1">
                                <path class="cls-1" d="M33.34,83.42A72.18,72.18,0,0,1,14.52,81,48.77,48.77,0,0,1,0,74.83L7.35,58.22a51.66,51.66,0,0,0,12.26,5.6A45.55,45.55,0,0,0,33.45,66,28.26,28.26,0,0,0,41,65.23,8.43,8.43,0,0,0,45,63a5.14,5.14,0,0,0,1.29-3.5,4.64,4.64,0,0,0-2.48-4.13,24.64,24.64,0,0,0-6.5-2.6c-2.68-.71-5.57-1.39-8.7-2a86.34,86.34,0,0,1-9.55-2.55A36.22,36.22,0,0,1,10.28,44,19.94,19.94,0,0,1,3.9,37.2,20.64,20.64,0,0,1,1.47,26.69,22.47,22.47,0,0,1,5.32,13.92Q9.15,8.16,17,4.66T36.39,1.15A67.79,67.79,0,0,1,51.71,2.9,45.12,45.12,0,0,1,65,8.16L58.2,24.66A48.24,48.24,0,0,0,47,20a41.77,41.77,0,0,0-10.74-1.47,22.49,22.49,0,0,0-7.46,1,9,9,0,0,0-4.06,2.6,5.4,5.4,0,0,0-1.24,3.39A4.75,4.75,0,0,0,26,29.8a22.51,22.51,0,0,0,6.45,2.48q3.95,1,8.75,2a96.06,96.06,0,0,1,9.55,2.53,38.78,38.78,0,0,1,8.76,4.07A20.13,20.13,0,0,1,66,47.54a19.82,19.82,0,0,1,2.49,10.34,22.46,22.46,0,0,1-3.9,12.72,26.79,26.79,0,0,1-11.7,9.32C47.7,82.26,41.17,83.42,33.34,83.42Z"/><path class="cls-1" d="M174.37,81.84V2.73h22.38V64.1h37.63V81.84Z"/><polygon class="cls-1" points="265.35 64.44 265.35 49.97 300.49 49.97 300.49 33.36 265.35 33.36 265.35 20.14 305.24 20.14 305.24 2.73 243.3 2.73 243.3 81.84 306.71 81.84 306.71 64.44 265.35 64.44"/><polygon class="cls-1" points="46.19 105.84 46.19 92.86 0 92.86 0 151.85 16.69 151.85 16.69 131.63 42.65 131.63 42.65 118.73 16.69 118.73 16.69 105.84 46.19 105.84"/><path class="cls-1" d="M95.92,151.86h17.36l-26.13-59H70.72l-26,59h17l4.63-11.55h25ZM71.24,128.09l7.57-18.86,7.57,18.86Z"/><path class="cls-1" d="M146.58,153a36.11,36.11,0,0,1-12.9-2.23,31.22,31.22,0,0,1-10.29-6.32,28.77,28.77,0,0,1-6.82-9.73,32.68,32.68,0,0,1,0-24.78,28.81,28.81,0,0,1,6.82-9.74,31.22,31.22,0,0,1,10.29-6.32,38.89,38.89,0,0,1,27.52.59,27.42,27.42,0,0,1,10.74,8.3l-10.62,9.61a20.73,20.73,0,0,0-6.32-5.14,16.37,16.37,0,0,0-7.58-1.77,18.13,18.13,0,0,0-6.66,1.18,14.4,14.4,0,0,0-5.18,3.41,16,16,0,0,0-3.37,5.35,20.05,20.05,0,0,0,0,13.83,15.88,15.88,0,0,0,3.37,5.35,14.14,14.14,0,0,0,5.18,3.41,18.13,18.13,0,0,0,6.66,1.18,16.37,16.37,0,0,0,7.58-1.77,20.32,20.32,0,0,0,6.32-5.22l10.62,9.6a27.73,27.73,0,0,1-10.74,8.35A35.68,35.68,0,0,1,146.58,153Z"/><path class="cls-1" d="M179.44,151.86v-59h16.69v59Z"/><path class="cls-1" d="M208,151.86v-59H224.7v45.76h28.07v13.24Z"/><polygon class="cls-1" points="275.86 138.88 275.86 128.09 302.07 128.09 302.07 115.7 275.86 115.7 275.86 105.84 305.61 105.84 305.61 92.86 259.42 92.86 259.42 151.85 306.71 151.85 306.71 138.88 275.86 138.88"/><path class="cls-2" d="M118.55,83.42a48.93,48.93,0,0,1-17.47-3,41,41,0,0,1-14-8.65A40,40,0,0,1,74.59,42.18,39.47,39.47,0,0,1,77.92,25.9,40.74,40.74,0,0,1,101,4.2a51.82,51.82,0,0,1,35,0A41.59,41.59,0,0,1,150,12.79a40.17,40.17,0,0,1,9.21,13,39.57,39.57,0,0,1,3.34,16.39,41.22,41.22,0,0,1-3.27,16.55A39.11,39.11,0,0,1,150,71.78a41.93,41.93,0,0,1-14,8.59A48.69,48.69,0,0,1,118.55,83.42Z"/><path class="cls-1" d="M159.79,25a40.58,40.58,0,0,0-9.35-13.19A42,42,0,0,0,136.32,3.1a52.54,52.54,0,0,0-35.56,0,41.38,41.38,0,0,0-23.46,22,40.14,40.14,0,0,0-3.38,16.52,40.82,40.82,0,0,0,3.38,16.7,41.18,41.18,0,0,0,23.52,22.08,52.37,52.37,0,0,0,35.5,0A42.71,42.71,0,0,0,150.5,71.7a39.64,39.64,0,0,0,9.35-13.25,41.55,41.55,0,0,0,3.33-16.81A40.24,40.24,0,0,0,159.79,25Z"/><path class="cls-3" d="M146,22.77c0,.81.07,1.63.07,2.46a41.07,41.07,0,0,1-3.28,16.56,39.08,39.08,0,0,1-9.21,13.05,42,42,0,0,1-14,8.59,48.76,48.76,0,0,1-17.51,3.05c-1.82,0-3.6-.09-5.34-.26-.46-.35-.92-.71-1.36-1.07a31.47,31.47,0,0,0,9.17,5.27,41.85,41.85,0,0,0,27.91,0,32.15,32.15,0,0,0,10.68-6.54,28.93,28.93,0,0,0,6.85-9.72,30.85,30.85,0,0,0,2.43-12.53A29.36,29.36,0,0,0,150,29.37,30.21,30.21,0,0,0,146,22.77Z"/><path class="cls-4" d="M102.14,66.48a48.76,48.76,0,0,0,17.51-3.05,42,42,0,0,0,14-8.59,39.08,39.08,0,0,0,9.21-13.05,41.07,41.07,0,0,0,3.28-16.56c0-.83,0-1.65-.07-2.46h0c-.4-.5-.82-1-1.25-1.46L144.5,21c-.45-.48-.91-1-1.39-1.41-.75-.7-1.52-1.36-2.33-2a30.92,30.92,0,0,0-3.87-2.51c-.66-.37-1.35-.7-2-1,.62.29,1.24.59,1.83.91,0,.29,0,.57,0,.86a41,41,0,0,1-3.27,16.55,39.25,39.25,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48.9,48.9,0,0,1-17.51,3c-1.42,0-2.81-.05-4.19-.16-.26-.46-.52-.93-.76-1.41a30.75,30.75,0,0,0,3.17,5,28.22,28.22,0,0,0,2,2.28c.36.37.72.73,1.09,1.09h0c.43.41.88.8,1.33,1.18l.08.07c.44.36.9.72,1.36,1.07C98.54,66.39,100.32,66.48,102.14,66.48Z"/><path class="cls-5" d="M87.8,55.52c.24.48.5.95.76,1.41,1.38.11,2.77.16,4.19.16a48.9,48.9,0,0,0,17.51-3,42.26,42.26,0,0,0,14-8.59,39.25,39.25,0,0,0,9.22-13.06,41,41,0,0,0,3.27-16.55c0-.29,0-.57,0-.86-.59-.32-1.21-.62-1.83-.91l-.37-.17c-.64-.28-1.29-.56-2-.82h0c-.52-.2-1.05-.38-1.59-.56-1.08-.35-2.19-.65-3.32-.9l-.57-.11a39.52,39.52,0,0,1-3,11.49,38.91,38.91,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48,48,0,0,1-15.72,3c0,.15,0,.31.08.47A27.85,27.85,0,0,0,87.08,54c.23.51.46,1,.71,1.49Z"/><path class="cls-6" d="M85.15,47.67a48,48,0,0,0,15.72-3,42.26,42.26,0,0,0,14-8.59A38.91,38.91,0,0,0,124.05,23a39.52,39.52,0,0,0,3-11.49h0c-.64-.13-1.29-.24-1.94-.34l-.21,0c-.58-.08-1.17-.16-1.76-.22l-.37,0c-.55-.05-1.1-.09-1.66-.12l-.46,0c-.68,0-1.38-.05-2.08-.05h0c-1,0-1.88,0-2.81.09-.32,1-.68,1.91-1.08,2.83a38.91,38.91,0,0,1-9.22,13.06,42.16,42.16,0,0,1-14,8.59,45.69,45.69,0,0,1-6.57,1.93,33.57,33.57,0,0,0-.29,4.44c0,.54,0,1.08,0,1.6s0,.85.08,1.26c0,.09,0,.17,0,.25.09,1,.22,2,.4,2.92Z"/><path class="cls-7" d="M105.44,26.68a38.91,38.91,0,0,0,9.22-13.06c.4-.92.76-1.87,1.08-2.83h0a42,42,0,0,0-5.72.74l-.15,0c-.86.18-1.69.39-2.52.62l-.4.12c-.81.24-1.61.5-2.39.79h0A30.88,30.88,0,0,0,94,19.62a29.91,29.91,0,0,0-4.8,5.83c-.42.65-.8,1.33-1.17,2s-.69,1.33-1,2-.47,1.12-.68,1.69c0,.14-.09.28-.14.42-.17.47-.32.95-.46,1.43l-.09.33a28.07,28.07,0,0,0-.78,3.84h0a45.69,45.69,0,0,0,6.57-1.93A42.16,42.16,0,0,0,105.44,26.68Z"/>
                            </g></g>
                        </svg>
                    </div>
                    <div class="header-info">
                        <h1 class="doc-title">Preventivo Impianto Fotovoltaico</h1>
                        <p><strong>Riferimento:</strong> ${riferimentoPreventivo}</p>
                        <p><strong>Data:</strong> ${dataOdierna}</p>
                        <p><strong>Validità:</strong> ${validitaPreventivo} giorni</p>
                    </div>
                </div>

                <div class="two-columns">
                    <div class="cliente-info client-box">
                        <h2 class="section-title">Informazioni Cliente</h2>
                        <div class="section-content">
                            <div>
                                <p class="info-label">Cliente</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                    ${nomeCognomeCliente}
                                </p>
                                
                                <p class="info-label">Indirizzo impianto</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    ${indirizzoImpianto}
                                </p>
                            </div>
                            <div>
                                <p class="info-label">Tipologia</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                    </svg>
                                    Impianto Residenziale 
                                    <span class="badge badge-eco">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="fill: white;"">
                                            <path d="M16.43 12.1c-.18-.48-.38-.9-.61-1.31.19-.34.31-.65.39-.87h3.79c-.29 1.57-1.63 4.64-3.57 2.18zm-1.55-3.15c-.3-.25-.86-.43-1.31-.43 0 0-1.27 0-2.24.9l-.03-.35c0-.88.7-1.07 1.01-1.07l1.94.02c.28-.45.87-1.38.87-1.38.26-.45.33-1.21.33-1.21-.34 0-1.26-.52-3.06-.52-2.67 0-4.84 1.45-4.84 3.35l.01.09c-.38.96-.57 1.96-.57 2.95 0 1.06.23 2.06.63 2.98-.46.17-.89.39-1.28.64-.27.7-.74.28-.97.05 0 0-.04-.04-.07-.08-.55-.72-1.93-2.42-1.93-3.23 0-.96.6-1.59 1.32-2.05-1.19.26-2.3.89-3.19 1.42 0 0-.09.09-.13.12-.23.23-.53.37-.85.37s-.6-.12-.31-.61c.21-.36 1.24-1.63 3.99-2.36.3-.96.98-1.86 1.92-2.61-1.96.19-3.9.99-5.48 2.35 0 .04-.08.06-.11.11-.23.38-.55.69-.91.92C.3 11.9.12 12.13.12 11.95c0-.17.09-.52.25-.79.65-.95 2.43-2.8 6.13-3.54C3.92 6.53 1.66 7.52.7 9.21c0 0-.05.05-.08.08-.22.22-.53.48-.73.48-.11 0-.16-.04-.16-.19 0-.23.28-.82.72-1.25.51-.5 2.03-1.86 5.28-2.85C4.18 4.52 2.47 4.13.96 4c-.36.03-.47-.21-.39-.38 0 0 .03-.09.14-.17.22-.17.86-.38 1.64-.38h.02c1.38 0 3.97.51 5.79 2.04l.01-.01c1.06-2 3.27-3.29 5.66-3.1-1.92-1.3-4.04-2-6.08-2 .78.01.4-.24.19-.43 0 0-.06-.08-.12-.15-.28-.36-.97-.85-1.31-1.07.35-.06.74-.09 1.17-.09 1.94 0 5.35.88 7.15 3.82.5-.23 1.05-.4 1.64-.49-2.69-2.72-5.8-4.44-8.15-4.44.61.03.27-.46-.02-.73C8.23.43 7.95 0 7.95 0c.95.12 2.08.46 3.33 1.05C16.28 3.27 19.96 7.6 20 12.91v.02c-.08 5.35-3.79 9.93-8.65 12.28 5.92-2.04 10.15-7.67 10.15-14.26 0-.23-.02-.45-.03-.68h-3.71c.19-.58.49-1.52.7-2.61-1.04.36-3.18.71-3.58-.71z"/>
                                        </svg>
                                        ECO
                                    </span>
                                </p>
                                
                                <p class="info-label">Consulente</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>
                                    </svg>
                                    Debasis
                                </p>
                            </div>
                        </div>
                        
                        <div class="stats-container">
                            <div class="stat-item">
                                <div class="stat-value">${riferimentoPreventivo}</div>
                                <div class="stat-label">Riferimento</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${validitaPreventivo} giorni</div>
                                <div class="stat-label">Validità Offerta</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="impianto-info tech-box">
                        <h2 class="section-title">Dati Tecnici</h2>
                        <div class="section-content">
                            <div>
                                <p class="info-label">Potenza totale</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
                                    </svg>
                                    ${potenzaTotale.toFixed(2)} kWp
                                </p>
                                
                                <p class="info-label">Produzione stimata</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                                    </svg>
                                    ${Math.round(potenzaTotale * produzioneAnnuaKw)} kWh/anno
                                </p>
                            </div>
                            <div>
                                <p class="info-label">CO₂ evitata</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15 11V5l-3-3-3 3v2H3v14h18V11h-6zm-8 8H5v-2h2v2zm0-4H5v-2h2v2zm0-4H5V9h2v2zm6 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2zm6 12h-2v-2h2v2zm0-4h-2v-2h2v2z"/>
                                    </svg>
                                    ${Math.round(potenzaTotale * produzioneAnnuaKw * 0.5)} kg/anno
                                </p>
                                
                                <p class="info-label">Classe energetica</p>
                                <p class="info-value">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                                    </svg>
                                    A+
                                </p>
                            </div>
                        </div>
                        
                        <div class="eco-impact">
                            <p class="eco-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 22c4.97 0 9-4.03 9-9-4.97 0-9 4.03-9 9zM5.6 10.25c0 1.38 1.12 2.5 2.5 2.5.53 0 1.01-.16 1.42-.44l-.02.19c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5l-.02-.19c.4.28.89.44 1.42.44 1.38 0 2.5-1.12 2.5-2.5 0-1-.59-1.85-1.43-2.25.84-.4 1.43-1.25 1.43-2.25 0-1.38-1.12-2.5-2.5-2.5-.53 0-1.01.16-1.42.44l.02-.19C14.5 2.12 13.38 1 12 1S9.5 2.12 9.5 3.5l.02.19c-.4-.28-.89-.44-1.42-.44-1.38 0-2.5 1.12-2.5 2.5 0 1 .59 1.85 1.43 2.25-.84.4-1.43 1.25-1.43 2.25zM12 5.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5S9.5 9.38 9.5 8s1.12-2.5 2.5-2.5zM3 13c0 4.97 4.03 9 9 9 0-4.97-4.03-9-9-9z"/>
                                </svg>
                                Impatto Ambientale
                            </p>
                            <div class="eco-stats">
                                <div class="eco-stat">
                                    <div class="eco-value">${Math.round(potenzaTotale * produzioneAnnuaKw * 0.5 / 1000)}</div>
                                    <div class="eco-label">Tonnellate CO₂ risparmiate</div>
                                </div>
                                <div class="eco-stat">
                                    <div class="eco-value">${Math.round(potenzaTotale * 7)}</div>
                                    <div class="eco-label">Alberi equivalenti</div>
                                </div>
                                <div class="eco-stat">
                                    <div class="eco-value">${Math.round(potenzaTotale * produzioneAnnuaKw / 50)}</div>
                                    <div class="eco-label">Viaggi in auto risparmiati</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Premessa -->
                <div class="details-box" style="margin-top: 30px; margin-bottom: 30px;">
                    <h3 class="details-heading">Premessa</h3>
                    <div style="padding: 20px;">
                        ${premessaPersonalizzata || `Gentile ${nomeCognomeCliente},<br>

                Siamo lieti di presentarLe la nostra proposta tecnico-economica per la realizzazione di un impianto fotovoltaico presso la Sua proprietà ubicata in ${indirizzoImpianto}.<br><br>

                Questa offerta è il risultato di un'attenta analisi delle caratteristiche strutturali dell'edificio, dell'esposizione solare del sito e delle Sue specifiche esigenze energetiche, con l'obiettivo di massimizzare l'efficienza produttiva e il ritorno economico dell'investimento.<br><br>

                L'impianto proposto è stato progettato utilizzando componenti di alta qualità e tecnologie all'avanguardia nel settore delle energie rinnovabili, garantendo prestazioni ottimali e durature nel tempo.<br><br>

                SoleFacile S.r.l., forte della propria esperienza pluriennale nel settore, si impegna a fornire un servizio completo che include progettazione, installazione, pratiche burocratiche e assistenza post-vendita, assicurandoLe un percorso semplice e trasparente verso la transizione energetica.<br><br>

                Di seguito troverà il dettaglio della nostra offerta, comprensivo delle specifiche tecniche dell'impianto, dei costi e dei benefici economici ed ambientali dell'investimento.
                        `}
                    </div>
                </div>

                <div class="impianto-info">
                    <h2 class="section-title">Configurazione Impianto</h2>
                    
                    <div class="details-box">
                        <h3 class="details-heading">
                            Moduli Fotovoltaici
                        </h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Falda</th>
                                    <th>Modulo</th>
                                    <th>Totale moduli</th>
                                    <th>Potenza</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${faldeData.map(falda => `
                                    <tr>
                                        <td>${falda.nome}</td>
                                        <td>${falda.modulo}</td>
                                        <td>${falda.totaleModuli}</td>
                                        <td>${falda.potenza}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="details-box">
                        <h3 class="details-heading">
                            Produzione Energetica Stimata
                        </h3>
                        <div style="height: 200px; position: relative;">
                            <!-- Simulazione grafico di produzione mensile -->
                            <div style="display: flex; height: 150px; align-items: flex-end; justify-content: space-between; margin-top: 20px;">
                                ${['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'].map((mese, i) => {
                                    // Simulazione valori più alti in estate e più bassi in inverno
                                    const altezza = [40, 50, 70, 80, 90, 100, 100, 95, 80, 60, 45, 35][i];
                                    return `
                                    <div style="display: flex; flex-direction: column; align-items: center; width: 30px;">
                                        <div style="height: ${altezza}px; width: 20px; background-color: var(--primary-color); border-radius: 2px 2px 0 0;"></div>
                                        <div style="margin-top: 5px; font-size: 10px;">${mese}</div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    ${invertersData.length > 0 ? `
                    <div class="details-box">
                        <h3 class="details-heading">
                            Inverter
                        </h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Modello</th>
                                    <th>Stringhe</th>
                                    <th>Quantità</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invertersData.map(inv => `
                                    <tr>
                                        <td>${inv.nome}</td>
                                        <td>${inv.stringhe}</td>
                                        <td>${inv.quantita}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    ${batterieData.length > 0 ? `
                    <div class="details-box">
                        <h3 class="details-heading">
                            Sistema di Accumulo
                        </h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Modello</th>
                                    <th>Quantità</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${batterieData.map(batt => `
                                    <tr>
                                        <td>${batt.nome}</td>
                                        <td>${batt.quantita}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    ${accessoriData.length > 0 ? `
                    <div class="details-box">
                        <h3 class="details-heading">
                            Accessori e Componenti
                        </h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrizione</th>
                                    <th>Quantità</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accessoriData.map(acc => `
                                    <tr>
                                        <td>${acc.nome}</td>
                                        <td>${acc.quantita}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                </div>

                <div class="riepilogo">
                    <h2 class="section-title">Riepilogo</h2>
                    <div class="details-box">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Componente</th>
                                    <th style="text-align: right;">Quantità</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Moduli Fotovoltaici -->
                                <tr>
                                    <td>Moduli Fotovoltaici</td>
                                    <td style="text-align: right;">${faldeData.reduce((acc, falda) => acc + parseInt(falda.totaleModuli), 0)}</td>
                                </tr>

                                <!-- Guide -->
                                <tr>
                                    <td>Guide di Montaggio</td>
                                    <td style="text-align: right;">${tipoTetto === 'lamiera' ? guideTotali || 0 : guideTotali || 0}</td>
                                </tr>

                                ${tipoTetto === 'tegole' ? `
                                <tr>
                                    <td>Staffe per Tegole</td>
                                    <td style="text-align: right;">${staffeTotali || 0}</td>
                                </tr>
                                <tr>
                                    <td>Prolunghe Guide</td>
                                    <td style="text-align: right;">${prolungheTotali || 0}</td>
                                </tr>` : ''}

                                ${invertersData.map((inv, index) => `
                                <tr>
                                    <td>Inverter ${inv.nome.replace(/\s*\(€[\d,.]+\/cad\)$/, '')}</td>
                                    <td style="text-align: right;">${inv.quantita}</td>
                                </tr>`).join('')}

                                ${batterieData.map((batt, index) => `
                                <tr>
                                    <td>Batteria ${batt.nome.replace(/\s*\(€[\d,.]+\/cad\)$/, '')}</td>
                                    <td style="text-align: right;">${batt.quantita}</td>
                                </tr>`).join('')}

                                <!-- Quadri Elettrici -->
                                <tr>
                                    <td>Quadri Elettrici</td>
                                    <td style="text-align: right;">Inclusi</td>
                                </tr>

                                <!-- Cavi DC -->
                                <tr>
                                    <td>Cavi DC</td>
                                    <td style="text-align: right;">${Math.round(totalLengthCavi * 2)} m</td>
                                </tr>

                                <!-- Cavi AC -->
                                <tr>
                                    <td>Cavi AC</td>
                                    <td style="text-align: right;">${acCableLength} m</td>
                                </tr>

                                <!-- Costo Fresia -->
                                <tr>
                                    <td>Progettazione e pratiche ENEL/GSE</td>
                                    <td style="text-align: right;">Incluso</td>
                                </tr>

                                <!-- Costo Mezzi -->
                                ${costiFinali.mezzi > 0 ? `
                                <tr>
                                    <td>Noleggio Mezzi</td>
                                    <td style="text-align: right;">${document.getElementById('giorniMezzi').value} giorni</td>
                                </tr>` : ''}

                                <!-- Accessori -->
                                ${accessoriData.map(acc => `
                                <tr>
                                    <td>${acc.nome}</td>
                                    <td style="text-align: right;">${acc.quantita}</td>
                                </tr>`).join('')}

                                <!-- Manodopera -->
                                <tr>
                                    <td>Installazione</td>
                                    <td style="text-align: right;">Chiavi in mano</td>
                                </tr>

                                <!-- Sicurezza Cantiere -->
                                ${costiFinali.sicurezza > 0 ? `
                                <tr>
                                    <td>Sicurezza Cantiere</td>
                                    <td style="text-align: right;">Incluso</td>
                                </tr>` : ''}
                            </tbody>
                        </table>
                    </div>                    

                    ${consumoAnnuo > 0 ? `
                    <div class="details-box">
                        <h3 class="details-heading">Analisi Economica</h3>
                        <div class="two-columns">
                            <div>
                                <table>
                                    <tr>
                                        <td>Consumo energetico annuale</td>
                                        <td class="price">${consumoAnnuo.toFixed(0)} kWh</td>
                                    </tr>
                                    <tr>
                                        <td>Costo energia attuale</td>
                                        <td class="price">€ ${costoEnergiaAttuale.toFixed(2)}/kWh</td>
                                    </tr>
                                    <tr>
                                        <td>Spesa annua attuale</td>
                                        <td class="price">€ ${spesaAnnuaEnergia.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Produzione impianto stimata</td>
                                        <td class="price">${produzioneAnnua.toFixed(0)} kWh</td>
                                    </tr>
                                    <tr>
                                        <td>Autoconsumo stimato (${autoconsumoStimato}%)</td>
                                        <td class="price">${energiaAutoconsumata.toFixed(0)} kWh</td>
                                    </tr>
                                    <tr>
                                        <td>Energia immessa in rete</td>
                                        <td class="price">${energiaImmessa.toFixed(0)} kWh</td>
                                    </tr>
                                    <tr>
                                        <td>Risparmio da autoconsumo</td>
                                        <td class="price">€ ${risparmioAutoconsumo.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Risparmio da scambio sul posto</td>
                                        <td class="price">€ ${risparmioScambioSulPosto.toFixed(2)}</td>
                                    </tr>
                                    <tr class="highlight-row">
                                        <td><strong>Risparmio annuo totale</strong></td>
                                        <td class="price price-saving">€ ${risparmioTotale.toFixed(2)}</td>
                                    </tr>
                                </table>
                            </div>
                            <div style="padding: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: transparent !important;">
                                <div style="font-size: 12px; font-weight: bold; margin-bottom: 10px;">Tempo di Rientro dell'Investimento</div>
                                <div style="width: 150px; height: 150px; background: transparent !important; border-radius: 50%; border: 16px solid var(--secondary-color); position: relative; margin: 20px auto; print-color-adjust: exact !important;">
                                    <div style="position: absolute; background-color: white !important; width: 110px; height: 110px; border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%, -70%); display: flex; justify-content: center; align-items: center; flex-direction: column; box-shadow: none !important;">
                                        <span style="font-size: 24px; font-weight: bold;">${tempoRientro}</span>
                                        <span style="font-size: 12px;">anni</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ``}
                                        
                    <div class="final-price-container">
                        <p class="final-price-label">Prezzo Finale (IVA esclusa): € ${parseFloat(preventivoFinale).toFixed(2)}</p>
                        <p>IVA al ${percentualeIva}%: € ${parseFloat(preventivoFinale).toFixed(2)}</p>
                        <p class="final-price">Totale IVA inclusa: € ${(parseFloat(preventivoFinale) * (1 + (percentualeIva / 100))).toFixed(2)}</p>
                    </div>
                </div>

                <div class="note-container">
                    <h3 class="note-title">Note e Condizioni</h3>
                    <ul class="note-list">
                        <li>La Sole Facile può applicare l'Art. 17 c.6 lett.a ter DPR 633/72.</li>
                        <li>Il presente preventivo è valido per ${validitaPreventivo} giorni dalla data di sopralluogo da effettuarsi preventivamente al fine di verificare se quanto proposto e’ idoneo.</li>
                        ${detrazioniApplicabili 
                        ? `<li>Le detrazioni fiscali del ${percentualeDetrazione}% sono ripartite in ${anniDetrazione} anni come previsto dalla normativa vigente.</li>`
                        : ''}
                        <li>I tempi di realizzazione dell'impianto sono stimati in ${giorniMin}-${giorniMax} giorni lavorativi dalla data di conferma dell'ordine e dell'esito positivo delle verifiche tecniche preliminari.</li>
                        <li>Le tempistiche sono da considerarsi valide in assenza di imprevisti non imputabili alla Sole Facile.</li>
                        <li>Nel preventivo sono inclusi tutti i materiali necessari per l'installazione, la manodopera specializzata e le pratiche amministrative di connessione alla rete.</li>
                        <li>Eventuali costi aggiuntivi potrebbero essere applicati in caso di particolari condizioni del sito di installazione rilevate durante il sopralluogo tecnico.</li>
                        <li>Sono esclusi dalla fornitura e dall'offerta:
                            <ul class="inner-list">
                                ${costiFinali.sicurezza > 0 ? '' : `
                                <li>Opere di sicurezza cantiere quali ponteggi o linea vita.</li>`}
                                <li>Opere murarie, scavi, pensiline, impianti elettrici esistenti.</li>
                                <li>Modifica impianto elettrico di casa.</li>
                                <li>Altri lavori (apertura e chiusura scavi, realizzazione basamenti struttura, rifacimento tetto, locale quadri, ecc).</li>
                                <li>Costi per Asseverazione e per allacciamento ENEL, poiché varia in base alla richiesta dell'ENEL al momento.</li>
                                <li>Tutto quanto non specificatamente menzionato.</li>
                            </ul>
                        </li>
                        <li>Tempi di installazione di ogni impianto:
                            <ul class="inner-list">
                                <li>10 gg lavorativi x arrivo di tutti i materiali.</li>
                                <li>15 gg min per installazione di tutti gli impianti da disponibilità’ dei materiali 
                                    per cui alcuni lavori partono man mano che vi sono i materiali (esempio le strutture per ancoraggio moduli) 
                                    e tempo permettendo.</li>
                            </ul>
                        </li>
                        ${percentualeTerza > 0 ? `
                        <li>Pagamento:
                            <ul class="inner-list">
                                <li>${percentualePrima}% per ordine materiali.</li>
                                <li>${percentualeSeconda}% a fine lavori.</li>
                                <li>${percentualeTerza}% per il collaudo.</li>
                            </ul>
                        </li>` : 
                        `
                        <li>Pagamento:
                            <ul class="inner-list">
                                <li>${percentualePrima}% per ordine materiali.</li>
                                <li>${percentualeSeconda}% per fine lavori e collaudo.</li>
                            </ul>
                        </li>`} 
                        <li>Garanzie:
                            <ul class="inner-list">
                                <li>10 anni per inverter e batterie come previsto dalla Solax.</li>
                                <li>25 anni sulla durata della potenza dei moduli.</li>
                                <li>15 anni sulla qualita’ del prodotto e sulla fabbricazione.</li>
                                <li>0,55% degrado all’anno dopo i 25 anni.</li>
                                <li>Esecuzione lavori a regola d’arte in conformità alle vigenti normative.</li>
                                <li>Abilitazione Legge 46/90.</li>
                            </ul>
                        </li>
                        <li>L'impianto verrà realizzato in conformità alle normative vigenti in materia di impianti fotovoltaici e rispettando tutti gli standard di sicurezza.</li>
                        <li>Copertura assicurativa per eventuali danni provocati in fase di esecuzione lavori con regolare polizza presso la REALE MUTUA ASSICURAZIONI.</li>
                        <li>Con la sottoscrizione del presente documento si intendono espressamente accettate le condizioni di vendita sopra esposte.</li>
                        
                        ${notePersonalizzate ? `<li class="note-personalizzata">
                            ${notePersonalizzate}</li>` 
                            : ''}
                    </ul>
                    
                    <div class="details-box" style="margin-top: 20px;">
                        <h3 class="details-heading">Incentivi e Risparmio Stimato</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;">
                            <div style="padding-right: 15px;">
                                ${detrazioniApplicabili 
                                ? `<p style="margin-bottom: 10px;"><strong>Detrazioni Fiscali:</strong> ${percentualeDetrazione}% in ${anniDetrazione} anni</p>`
                                : ''}
                                <p style="margin-bottom: 10px;"><strong>Risparmio annuo stimato:</strong> ~ € ${Math.round(potenzaTotale * produzioneAnnuaKw * costoEnergiaAttuale)}</p>
                                <p style="margin-bottom: 10px;"><strong>Ritorno dell'investimento stimato:</strong> ~ ${tempoRientro} anni</p>
                            </div>
                            <div style="padding-left: 15px;">
                                <p style="margin-bottom: 10px;"><strong>Cessione Energia:</strong> ${tipoCessione}</p>
                                <p style="margin-bottom: 10px;"><strong>Capacità Accumulo:</strong> ${batterieData.length > 0 ? '✓ Presente' : '✗ Non Presente'}</p>
                                <p style="margin-bottom: 10px;"><strong>Monitoraggio Remoto:</strong> ✓ Incluso</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-box" style="margin-top: 30px;">
                    <h3 class="details-heading">Perché Scegliere SoleFacile</h3>
                    <table style="box-shadow: none; border: none; margin: 0;">
                        <tr>
                            <td style="width: 50%; padding: 10px; vertical-align: top; border: none;">
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Esperienza Comprovata</strong>
                                    <div style="margin-top: 5px;">Oltre 500 impianti installati in tutta Italia</div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Assistenza Continuativa</strong>
                                    <div style="margin-top: 5px;">Supporto tecnico dedicato per 5 anni</div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Materiali Premium</strong>
                                    <div style="margin-top: 5px;">Utilizziamo solo componenti certificati di alta qualità</div>
                                </div>
                            </td>
                            <td style="width: 50%; padding: 10px; vertical-align: top; border: none;">
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Installatori Qualificati</strong>
                                    <div style="margin-top: 5px;">Team di tecnici specializzati e certificati</div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Monitoraggio Avanzato</strong>
                                    <div style="margin-top: 5px;">Sistema di controllo remoto incluso</div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <strong>✓ Pratiche Amministrative</strong>
                                    <div style="margin-top: 5px;">Gestiamo tutte le procedure burocratiche</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="signature-area">
                    <div class="signature-box">
                        <p class="signature-label">SoleFacile S.r.l.</p>
                    </div>
                    <div class="signature-box">
                        <p class="signature-label">Firma Cliente per accettazione</p>
                    </div>
                </div>

                <div class="footer">
                    <div class="logo-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 306.71 153.03" class="logo">
                            <defs><style>.cls-1{fill:#fff;}.cls-2{fill:none;}.cls-3{fill:#60b22f;}.cls-4{fill:#9cc42c;}.cls-5{fill:#bbd02c;}.cls-6{fill:#dadb1a;}.cls-7{fill:#ebe320;}</style></defs>
                            <g id="Livello_2" data-name="Livello 2"><g id="Livello_1-2" data-name="Livello 1">
                                <path class="cls-1" d="M33.34,83.42A72.18,72.18,0,0,1,14.52,81,48.77,48.77,0,0,1,0,74.83L7.35,58.22a51.66,51.66,0,0,0,12.26,5.6A45.55,45.55,0,0,0,33.45,66,28.26,28.26,0,0,0,41,65.23,8.43,8.43,0,0,0,45,63a5.14,5.14,0,0,0,1.29-3.5,4.64,4.64,0,0,0-2.48-4.13,24.64,24.64,0,0,0-6.5-2.6c-2.68-.71-5.57-1.39-8.7-2a86.34,86.34,0,0,1-9.55-2.55A36.22,36.22,0,0,1,10.28,44,19.94,19.94,0,0,1,3.9,37.2,20.64,20.64,0,0,1,1.47,26.69,22.47,22.47,0,0,1,5.32,13.92Q9.15,8.16,17,4.66T36.39,1.15A67.79,67.79,0,0,1,51.71,2.9,45.12,45.12,0,0,1,65,8.16L58.2,24.66A48.24,48.24,0,0,0,47,20a41.77,41.77,0,0,0-10.74-1.47,22.49,22.49,0,0,0-7.46,1,9,9,0,0,0-4.06,2.6,5.4,5.4,0,0,0-1.24,3.39A4.75,4.75,0,0,0,26,29.8a22.51,22.51,0,0,0,6.45,2.48q3.95,1,8.75,2a96.06,96.06,0,0,1,9.55,2.53,38.78,38.78,0,0,1,8.76,4.07A20.13,20.13,0,0,1,66,47.54a19.82,19.82,0,0,1,2.49,10.34,22.46,22.46,0,0,1-3.9,12.72,26.79,26.79,0,0,1-11.7,9.32C47.7,82.26,41.17,83.42,33.34,83.42Z"/><path class="cls-1" d="M174.37,81.84V2.73h22.38V64.1h37.63V81.84Z"/><polygon class="cls-1" points="265.35 64.44 265.35 49.97 300.49 49.97 300.49 33.36 265.35 33.36 265.35 20.14 305.24 20.14 305.24 2.73 243.3 2.73 243.3 81.84 306.71 81.84 306.71 64.44 265.35 64.44"/><polygon class="cls-1" points="46.19 105.84 46.19 92.86 0 92.86 0 151.85 16.69 151.85 16.69 131.63 42.65 131.63 42.65 118.73 16.69 118.73 16.69 105.84 46.19 105.84"/><path class="cls-1" d="M95.92,151.86h17.36l-26.13-59H70.72l-26,59h17l4.63-11.55h25ZM71.24,128.09l7.57-18.86,7.57,18.86Z"/><path class="cls-1" d="M146.58,153a36.11,36.11,0,0,1-12.9-2.23,31.22,31.22,0,0,1-10.29-6.32,28.77,28.77,0,0,1-6.82-9.73,32.68,32.68,0,0,1,0-24.78,28.81,28.81,0,0,1,6.82-9.74,31.22,31.22,0,0,1,10.29-6.32,38.89,38.89,0,0,1,27.52.59,27.42,27.42,0,0,1,10.74,8.3l-10.62,9.61a20.73,20.73,0,0,0-6.32-5.14,16.37,16.37,0,0,0-7.58-1.77,18.13,18.13,0,0,0-6.66,1.18,14.4,14.4,0,0,0-5.18,3.41,16,16,0,0,0-3.37,5.35,20.05,20.05,0,0,0,0,13.83,15.88,15.88,0,0,0,3.37,5.35,14.14,14.14,0,0,0,5.18,3.41,18.13,18.13,0,0,0,6.66,1.18,16.37,16.37,0,0,0,7.58-1.77,20.32,20.32,0,0,0,6.32-5.22l10.62,9.6a27.73,27.73,0,0,1-10.74,8.35A35.68,35.68,0,0,1,146.58,153Z"/><path class="cls-1" d="M179.44,151.86v-59h16.69v59Z"/><path class="cls-1" d="M208,151.86v-59H224.7v45.76h28.07v13.24Z"/><polygon class="cls-1" points="275.86 138.88 275.86 128.09 302.07 128.09 302.07 115.7 275.86 115.7 275.86 105.84 305.61 105.84 305.61 92.86 259.42 92.86 259.42 151.85 306.71 151.85 306.71 138.88 275.86 138.88"/><path class="cls-2" d="M118.55,83.42a48.93,48.93,0,0,1-17.47-3,41,41,0,0,1-14-8.65A40,40,0,0,1,74.59,42.18,39.47,39.47,0,0,1,77.92,25.9,40.74,40.74,0,0,1,101,4.2a51.82,51.82,0,0,1,35,0A41.59,41.59,0,0,1,150,12.79a40.17,40.17,0,0,1,9.21,13,39.57,39.57,0,0,1,3.34,16.39,41.22,41.22,0,0,1-3.27,16.55A39.11,39.11,0,0,1,150,71.78a41.93,41.93,0,0,1-14,8.59A48.69,48.69,0,0,1,118.55,83.42Z"/><path class="cls-1" d="M159.79,25a40.58,40.58,0,0,0-9.35-13.19A42,42,0,0,0,136.32,3.1a52.54,52.54,0,0,0-35.56,0,41.38,41.38,0,0,0-23.46,22,40.14,40.14,0,0,0-3.38,16.52,40.82,40.82,0,0,0,3.38,16.7,41.18,41.18,0,0,0,23.52,22.08,52.37,52.37,0,0,0,35.5,0A42.71,42.71,0,0,0,150.5,71.7a39.64,39.64,0,0,0,9.35-13.25,41.55,41.55,0,0,0,3.33-16.81A40.24,40.24,0,0,0,159.79,25Z"/><path class="cls-3" d="M146,22.77c0,.81.07,1.63.07,2.46a41.07,41.07,0,0,1-3.28,16.56,39.08,39.08,0,0,1-9.21,13.05,42,42,0,0,1-14,8.59,48.76,48.76,0,0,1-17.51,3.05c-1.82,0-3.6-.09-5.34-.26-.46-.35-.92-.71-1.36-1.07a31.47,31.47,0,0,0,9.17,5.27,41.85,41.85,0,0,0,27.91,0,32.15,32.15,0,0,0,10.68-6.54,28.93,28.93,0,0,0,6.85-9.72,30.85,30.85,0,0,0,2.43-12.53A29.36,29.36,0,0,0,150,29.37,30.21,30.21,0,0,0,146,22.77Z"/><path class="cls-4" d="M102.14,66.48a48.76,48.76,0,0,0,17.51-3.05,42,42,0,0,0,14-8.59,39.08,39.08,0,0,0,9.21-13.05,41.07,41.07,0,0,0,3.28-16.56c0-.83,0-1.65-.07-2.46h0c-.4-.5-.82-1-1.25-1.46L144.5,21c-.45-.48-.91-1-1.39-1.41-.75-.7-1.52-1.36-2.33-2a30.92,30.92,0,0,0-3.87-2.51c-.66-.37-1.35-.7-2-1,.62.29,1.24.59,1.83.91,0,.29,0,.57,0,.86a41,41,0,0,1-3.27,16.55,39.25,39.25,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48.9,48.9,0,0,1-17.51,3c-1.42,0-2.81-.05-4.19-.16-.26-.46-.52-.93-.76-1.41a30.75,30.75,0,0,0,3.17,5,28.22,28.22,0,0,0,2,2.28c.36.37.72.73,1.09,1.09h0c.43.41.88.8,1.33,1.18l.08.07c.44.36.9.72,1.36,1.07C98.54,66.39,100.32,66.48,102.14,66.48Z"/><path class="cls-5" d="M87.8,55.52c.24.48.5.95.76,1.41,1.38.11,2.77.16,4.19.16a48.9,48.9,0,0,0,17.51-3,42.26,42.26,0,0,0,14-8.59,39.25,39.25,0,0,0,9.22-13.06,41,41,0,0,0,3.27-16.55c0-.29,0-.57,0-.86-.59-.32-1.21-.62-1.83-.91l-.37-.17c-.64-.28-1.29-.56-2-.82h0c-.52-.2-1.05-.38-1.59-.56-1.08-.35-2.19-.65-3.32-.9l-.57-.11a39.52,39.52,0,0,1-3,11.49,38.91,38.91,0,0,1-9.22,13.06,42.26,42.26,0,0,1-14,8.59,48,48,0,0,1-15.72,3c0,.15,0,.31.08.47A27.85,27.85,0,0,0,87.08,54c.23.51.46,1,.71,1.49Z"/><path class="cls-6" d="M85.15,47.67a48,48,0,0,0,15.72-3,42.26,42.26,0,0,0,14-8.59A38.91,38.91,0,0,0,124.05,23a39.52,39.52,0,0,0,3-11.49h0c-.64-.13-1.29-.24-1.94-.34l-.21,0c-.58-.08-1.17-.16-1.76-.22l-.37,0c-.55-.05-1.1-.09-1.66-.12l-.46,0c-.68,0-1.38-.05-2.08-.05h0c-1,0-1.88,0-2.81.09-.32,1-.68,1.91-1.08,2.83a38.91,38.91,0,0,1-9.22,13.06,42.16,42.16,0,0,1-14,8.59,45.69,45.69,0,0,1-6.57,1.93,33.57,33.57,0,0,0-.29,4.44c0,.54,0,1.08,0,1.6s0,.85.08,1.26c0,.09,0,.17,0,.25.09,1,.22,2,.4,2.92Z"/><path class="cls-7" d="M105.44,26.68a38.91,38.91,0,0,0,9.22-13.06c.4-.92.76-1.87,1.08-2.83h0a42,42,0,0,0-5.72.74l-.15,0c-.86.18-1.69.39-2.52.62l-.4.12c-.81.24-1.61.5-2.39.79h0A30.88,30.88,0,0,0,94,19.62a29.91,29.91,0,0,0-4.8,5.83c-.42.65-.8,1.33-1.17,2s-.69,1.33-1,2-.47,1.12-.68,1.69c0,.14-.09.28-.14.42-.17.47-.32.95-.46,1.43l-.09.33a28.07,28.07,0,0,0-.78,3.84h0a45.69,45.69,0,0,0,6.57-1.93A42.16,42.16,0,0,0,105.44,26.68Z"/>
                            </g></g>
                        </svg>
                    </div>
                    <div class="footer-text">
                        <p><strong>SoleFacile S.r.l.</strong> - P.IVA IT 09557480010</p>
                        <p>Via Nizza 108, 10126 Torino, Italia</p>
                        <div class="contact-info">
                            <span class="contact-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                +39 3200103380
                            </span>
                            <span class="contact-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                solefacilesrl@gmail.com
                            </span>
                            <span class="contact-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                www.solefacilesrl.com
                            </span>
                        </div>
                        <p class="no-print"><button onclick="window.print()" style="padding: 8px 16px; background-color: #1a56db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Stampa Preventivo</button></p>
                    </div>
                </div>
            </body>
            </html>
            `;

            // Modifica il codice HTML per sostituire il grafico di produzione
            preventivoHTML = preventivoHTML.replace(
                /<div class="details-box">\s*<h3 class="details-heading">\s*Produzione Energetica Stimata\s*<\/h3>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/,
                dettaglioProduzioneHTML
            );

            // Aggiungi le immagini al preventivo
            const hasImages = renderImages.some(img => img !== null);
            
            if (hasImages) {
                const renderGalleryHTML = `
                    <div class="details-box" style="margin-top: 20px;">
                        <h3 class="details-heading">
                            Render dell'Impianto
                        </h3>
                        <div class="render-gallery" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            ${renderImages.map((img, index) => 
                                img ? `<img src="${img}" alt="Render Impianto ${index + 1}" style="max-width: 600px; max-height: 400px; object-fit: contain; border-radius: 4px; border: 1px solid #e2e8f0;">` : ''
                            ).join('')}
                        </div>
                    </div>
                `;
                
                // Inserisci la galleria prima della sezione "riepilogo"
                preventivoHTML = preventivoHTML.replace(
                    '<div class="riepilogo">',
                    `${renderGalleryHTML}<div class="riepilogo">`
                );
            }

            // Array per tenere traccia di tutti i blob URL creati
            const createdBlobUrls = [];

            // Crea un blob con l'HTML del preventivo
            console.log("Crea un blob con l'HTML del preventivo");
            let blob = new Blob([preventivoHTML], { type: 'text/html' });
            console.log(`Dimensione totale dell'HTML: ${(blob.size / (1024 * 1024)).toFixed(2)} MB`);

            // Log informazioni sulla memoria delle immagini
            console.log("Informazioni memoria immagini:");
            let totalImagesSize = 0;
            renderImages.forEach((img, index) => {
                if (img) {
                    // Calcola la dimensione approssimativa dell'immagine base64
                    const base64Data = img.split(',')[1];
                    const sizeInBytes = base64Data ? Math.ceil((base64Data.length * 3) / 4) : 0;
                    const sizeInMB = sizeInBytes / (1024 * 1024);
                    
                    totalImagesSize += sizeInBytes;
                    console.log(`Immagine ${index + 1}: ${sizeInMB.toFixed(2)} MB`);
                } else {
                    console.log(`Immagine ${index + 1}: non caricata`);
                }
            });
            console.log(`Dimensione totale delle immagini: ${(totalImagesSize / (1024 * 1024)).toFixed(2)} MB`);

            // Memoria prima di creare il blob URL
            if (window.performance && window.performance.memory) {
                const memoryBefore = window.performance.memory;
                console.log(`Memoria usata prima del blob URL: ${(memoryBefore.usedJSHeapSize / (1024 * 1024)).toFixed(2)} MB`);
            }

            // Crea un URL per il blob
            console.log("Crea un URL per il blob");
            const url = window.URL.createObjectURL(blob);
            createdBlobUrls.push(url); // Tieni traccia dell'URL creato

            // Memoria dopo aver creato il blob URL
            if (window.performance && window.performance.memory) {
                const memoryAfter = window.performance.memory;
                console.log(`Memoria usata dopo il blob URL: ${(memoryAfter.usedJSHeapSize / (1024 * 1024)).toFixed(2)} MB`);
            }

            // Crea un elemento a per scaricare il file
            console.log("Crea un elemento a per scaricare il file");
            const a = document.createElement('a');
            a.href = url;
            a.download = `Preventivo_${nomeCognomeCliente.replace(/\s+/g, '_')}_${dataOdierna.replace(/\//g, '-')}.html`;

            // Aggiungi l'elemento a al body (invisibile)
            console.log("Aggiungi l'elemento a al body (invisibile)");
            document.body.appendChild(a);

            showDownloadOptions(url, `Preventivo_${nomeCognomeCliente.replace(/\s+/g, '_')}_${dataOdierna.replace(/\//g, '-')}`);

            // // Simula un click sull'elemento a per avviare il download
            // console.log("Simula un click sull'elemento a per avviare il download");
            // a.click();
        });

        function showDownloadOptions(url, filename) {
            // Rimuovi il container esistente se presente
            const existingContainer = document.getElementById('download-options-container');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // Crea il container per i bottoni
            const optionsContainer = document.createElement('div');
            optionsContainer.id = 'download-options-container';
            optionsContainer.style.marginTop = '20px';
            optionsContainer.style.display = 'flex';
            optionsContainer.style.flexDirection = 'column';
            optionsContainer.style.alignItems = 'center';
            optionsContainer.style.gap = '15px';
            optionsContainer.style.width = '100%';
            
            // Bottone per HTML
            const htmlButton = document.createElement('button');
            htmlButton.textContent = 'Scarica in HTML';
            htmlButton.className = 'download-button';
            htmlButton.style.backgroundColor = '#2563eb';
            htmlButton.style.color = 'white';
            htmlButton.style.padding = '12px 24px';
            htmlButton.style.borderRadius = '8px';
            htmlButton.style.fontWeight = 'bold';
            htmlButton.style.cursor = 'pointer';
            htmlButton.style.display = 'flex';
            htmlButton.style.alignItems = 'center';
            htmlButton.style.justifyContent = 'center';
            htmlButton.style.width = '100%';
            htmlButton.style.maxWidth = '300px';
            htmlButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Scarica file HTML
            `;
            
            // Bottone per aprire in una nuova tab
            const newTabButton = document.createElement('button');
            newTabButton.textContent = 'Anteprima in una nuova tab';
            newTabButton.className = 'download-button';
            newTabButton.style.backgroundColor = '#16a34a';
            newTabButton.style.color = 'white';
            newTabButton.style.padding = '12px 24px';
            newTabButton.style.borderRadius = '8px';
            newTabButton.style.fontWeight = 'bold';
            newTabButton.style.cursor = 'pointer';
            newTabButton.style.display = 'flex';
            newTabButton.style.alignItems = 'center';
            newTabButton.style.justifyContent = 'center';
            newTabButton.style.width = '100%';
            newTabButton.style.maxWidth = '300px';
            newTabButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Anteprima in una nuova tab
            `;
            
            // Event listener per HTML
            htmlButton.addEventListener('click', function(event) {
                // Previeni il comportamento predefinito che causa il ricaricamento della pagina
                event.preventDefault();
                
                // Crea un elemento a per scaricare il file
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                const saveStatus = document.getElementById('saveStatus');
                if (saveStatus) {
                    saveStatus.textContent = 'File HTML scaricato con successo';
                    saveStatus.style.opacity = '1';
                    setTimeout(() => {
                        saveStatus.style.opacity = '0';
                    }, 3000);
                }
            });
            
            // Event listener per Anteprima
            newTabButton.addEventListener('click', function(event) {
                // Previeni il comportamento predefinito che causa il ricaricamento della pagina
                event.preventDefault();
                
                // Mostra un indicatore di caricamento
                const saveStatus = document.getElementById('saveStatus');
                if (saveStatus) {
                    saveStatus.textContent = 'Generazione Anteprima in corso...';
                    saveStatus.style.opacity = '1';
                }
                
                // Apri la pagina in una nuova finestra
                const printWindow = window.open(url, '_blank');
            });
            
            // Aggiungi i bottoni al container
            optionsContainer.appendChild(htmlButton);
            optionsContainer.appendChild(newTabButton);
            
            // Trova il container del "Genera Preventivo" per aggiungervi i bottoni
            const generateContainer = document.querySelector('.generate-container');
            if (generateContainer) {
                generateContainer.appendChild(optionsContainer);
            } else {
                // Fallback: aggiungi dopo il bottone "Genera Preventivo"
                const generaButton = document.getElementById('generaPreventivo');
                if (generaButton && generaButton.parentNode) {
                    generaButton.parentNode.appendChild(optionsContainer);
                }
            }
        }

        // Variabile globale per memorizzare i dati PVGIS
        let pvgisData = null;

        // Funzione per gestire il caricamento del file PVGIS
        function handlePVGISFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    pvgisData = JSON.parse(content);
                    
                    // Aggiorniamo l'UI con le informazioni caricate
                    updatePVGISInfo(pvgisData);
                    
                    // Aggiorniamo anche il preventivo in tempo reale
                    calcolaPreventivoInRealTime();
                } catch (error) {
                    console.error('Errore nel parsing del file JSON:', error);
                    document.getElementById('pvgisStatus').textContent = 'Errore nel parsing del file';
                    document.getElementById('pvgisInfo').classList.remove('hidden');
                }
            };
            
            reader.readAsText(file);
        }

            // Funzione per inizializzare la mappa PVGIS
            function initPVGISMap(lat, lon, elevation) {
                // Converti le coordinate a numeri
                lat = parseFloat(lat);
                lon = parseFloat(lon);
                elevation = parseFloat(elevation);
                
                // Se la mappa non esiste ancora, creala
                if (!pvgisMap) {
                    pvgisMap = L.map('pvgisMap').setView([lat, lon], 13);
                    
                    // Aggiungi il tile layer di OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(pvgisMap);
                } else {
                    // Centra la mappa sulle nuove coordinate
                    pvgisMap.setView([lat, lon], 13);
                }
                
                // Rimuovi il marker precedente se esiste
                if (pvgisMarker) {
                    pvgisMap.removeLayer(pvgisMarker);
                }
                
                // Aggiungi un nuovo marker
                pvgisMarker = L.marker([lat, lon]).addTo(pvgisMap);
                
                // Aggiungi un popup con informazioni sul sito
                pvgisMarker.bindPopup(
                    `<b>Posizione Impianto</b><br>` +
                    `Latitudine: ${lat.toFixed(6)}<br>` +
                    `Longitudine: ${lon.toFixed(6)}<br>` +
                    `Altitudine: ${elevation} m`
                ).openPopup();
                
                // Forza il ridimensionamento della mappa
                setTimeout(() => {
                    pvgisMap.invalidateSize();
                }, 100);
            }

        // Funzione per aggiornare l'interfaccia con i dati PVGIS 
        function updatePVGISInfo(data) {
            const infoElement = document.getElementById('pvgisInfo');
            const placeholderElement = document.getElementById('pvgisPlaceholder');
            const statusElement = document.getElementById('pvgisStatus');
            const annualProductionElement = document.getElementById('pvgisAnnualProduction');
            const annualIrradiationElement = document.getElementById('pvgisAnnualIrradiation');
            
            if (data && data.outputs && data.outputs.totals && data.outputs.totals.fixed) {
                const totalData = data.outputs.totals.fixed;
                
                statusElement.textContent = 'File caricato correttamente';
                annualProductionElement.textContent = totalData.E_y ? totalData.E_y.toFixed(2) : '-';
                annualIrradiationElement.textContent = totalData.H_i_y ? totalData.H_i_y.toFixed(2) : (totalData['H(i)_y'] ? totalData['H(i)_y'].toFixed(2) : '-');
                
                // Aggiorna automaticamente il campo produzioneAnnuaKw con i dati PVGIS
                if (totalData.E_y && data.inputs && data.inputs.pv_module && data.inputs.pv_module.peak_power) {
                    // Se il file contiene la potenza di picco dell'impianto, usa quella
                    const peakPower = parseFloat(data.inputs.pv_module.peak_power);
                    if (peakPower > 0) {
                        const produzionePerKwp = totalData.E_y / peakPower;
                        document.getElementById('produzioneAnnuaKw').value = produzionePerKwp.toFixed(0);
                    }
                } else if (totalData.E_y) {
                    // Altrimenti usa la potenza calcolata dal sistema
                    const potenzaTotale = calcolaPotenzaTotale();
                    if (potenzaTotale > 0) {
                        const produzionePerKwp = totalData.E_y / potenzaTotale;
                        document.getElementById('produzioneAnnuaKw').value = produzionePerKwp.toFixed(0);
                    }
                }
                
                // Inizializza la mappa se ci sono coordinate
                if (data.inputs && data.inputs.location && 
                    data.inputs.location.latitude && 
                    data.inputs.location.longitude) {
                    
                    // Mostra il container della mappa
                    const mapContainer = document.getElementById('pvgisMapContainer');
                    if (mapContainer) {
                        mapContainer.classList.remove('hidden');
                        
                        // Inizializza o aggiorna la mappa
                        initPVGISMap(
                            data.inputs.location.latitude, 
                            data.inputs.location.longitude,
                            data.inputs.location.elevation || 0
                        );
                    }
                }
                
                // Mostra le informazioni PVGIS e nascondi il placeholder
                infoElement.classList.remove('hidden');
                if (placeholderElement) {
                    placeholderElement.classList.add('hidden');
                }
                
                isPvgisDataAvailable = true; // Set the flag to true when valid data is loaded
            } else {
                statusElement.textContent = 'Formato file non valido';
                infoElement.classList.remove('hidden');
                
                // Mantieni visibile il placeholder in caso di errore
                if (placeholderElement) {
                    placeholderElement.classList.remove('hidden');
                }
                
                // Nascondi la mappa se è stata mostrata in precedenza
                const mapContainer = document.getElementById('pvgisMapContainer');
                if (mapContainer) {
                    mapContainer.classList.add('hidden');
                }
                
                isPvgisDataAvailable = false; // Ensure flag is false for invalid data
            }
        }

        // Aggiungi l'event listener per il caricamento del file
        document.getElementById('pvgisFileInput').addEventListener('change', handlePVGISFileUpload);

        // ===== Sistema di Salvataggio Automatico =====
        let autoSaveTimer;
        const AUTO_SAVE_INTERVAL = 30000; // 30 secondi

        // Funzione per salvare tutti i dati del form
        function saveFormData() {
            const data = {};

            // Aggiungi informazioni sulla versione
            data.appVersion = CURRENT_APP_VERSION;
            data.fileVersion = FORMATO_FILE;  // Versione del formato file
            
            // Raccogli dati dai campi di input
            //console.log("Raccogli dati dai campi di input");
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.id) {
                    if (element.type === 'file') {
                        //console.log("Non possiamo salvare i file direttamente");
                        // Non possiamo salvare i file direttamente
                        return;
                    }
                    
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        data[element.id] = element.checked;
                    } else {
                        data[element.id] = element.value;
                    }
                }
            });
            
            // Raccogli dati delle falde e gruppi di moduli
            data.falde = [];
            document.querySelectorAll('.falda-group').forEach(falda => {
                const faldaId = falda.getAttribute('data-falda-id');
                const faldaData = {
                    nome: falda.querySelector('.falda-nome').value,
                    larghezza: falda.querySelector('.falda-larghezza').value,
                    lunghezza: falda.querySelector('.falda-lunghezza').value,
                    inclinazione: falda.querySelector('.falda-inclinazione').value,
                    gruppiModuli: []
                };
                
                // Raccogli dati dei gruppi di moduli per questa falda
                falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                    const gruppoId = gruppo.getAttribute('data-gruppo-id');
                    faldaData.gruppiModuli.push({
                        id: gruppoId,
                        nome: gruppo.querySelector('.gruppo-nome').value,
                        orientamento: gruppo.querySelector('.gruppo-orientamento').value,
                        numeroFile: gruppo.querySelector('.gruppo-numero-file').value,
                        moduliPerFila: gruppo.querySelector('.gruppo-moduli-fila').value,
                        modulo: gruppo.querySelector('.gruppo-modulo').value
                    });
                });
                
                data.falde.push(faldaData);
            });
            
            // Raccogli dati degli inverter
            //console.log("Raccogli dati degli inverter");
            data.inverters = [];
            document.querySelectorAll('.inverter-group').forEach(inverter => {
                const inverterData = {
                    model: inverter.querySelector('.inverter-select').value,
                    stringhe: inverter.querySelector('.numero-stringhe').value,
                    quantita: inverter.querySelector('.numero-inverter').value
                };
                data.inverters.push(inverterData);
            });
            
            // Raccogli dati delle batterie
            //console.log("Raccogli dati delle batterie");
            data.batterie = [];
            document.querySelectorAll('.batteria-group').forEach(batteria => {
                const batteriaData = {
                    model: batteria.querySelector('.batteria-select').value,
                    quantita: batteria.querySelector('.numero-batterie').value
                };
                data.batterie.push(batteriaData);
            });
            
            // Salva data e ora dell'ultimo salvataggio
            data.lastSaved = new Date().toISOString();
            console.log("ultimo auto salvataggio:\n" + data.lastSaved);

            // Salva i dati nel localStorage
            const nomeCliente = document.getElementById('nomeCognomeCliente').value || 'Cliente';
            localStorage.setItem('prisma_autosave_' + nomeCliente + '_' + numeroPreventivo, JSON.stringify(data));
            
            // Feedback all'utente (opzionale)
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) {
                saveStatus.textContent = 'Salvato automaticamente alle ' + new Date().toLocaleTimeString();
                saveStatus.style.opacity = '1';
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                }, 3000);
            }
            console.log(data)
        }

        // Funzione per ripristinare i dati del form
        function restoreFormData(data) {
            // Ripristina i valori dei campi base
            for (const id in data) {
                const element = document.getElementById(id);
                if (element && id !== 'falde' && id !== 'inverters' && id !== 'batterie' && id !== 'lastSaved') {
                    if (element.type === 'file') {
                        // Non possiamo ripristinare i file
                        continue;
                    }
                    
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        element.checked = data[id];
                    } else {
                        element.value = data[id];
                    }
                }
            }
            
            // Ripristina le falde
            if (data.falde && data.falde.length > 0) {
                // Prima elimina tutte le falde esistenti
                const faldeContainer = document.getElementById('faldeContainer');
                faldeContainer.innerHTML = '';
                
                // Poi crea nuove falde con i dati salvati
                data.falde.forEach((faldaData, index) => {
                    const newFaldaHTML = createFaldaTemplate(index);
                    faldeContainer.insertAdjacentHTML('beforeend', newFaldaHTML);
                    
                    const newFalda = faldeContainer.lastElementChild;
                    setupFaldaEventListeners(newFalda);
                    
                    // Imposta i valori salvati della falda
                    newFalda.querySelector('.falda-nome').value = faldaData.nome;
                    newFalda.querySelector('.falda-larghezza').value = faldaData.larghezza;
                    newFalda.querySelector('.falda-lunghezza').value = faldaData.lunghezza;
                    newFalda.querySelector('.falda-inclinazione').value = faldaData.inclinazione;
                    
                    // Ripristina i gruppi di moduli per questa falda
                    const gruppiContainer = newFalda.querySelector('.gruppi-moduli-container');
                    gruppiContainer.innerHTML = ''; // Rimuovi eventuali gruppi predefiniti
                    
                    if (faldaData.gruppiModuli && faldaData.gruppiModuli.length > 0) {
                        faldaData.gruppiModuli.forEach((gruppoData) => {
                            // Trova l'ID massimo per assegnare un nuovo ID progressivo
                            const gruppoId = parseInt(gruppoData.id) || gruppiCounters[index] || 0;
                            
                            gruppiContainer.insertAdjacentHTML('beforeend', createGruppoModuliTemplate(index, gruppoId));
                            const newGruppo = gruppiContainer.lastElementChild;
                            setupGruppoModuliEventListeners(newGruppo, index, gruppoId);
                            
                            // Imposta i valori salvati del gruppo
                            newGruppo.querySelector('.gruppo-orientamento').value = gruppoData.orientamento;
                            newGruppo.querySelector('.gruppo-numero-file').value = gruppoData.numeroFile;
                            newGruppo.querySelector('.gruppo-moduli-fila').value = gruppoData.moduliPerFila;
                            newGruppo.querySelector('.gruppo-modulo').value = gruppoData.modulo;
                            newGruppo.querySelector('.gruppo-nome').value = gruppoData.nome || `Gruppo ${gruppoId + 1}`;
                            
                            // Aggiorna il contatore per il prossimo gruppo
                            gruppiCounters[index] = Math.max(gruppiCounters[index] || 0, gruppoId + 1);
                        });
                    } else {
                        // Se non ci sono gruppi salvati, aggiungi un gruppo predefinito
                        aggiungiGruppoModuli(index);
                    }
                });
                
                // Aggiorna il contatore delle falde
                faldeCounter = data.falde.length;
            }
            
            // Ripristina gli inverter
            if (data.inverters && data.inverters.length > 0) {
                // Prima elimina tutti gli inverter esistenti
                const invertersContainer = document.getElementById('invertersContainer');
                invertersContainer.innerHTML = '';
                
                // Poi crea nuovi inverter con i dati salvati
                data.inverters.forEach((inverterData, index) => {
                    const newInverterHTML = createInverterTemplate(index);
                    invertersContainer.insertAdjacentHTML('beforeend', newInverterHTML);
                    
                    const newInverter = invertersContainer.lastElementChild;
                    newInverter.querySelector('.rimuovi-inverter').addEventListener('click', function() {
                        newInverter.remove();
                        calcolaPreventivoInRealTime();
                    });
                    
                    newInverter.querySelector('.inverter-select').addEventListener('change', calcolaPreventivoInRealTime);
                    newInverter.querySelector('.numero-stringhe').addEventListener('input', calcolaPreventivoInRealTime);
                    newInverter.querySelector('.numero-inverter').addEventListener('input', calcolaPreventivoInRealTime);
                    
                    // Imposta i valori salvati
                    newInverter.querySelector('.inverter-select').value = inverterData.model;
                    newInverter.querySelector('.numero-stringhe').value = inverterData.stringhe;
                    newInverter.querySelector('.numero-inverter').value = inverterData.quantita;
                });
                
                // Aggiorna il contatore degli inverter
                inverterCounter = data.inverters.length;
            }
            
            // Ripristina le batterie
            if (data.batterie && data.batterie.length > 0) {
                // Prima elimina tutte le batterie esistenti
                const batterieContainer = document.getElementById('batterieContainer');
                batterieContainer.innerHTML = '';
                
                // Poi crea nuove batterie con i dati salvati
                data.batterie.forEach((batteriaData, index) => {
                    const newBatteriaHTML = createBatteriaTemplate(index);
                    batterieContainer.insertAdjacentHTML('beforeend', newBatteriaHTML);
                    
                    const newBatteria = batterieContainer.lastElementChild;
                    newBatteria.querySelector('.rimuovi-batteria').addEventListener('click', function() {
                        newBatteria.remove();
                        calcolaPreventivoInRealTime();
                        toggleParallelBoxVisibility();
                    });
                    
                    newBatteria.querySelector('.batteria-select').addEventListener('change', calcolaPreventivoInRealTime);
                    newBatteria.querySelector('.numero-batterie').addEventListener('input', calcolaPreventivoInRealTime);
                    
                    // Imposta i valori salvati
                    newBatteria.querySelector('.batteria-select').value = batteriaData.model;
                    newBatteria.querySelector('.numero-batterie').value = batteriaData.quantita;
                });
                
                // Aggiorna il contatore delle batterie
                batterieCounter = data.batterie.length;
            }
            
            // Aggiorna la visibilità degli elementi condizionali
            toggleEvChargerNumber();
            toggleParallelBoxNumber();
            toggleEssCabinetNumber();
            aggiornaDimensioniModulo();
            toggleStaffeInput();
            toggleParallelBoxVisibility();
            
            // Ricalcola il preventivo
            calcolaPreventivoInRealTime();
        }

        // Funzione per avviare il timer di salvataggio automatico
        function startAutoSave() {
            // Cancella il timer precedente se esiste
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }
            
            // Imposta un nuovo timer che salva periodicamente i dati
            autoSaveTimer = setInterval(saveFormData, AUTO_SAVE_INTERVAL);
            
            // Aggiungi event listener per salvare anche quando l'utente modifica il form
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('change', saveFormData);
            });
            
            // Aggiungi il salvataggio anche quando l'utente sta per chiudere la pagina
            window.addEventListener('beforeunload', saveFormData);
        }

        // Funzione per mostrare il dialog di ripristino con elenco delle sessioni
        function showRestoreDialog() {
            // Trova tutte le sessioni salvate
            const savedSessions = [];
            
            // Iterare su tutti gli elementi del localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Filtra solo le chiavi che iniziano con 'prisma_autosave_'
                if (key.startsWith('prisma_autosave_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        // Estrai le informazioni principali
                        savedSessions.push({
                            key: key,
                            nomeCliente: data.nomeCognomeCliente || key.split('_')[2] || 'Cliente sconosciuto',
                            riferimento: data.riferimentoPreventivo || key.split('_')[3] || '',
                            lastSaved: new Date(data.lastSaved),
                            data: data
                        });
                    } catch (e) {
                        console.error('Errore nel parsing della sessione:', key, e);
                    }
                }
            }
            
            // Se non ci sono sessioni salvate, non mostrare nulla
            if (savedSessions.length === 0) {
                initializeFalde();
                startAutoSave();
                return;
            }
            
            // Ordina le sessioni per data (più recenti prima)
            savedSessions.sort((a, b) => b.lastSaved - a.lastSaved);
            
            // Crea il dialog
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.right = '0';
            dialogOverlay.style.bottom = '0';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            dialogOverlay.style.zIndex = '1000';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            const dialogBox = document.createElement('div');
            dialogBox.style.backgroundColor = 'white';
            dialogBox.style.padding = '2rem';
            dialogBox.style.borderRadius = '0.5rem';
            dialogBox.style.maxWidth = '700px';
            dialogBox.style.maxHeight = '80vh';
            dialogBox.style.overflowY = 'auto';
            dialogBox.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            
            let sessionsListHTML = '';
            savedSessions.forEach((session, index) => {
                const timeAgo = getTimeAgo(session.lastSaved);
                sessionsListHTML += `
                    <div class="session-item" style="padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; transition: all 0.2s; position: relative;" 
                        onmouseover="this.style.backgroundColor='#f7fafc'" 
                        onmouseout="this.style.backgroundColor='white'"
                        data-index="${index}" data-key="${session.key}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong style="font-size: 1.1rem; color: #2d3748;">${session.nomeCliente}</strong>
                            <span style="color: #718096; font-size: 0.875rem;">${timeAgo}</span>
                        </div>
                        <div style="color: #4a5568;">
                            <span style="font-size: 0.875rem;">Riferimento: ${session.riferimento}</span>
                        </div>
                        <div style="display: flex; margin-top: 0.75rem; justify-content: space-between; align-items: center;">
                            <button class="restore-session" style="padding: 0.4rem 0.75rem; background-color: #0F3460; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Ripristina</button>
                            <button class="delete-session" style="padding: 0.4rem 0.75rem; background-color: white; color: #e53e3e; border: 1px solid #e53e3e; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">Elimina</button>
                        </div>
                    </div>
                `;
            });
            
            dialogBox.innerHTML = `
                <h2 style="margin-top: 0; font-size: 1.5rem; font-weight: bold; color: #0F3460; margin-bottom: 1.5rem;">Sessioni Salvate</h2>
                <div id="sessions-list" style="margin-bottom: 1.5rem;">
                    ${sessionsListHTML}
                </div>
                <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 1.5rem;">
                    <button id="startNewSession" style="padding: 0.5rem 1rem; background-color: #e2e8f0; border: none; border-radius: 0.25rem; cursor: pointer; flex-grow: 1;">Nuova Sessione</button>
                </div>
            `;
            
            dialogOverlay.appendChild(dialogBox);
            document.body.appendChild(dialogOverlay);
            
            // Funzione per calcolare il tempo trascorso
            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMin = Math.floor(diffMs / (1000 * 60));
                
                if (diffMin < 1) return 'Appena salvato';
                if (diffMin < 60) return `${diffMin} minuti fa`;
                
                const diffHours = Math.floor(diffMin / 60);
                if (diffHours < 24) return `${diffHours} ore fa`;
                
                const diffDays = Math.floor(diffHours / 24);
                if (diffDays < 30) return `${diffDays} giorni fa`;
                
                const diffMonths = Math.floor(diffDays / 30);
                return `${diffMonths} mesi fa`;
            }
            
            // Aggiungi event listeners
            document.getElementById('startNewSession').addEventListener('click', function() {
                dialogOverlay.remove();
                initializeFalde();
                startAutoSave();
            });
            
            // Aggiungi event listeners per i pulsanti di ripristino
            document.querySelectorAll('.restore-session').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sessionItem = this.closest('.session-item');
                    const index = parseInt(sessionItem.getAttribute('data-index'));
                    const session = savedSessions[index];
                    dialogOverlay.remove();
                    restoreFormData(session.data);
                    startAutoSave();
                });
            });

            // Aggiungi event listeners per i pulsanti di eliminazione
            document.querySelectorAll('.delete-session').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sessionItem = this.closest('.session-item');
                    const key = sessionItem.getAttribute('data-key');
                    
                    if (confirm('Sei sicuro di voler eliminare questa sessione salvata?')) {
                        localStorage.removeItem(key);
                        sessionItem.style.opacity = '0.5';
                        sessionItem.style.pointerEvents = 'none';
                        
                        // Controlla se ci sono ancora sessioni attive
                        const remainingSessions = document.querySelectorAll('.session-item:not([style*="opacity: 0.5"])');
                        if (remainingSessions.length === 0) {
                            dialogOverlay.remove();
                            initializeFalde();
                            startAutoSave();
                        }
                        
                        // Feedback all'utente
                        const saveStatus = document.getElementById('saveStatus');
                        if (saveStatus) {
                            saveStatus.textContent = 'Sessione eliminata';
                            saveStatus.style.opacity = '1';
                            setTimeout(() => {
                                saveStatus.style.opacity = '0';
                            }, 3000);
                        }
                    }
                });
            });
        }

        // Aggiungi un elemento per mostrare lo stato del salvataggio
        function addSaveStatusElement() {
            const statusElement = document.createElement('div');
            statusElement.id = 'saveStatus';
            statusElement.style.position = 'fixed';
            statusElement.style.bottom = '10px';
            statusElement.style.right = '10px';
            statusElement.style.padding = '5px 10px';
            statusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            statusElement.style.color = 'white';
            statusElement.style.borderRadius = '4px';
            statusElement.style.fontSize = '12px';
            statusElement.style.zIndex = '1000';
            statusElement.style.opacity = '0';
            statusElement.style.transition = 'opacity 0.3s';
            
            document.body.appendChild(statusElement);
        }

        // Funzione per aggiungere pulsanti di salvataggio/ripristino manuali
        function addManualControls() {
            // Mantieni la creazione del clearButton nel container superiore
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'save-controls';
            controlsContainer.style.display = 'flex';
            controlsContainer.style.flexWrap = 'wrap';
            controlsContainer.style.gap = '10px';
            controlsContainer.style.marginTop = '10px';
            controlsContainer.style.width = '100%';
            
            // Create Clear button with better styling
            const clearButton = document.createElement('button');
            clearButton.textContent = 'Cancella Dati Salvati';
            clearButton.className = 'clear-button';
            clearButton.style.padding = '8px 15px';
            clearButton.style.backgroundColor = '#f8f9fa';
            clearButton.style.color = '#e53e3e';
            clearButton.style.border = '1px solid #e53e3e';
            clearButton.style.borderRadius = '4px';
            clearButton.style.cursor = 'pointer';
            clearButton.style.display = 'flex';
            clearButton.style.alignItems = 'center';
            clearButton.style.gap = '5px';
            clearButton.style.fontWeight = '500';
            clearButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>Cancella tutti i dati di tutti i preventivi`;
            clearButton.onclick = function() {
                if (confirm('Sei sicuro di voler cancellare tutti i dati salvati?')) {
                    // Cerca tutte le chiavi nel localStorage che iniziano con "prisma_autosave_"
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('prisma_autosave_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    // Rimuovi tutte le chiavi trovate
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Feedback all'utente
                    const saveStatus = document.getElementById('saveStatus');
                    saveStatus.textContent = `${keysToRemove.length} sessioni cancellate`;
                    saveStatus.style.opacity = '1';
                    setTimeout(() => {
                        saveStatus.style.opacity = '0';
                    }, 3000);
                }
            };
            
            // Add only clearButton to the top container
            controlsContainer.appendChild(clearButton);
            
            // Insert top container in the header area
            const header = document.querySelector('.max-w-4xl.mx-auto.bg-white.bg-opacity-50');
            if (header) {
                header.insertBefore(controlsContainer, header.querySelector('form'));
            } else {
                document.body.appendChild(controlsContainer);
            }
            
            // Crea il bottone "Salva File"
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Salva File';
            saveButton.className = 'save-button';
            saveButton.type = 'button';
            saveButton.style.padding = '12px 24px';
            saveButton.style.backgroundColor = '#0F3460';
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.borderRadius = '8px';
            saveButton.style.fontWeight = 'bold';
            saveButton.style.cursor = 'pointer';
            saveButton.style.display = 'flex';
            saveButton.style.alignItems = 'center';
            saveButton.style.justifyContent = 'center';
            saveButton.style.width = '100%';
            saveButton.style.maxWidth = '300px';
            saveButton.style.margin = '0 auto';
            saveButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Salva File`;
            saveButton.onclick = function() {
                // Prevent default behavior
                if (event) {
                    event.preventDefault();
                }

                // Prima salviamo nel localStorage
                saveFormData();
                
                // Poi prepariamo il download del file JSON
                // Raccogliamo tutti i dati del form
                const data = {};
            
                // Raccogli dati dai campi di input
                document.querySelectorAll('input, select, textarea').forEach(element => {
                    if (element.id && element.type !== 'file') {
                        if (element.type === 'checkbox' || element.type === 'radio') {
                            data[element.id] = element.checked;
                        } else {
                            data[element.id] = element.value;
                        }
                    }
                });
                
                // Raccogli dati delle falde
                data.falde = [];
                document.querySelectorAll('.falda-group').forEach(falda => {
                    const faldaData = {
                        nome: falda.querySelector('.falda-nome')?.value || '',
                        larghezza: falda.querySelector('.falda-larghezza')?.value || '',
                        lunghezza: falda.querySelector('.falda-lunghezza')?.value || '',
                        inclinazione: falda.querySelector('.falda-inclinazione')?.value || '',
                        gruppiModuli: []
                    };
                    
                    // Raccogli dati dei gruppi di moduli per questa falda
                    falda.querySelectorAll('.gruppo-moduli-item').forEach(gruppo => {
                        const gruppoId = gruppo.getAttribute('data-gruppo-id');
                        faldaData.gruppiModuli.push({
                            id: gruppoId,
                            nome: gruppo.querySelector('.gruppo-nome')?.value || '',
                            orientamento: gruppo.querySelector('.gruppo-orientamento')?.value || '',
                            numeroFile: gruppo.querySelector('.gruppo-numero-file')?.value || '',
                            moduliPerFila: gruppo.querySelector('.gruppo-moduli-fila')?.value || '',
                            modulo: gruppo.querySelector('.gruppo-modulo')?.value || ''
                        });
                    });
                    
                    data.falde.push(faldaData);
                });
                
                // Raccogli dati degli inverter
                data.inverters = [];
                document.querySelectorAll('.inverter-group').forEach(inverter => {
                    const inverterData = {
                        model: inverter.querySelector('.inverter-select').value,
                        stringhe: inverter.querySelector('.numero-stringhe').value,
                        quantita: inverter.querySelector('.numero-inverter').value
                    };
                    data.inverters.push(inverterData);
                });
            
                // Raccogli dati delle batterie
                data.batterie = [];
                document.querySelectorAll('.batteria-group').forEach(batteria => {
                    const batteriaData = {
                        model: batteria.querySelector('.batteria-select').value,
                        quantita: batteria.querySelector('.numero-batterie').value
                    };
                    data.batterie.push(batteriaData);
                });
                
                // Aggiungi metadati
                data.nomeFile = document.getElementById('nomeCognomeCliente').value || 'Cliente';
                data.riferimentoPreventivo = document.getElementById('riferimentoPreventivo').value || numeroPreventivo;
                data.dataCreazione = new Date().toISOString();
                data.appVersion = CURRENT_APP_VERSION;
                data.fileVersion = FORMATO_FILE;

                // Converti i dati in JSON
                const jsonData = JSON.stringify(data, null, 2);
                
                // Crea un blob con il JSON
                const blob = new Blob([jsonData], { type: 'application/json' });
                
                // Crea un URL per il download
                const url = URL.createObjectURL(blob);
                
                // Crea un elemento <a> per scaricare il file
                const a = document.createElement('a');
                a.href = url;
                a.download = `Preventivo_${data.nomeFile.replace(/\s+/g, '_')}_${numeroPreventivo}.prisma`;
                
                // Aggiungi l'elemento al DOM e simula un click per avviare il download
                document.body.appendChild(a);
                a.click();
                
                // Pulisci dopo il download
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Feedback all'utente
                const saveStatus = document.getElementById('saveStatus');
                saveStatus.textContent = 'File PRISMA scaricato con successo';
                saveStatus.style.opacity = '1';
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                }, 3000);
            };
            
            // Trova il bottone "Genera Preventivo"
            const generaButton = document.getElementById('generaPreventivo');
            if (generaButton) {
                // Crea un primo container per il pulsante "Salva File"
                const saveFileContainer = document.createElement('div');
                saveFileContainer.className = 'save-file-container';
                saveFileContainer.style.display = 'flex';
                saveFileContainer.style.justifyContent = 'center';
                saveFileContainer.style.marginBottom = '20px';
                
                // Aggiungi il pulsante Salva File al suo container
                saveFileContainer.appendChild(saveButton);
                
                // Crea un secondo container per il pulsante "Genera Preventivo"
                const generateContainer = document.createElement('div');
                generateContainer.className = 'generate-container';
                generateContainer.style.display = 'flex';
                generateContainer.style.flexDirection = 'column';
                generateContainer.style.alignItems = 'center';
                generateContainer.style.justifyContent = 'center';
                
                // Recupera il contenitore originale e il pulsante
                const originalParent = generaButton.parentNode;
                originalParent.removeChild(generaButton);
                
                // Stilizza il pulsante Genera Preventivo
                generaButton.style.margin = '0 auto';
                generaButton.style.width = '100%';
                generaButton.style.maxWidth = '300px';
                generaButton.style.justifyContent = 'center';
                
                // Aggiungi il pulsante Genera Preventivo al suo container
                generateContainer.appendChild(generaButton);
                
                // Aggiungi i container uno dopo l'altro nel punto originale
                originalParent.appendChild(saveFileContainer);
                originalParent.appendChild(generateContainer);
                
                // Aggiungi media query per schermi più grandi
                if (!document.getElementById('responsive-buttons-style')) {
                    const mediaQuery = document.createElement('style');
                    mediaQuery.id = 'responsive-buttons-style';
                    mediaQuery.textContent = `
                        @media (min-width: 768px) {
                            .save-button, #generaPreventivo, .download-button {
                                width: auto !important;
                                max-width: none !important;
                            }
                        }
                    `;
                    document.head.appendChild(mediaQuery);
                }
            }
        }

        // Funzione per creare il pulsante di importazione
        function addImportButton() {
            // Ottieni il container dei controlli esistente o creane uno nuovo
            let controlsContainer = document.querySelector('.save-controls');
            if (!controlsContainer) {
                controlsContainer = document.createElement('div');
                controlsContainer.className = 'save-controls';
                controlsContainer.style.display = 'flex';
                controlsContainer.style.gap = '10px';
                controlsContainer.style.marginTop = '10px';
                
                // Inserisci nel header area
                const header = document.querySelector('.max-w-4xl.mx-auto.bg-white.bg-opacity-50');
                if (header) {
                    header.insertBefore(controlsContainer, header.querySelector('form'));
                } else {
                    document.body.appendChild(controlsContainer);
                }
            }
            
            // Crea il pulsante di importazione file con input nascosto
            const importButton = document.createElement('button');
            importButton.className = 'import-button';
            importButton.style.padding = '8px 15px';
            importButton.style.backgroundColor = '#2E8B57'; // Verde
            importButton.style.color = 'white';
            importButton.style.border = 'none';
            importButton.style.borderRadius = '4px';
            importButton.style.cursor = 'pointer';
            importButton.style.display = 'flex';
            importButton.style.alignItems = 'center';
            importButton.style.gap = '5px';
            importButton.style.fontWeight = '500';
            importButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Importa Preventivo`;
            
            // Crea l'elemento input nascosto per la selezione del file
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'importFileInput';
            fileInput.accept = '.prisma,application/json';
            fileInput.style.display = 'none';
            
            // Quando il pulsante viene cliccato, simula il click sull'input file
            importButton.onclick = function() {
                fileInput.click();
            };
            
            // Quando un file viene selezionato, leggi e importa i dati
            fileInput.onchange = function(event) {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    readImportedFile(file);
                }
            };
            
            // Aggiungi gli elementi al DOM
            document.body.appendChild(fileInput);
            controlsContainer.insertBefore(importButton, controlsContainer.firstChild);
        }

        // Funzione per leggere il file importato
        function readImportedFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    // Verifica che il file sia un preventivo valido
                    if (isValidPreventivoFile(jsonData)) {
                        // Verifica la compatibilità delle versioni
                        const versionInfo = checkVersionCompatibility(jsonData);
                        
                        if (!versionInfo.compatible) {
                            // Se non è compatibile, mostra un avviso
                            showVersionWarning(versionInfo, jsonData);
                        } else if (versionInfo.needsMigration) {
                            // Se è necessaria una migrazione, chiedi conferma
                            confirmMigration(jsonData, versionInfo);
                        } else {
                            // Altrimenti, procedi con l'importazione normale
                            confirmImport(jsonData);
                        }
                    } else {
                        showImportError('Il file non sembra essere un preventivo valido.');
                    }
                } catch (error) {
                    console.error('Errore durante la lettura del file:', error);
                    showImportError('Impossibile leggere il file. Assicurati che sia un file PRISMA valido.');
                }
            };
            
            reader.onerror = function() {
                showImportError('Errore durante la lettura del file.');
            };
            
            reader.readAsText(file);
        }

        // Funzione per verificare la compatibilità della versione
        function checkVersionCompatibility(data) {
            // Se non c'è informazione sulla versione, probabilmente è un file più vecchio
            if (!data.appVersion || !data.fileVersion) {
                return {
                    compatible: true,
                    warnings: ["Il file è stato creato con una versione precedente di PRISMA che non includeva informazioni sulla versione."],
                    needsMigration: false
                };
            }
            
            // Controlla la versione dell'app
            const appVersionParts = data.appVersion.split('.');
            const currentAppVersionParts = CURRENT_APP_VERSION.split('.');
            
            const majorAppVersion = parseInt(appVersionParts[0]) || 0;
            const currentMajorAppVersion = parseInt(currentAppVersionParts[0]) || 0;
            
            // Controlla la versione del file
            const fileVersionParts = data.fileVersion.split('.');
            const majorFileVersion = parseInt(fileVersionParts[0]) || 0;
            
            // Logica di compatibilità
            let compatible = true;
            let warnings = [];
            let needsMigration = false;
            
            // Controlla incompatibilità di versione principale (major version)
            if (majorAppVersion > currentMajorAppVersion) {
                compatible = false;
                warnings.push(`Il file è stato creato con una versione più recente di PRISMA (${data.appVersion}) rispetto a quella attuale (${CURRENT_APP_VERSION}).`);
            } 
            // Controlla se è necessaria una migrazione
            else if (majorAppVersion < currentMajorAppVersion || majorFileVersion < 1) {
                needsMigration = true;
                warnings.push(`Il file è stato creato con una versione precedente di PRISMA (${data.appVersion || "sconosciuta"}). Potrebbe essere necessario aggiornare alcuni campi.`);
            }
            
            return {
                compatible,
                warnings,
                needsMigration,
                sourceVersion: data.appVersion || "sconosciuta",
                sourceFileVersion: data.fileVersion || "sconosciuta"
            };
        }

        // Funzione per mostrare avvisi di versione
        function showVersionWarning(versionInfo, data) {
            // Crea l'overlay di avviso
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';
            
            // Crea la finestra di dialogo
            const dialog = document.createElement('div');
            dialog.style.width = '450px';
            dialog.style.maxWidth = '90%';
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '6px';
            dialog.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            dialog.style.padding = '20px';
            
            // Contenuto della finestra di dialogo
            dialog.innerHTML = `
                <h2 style="margin-top: 0; color: #e53e3e; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; color: #e53e3e;">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Incompatibilità di Versione
                </h2>
                <div style="background-color: #fff5f5; border-left: 4px solid #e53e3e; padding: 12px; margin-bottom: 15px;">
                    ${versionInfo.warnings.map(warning => `<p style="margin: 0 0 8px 0;">${warning}</p>`).join('')}
                </div>
                <p style="margin-bottom: 20px;">
                    <strong>Versione file:</strong> ${versionInfo.sourceVersion || "sconosciuta"}<br>
                    <strong>Versione PRISMA attuale:</strong> ${CURRENT_APP_VERSION}
                </p>
                <p style="margin-bottom: 20px;">
                    Si consiglia di aggiornare PRISMA all'ultima versione o di utilizzare una versione compatibile con questo file.
                </p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="cancelImport" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #cbd5e0; border-radius: 4px; cursor: pointer;">Annulla</button>
                    <button id="forceImport" style="padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">Importa Comunque</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Gestione degli eventi dei pulsanti
            document.getElementById('cancelImport').onclick = function() {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('forceImport').onclick = function() {
                document.body.removeChild(overlay);
                confirmImport(data);
            };
        }

        // Funzione per confermare la migrazione
        function confirmMigration(data, versionInfo) {
            // Crea l'overlay di conferma
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';
            
            // Crea la finestra di dialogo
            const dialog = document.createElement('div');
            dialog.style.width = '450px';
            dialog.style.maxWidth = '90%';
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '6px';
            dialog.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            dialog.style.padding = '20px';
            
            // Raccogli le informazioni principali dal file
            const clienteName = data.nomeCognomeCliente || data.nomeFile || 'Cliente non specificato';
            const riferimento = data.riferimentoPreventivo || 'Riferimento non specificato';
            const dataCreazione = data.dataCreazione || data.lastSaved 
                ? new Date(data.dataCreazione || data.lastSaved).toLocaleString()
                : 'Data non specificata';
            
            // Contenuto della finestra di dialogo
            dialog.innerHTML = `
                <h2 style="margin-top: 0; color: #3182ce; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; color: #3182ce;">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                    </svg>
                    Migrazione Necessaria
                </h2>
                <div style="background-color: #ebf8ff; border-left: 4px solid #3182ce; padding: 12px; margin-bottom: 15px;">
                    ${versionInfo.warnings.map(warning => `<p style="margin: 0 0 8px 0;">${warning}</p>`).join('')}
                </div>
                <p style="margin-bottom: 5px;"><strong>Cliente:</strong> ${clienteName}</p>
                <p style="margin-bottom: 5px;"><strong>Riferimento:</strong> ${riferimento}</p>
                <p style="margin-bottom: 15px;"><strong>Data:</strong> ${dataCreazione}</p>
                <p style="margin-bottom: 20px;">
                    PRISMA aggiornerà automaticamente il formato del file alla versione corrente. Alcuni campi potrebbero essere modificati durante questo processo.
                </p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="cancelImport" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #cbd5e0; border-radius: 4px; cursor: pointer;">Annulla</button>
                    <button id="confirmMigration" style="padding: 8px 16px; background: #3182ce; color: white; border: none; border-radius: 4px; cursor: pointer;">Aggiorna e Importa</button>
                    <button id="skipMigration" style="padding: 8px 16px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 4px; cursor: pointer;">Importa Senza Aggiornare</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Gestione degli eventi dei pulsanti
            document.getElementById('cancelImport').onclick = function() {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('confirmMigration').onclick = function() {
                document.body.removeChild(overlay);
                // Esegui la migrazione
                const migratedData = migrateData(data, versionInfo);
                confirmImport(migratedData);
            };
            
            document.getElementById('skipMigration').onclick = function() {
                document.body.removeChild(overlay);
                confirmImport(data);
            };
        }

        // Funzione per migrare i dati da versioni precedenti
        function migrateData(data, versionInfo) {
            // Clona i dati per non modificare l'originale
            const migratedData = JSON.parse(JSON.stringify(data));
            
            // Migrazione per versioni precedenti alla 3.2
            if (!data.appVersion || compareVersions(data.appVersion, "3.31") < 0) {
                console.log("Esecuzione migrazione per versioni precedenti alla 3.31");
                
                // Esempio: assicurarsi che i nuovi campi introdotti nella 3.2 esistano
                migratedData.percentualeIva = migratedData.percentualeIva || 10;
            }
            
            // Aggiorna alla versione corrente
            migratedData.appVersion = CURRENT_APP_VERSION;
            migratedData.fileVersion = "2.0";
            migratedData.migratedFrom = data.appVersion || "sconosciuta";
            migratedData.migratedDate = new Date().toISOString();
            
            return migratedData;
        }

        // Utility per confrontare versioni semver
        function compareVersions(v1, v2) {
            const v1Parts = v1.split('.').map(Number);
            const v2Parts = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(v1Parts.length, v2Parts.length); i++) {
                const v1Part = v1Parts[i] || 0;
                const v2Part = v2Parts[i] || 0;
                
                if (v1Part > v2Part) return 1;
                if (v1Part < v2Part) return -1;
            }
            
            return 0;
        }

        // Soluzione 2: Creare un container separato per il pulsante versione sopra gli altri controlli
        function addVersionButton_alternative() {
            const header = document.querySelector('.max-w-4xl.mx-auto.bg-white.bg-opacity-50');
            if (!header) return;

            // Trova o crea il container per gli altri controlli
            let controlsContainer = document.querySelector('.save-controls');
            
            // Crea un nuovo container specifico per il pulsante versione
            const versionContainer = document.createElement('div');
            versionContainer.className = 'version-container';
            versionContainer.style.display = 'flex';
            versionContainer.style.justifyContent = 'flex-end'; // Allinea a destra
            versionContainer.style.marginBottom = '10px';
            
            // Crea il pulsante versione
            const versionButton = document.createElement('button');
            versionButton.className = 'version-button';
            versionButton.style.padding = '8px 12px';
            versionButton.style.backgroundColor = '#f0f4f8';
            versionButton.style.color = '#0F3460';
            versionButton.style.border = '1px solid #d0d7de';
            versionButton.style.borderRadius = '20px';
            versionButton.style.cursor = 'pointer';
            versionButton.style.display = 'flex';
            versionButton.style.alignItems = 'center';
            versionButton.style.fontSize = '0.875rem';
            versionButton.style.fontWeight = '600';
            versionButton.style.transition = 'all 0.2s ease';
            versionButton.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
            
            // Effetto hover
            versionButton.onmouseover = function() {
                this.style.backgroundColor = '#e1e8ef';
                this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            };
            versionButton.onmouseout = function() {
                this.style.backgroundColor = '#f0f4f8';
                this.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
            };
            
            // Icona e testo del pulsante
            versionButton.innerHTML = `
                <span style="position: relative; padding-right: 4px;">PRISMA</span>
                <span style="background-color: #0F3460; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px;">v${CURRENT_APP_VERSION}</span>
            `;
            
            // Aggiungi l'event listener
            versionButton.addEventListener('click', showVersionInfo);
            
            // Aggiungi il pulsante al container versione
            versionContainer.appendChild(versionButton);
            
            // Inserisci il container versione prima dei controlli esistenti
            if (controlsContainer) {
                // Inserisci prima del container controlli esistente
                header.insertBefore(versionContainer, controlsContainer);
            } else {
                // Inserisci all'inizio dell'header, prima del form
                header.insertBefore(versionContainer, header.querySelector('form'));
            }
        }

        // Funzione per verificare se il file è un preventivo valido
        function isValidPreventivoFile(data) {
            // Verifica la presenza di almeno alcuni campi chiave
            return (
                data && 
                (data.falde !== undefined || 
                data.inverters !== undefined || 
                data.batterie !== undefined) &&
                (data.nomeFile !== undefined || 
                data.nomeCognomeCliente !== undefined)
            );
        }

        // Funzione per chiedere conferma prima di importare
        function confirmImport(data) {
            // DEBUG: visualizza l'intero oggetto data nella console
            console.log("Dati completi:", JSON.stringify(data, null, 2));
            
            // Estrai versioni con controlli espliciti
            let appVersionText = "Versione non rilevata";
            let fileVersionText = "Versione non rilevata";
            
            try {
                // Accedi alle proprietà in modo "difensivo"
                if (data && typeof data === 'object') {
                    console.log("Proprietà dell'oggetto:", Object.keys(data));
                    
                    if (Object.prototype.hasOwnProperty.call(data, "appVersion")) {
                        appVersionText = String(data.appVersion);
                        console.log("appVersion trovata:", appVersionText);
                    }
                    
                    if (Object.prototype.hasOwnProperty.call(data, "fileVersion")) {
                        fileVersionText = String(data.fileVersion);
                        console.log("fileVersion trovata:", fileVersionText);
                    }
                }
            } catch (e) {
                console.error("Errore nell'accesso alle proprietà di versione:", e);
            }
            
            // Estrai altre informazioni in modo sicuro
            const clienteName = data && data.nomeCognomeCliente 
                ? data.nomeCognomeCliente 
                : (data && data.nomeFile ? data.nomeFile : 'Cliente non specificato');
            
            const riferimento = data && data.riferimentoPreventivo 
                ? data.riferimentoPreventivo 
                : 'Riferimento non specificato';
            
            let dataCreazione = 'Data non specificata';
            try {
                if (data && data.dataCreazione) {
                    dataCreazione = new Date(data.dataCreazione).toLocaleString();
                } else if (data && data.lastSaved) {
                    dataCreazione = new Date(data.lastSaved).toLocaleString();
                }
            } catch (e) {
                console.error("Errore nel formato data:", e);
            }
            
            // Crea l'overlay di conferma
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';
            
            // Crea la finestra di dialogo
            const dialog = document.createElement('div');
            dialog.style.width = '400px';
            dialog.style.maxWidth = '90%';
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '6px';
            dialog.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            dialog.style.padding = '20px';
            
            // Contenuto della finestra di dialogo
            dialog.innerHTML = `
                <h2 style="margin-top: 0; color: #0F3460; font-size: 18px; margin-bottom: 15px;">Importare il preventivo?</h2>
                <div style="margin-bottom: 15px; background-color: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #0F3460;">
                    <p style="margin: 0 0 8px 0;"><strong>Cliente:</strong> ${clienteName}</p>
                    <p style="margin: 0 0 8px 0;"><strong>Riferimento:</strong> ${riferimento}</p>
                    <p style="margin: 0 0 8px 0;"><strong>Data:</strong> ${dataCreazione}</p>
                    <p style="margin: 0;"><strong>PRISMA:</strong> v${appVersionText} (Formato file: ${fileVersionText})</p>
                </div>
                <p style="color: #e53e3e; margin-bottom: 20px;">Attenzione: questa operazione sovrascriverà i dati del preventivo corrente.</p>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="cancelImport" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #cbd5e0; border-radius: 4px; cursor: pointer;">Annulla</button>
                    <button id="confirmImport" style="padding: 8px 16px; background: #2E8B57; color: white; border: none; border-radius: 4px; cursor: pointer;">Importa</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Gestione degli eventi dei pulsanti
            document.getElementById('cancelImport').onclick = function() {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('confirmImport').onclick = function() {
                document.body.removeChild(overlay);
                importPreventivo(data);
            };
        }

        // Funzione per importare effettivamente i dati del preventivo
        function importPreventivo(data) {
            try {
                // Resetta gli elementi dinamici prima di importare
                resetDynamicElements();
                
                // Importa i dati nei campi del form
                importFormData(data);
                
                // Ricalcola il preventivo e aggiorna l'interfaccia
                calcolaPreventivoInRealTime();
                
                // Mostra un feedback di successo
                showImportSuccess('Preventivo importato con successo!');
                console.log("Preventivo importato con successo!")
            } catch (error) {
                console.error('Errore durante l\'importazione:', error);
                showImportError('Si è verificato un errore durante l\'importazione del preventivo.');
            }
        }

        // Funzione per resettare gli elementi dinamici
        function resetDynamicElements() {
            // Reset delle falde
            const faldeContainer = document.getElementById('faldeContainer');
            if (faldeContainer) faldeContainer.innerHTML = '';
            
            // Reset degli inverter
            const invertersContainer = document.getElementById('invertersContainer');
            if (invertersContainer) invertersContainer.innerHTML = '';
            
            // Reset delle batterie
            const batterieContainer = document.getElementById('batterieContainer');
            if (batterieContainer) batterieContainer.innerHTML = '';
            
            // Reset dei contatori
            faldeCounter = 0;
            inverterCounter = 0;
            batterieCounter = 0;
        }

        // Funzione per importare i dati nel form
        function importFormData(data) {
            // Importa i campi semplici
            for (const id in data) {
                const element = document.getElementById(id);
                if (element && id !== 'falde' && id !== 'inverters' && id !== 'batterie' && 
                    id !== 'dataCreazione' && id !== 'nomeFile' && id !== 'lastSaved') {
                    
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        element.checked = data[id];
                    } else {
                        element.value = data[id];
                    }
                }
            }
            
            // Importa le falde
            if (data.falde && Array.isArray(data.falde)) {
                const faldeContainer = document.getElementById('faldeContainer');
                
                data.falde.forEach((faldaData, index) => {
                    const newFaldaHTML = createFaldaTemplate(index);
                    faldeContainer.insertAdjacentHTML('beforeend', newFaldaHTML);
                    
                    const newFalda = faldeContainer.lastElementChild;
                    setupFaldaEventListeners(newFalda);
                    
                    // Imposta i valori della falda
                    newFalda.querySelector('.falda-nome').value = faldaData.nome || `Falda ${index + 1}`;
                    newFalda.querySelector('.falda-larghezza').value = faldaData.larghezza || '0';
                    newFalda.querySelector('.falda-lunghezza').value = faldaData.lunghezza || '0';
                    newFalda.querySelector('.falda-inclinazione').value = faldaData.inclinazione || '30';
                    
                    // Verifica se ci sono gruppi di moduli salvati o se dobbiamo migrare dati dal vecchio formato
                    if (faldaData.gruppiModuli && faldaData.gruppiModuli.length > 0) {
                        // Nuova struttura con gruppi di moduli
                        const gruppiContainer = newFalda.querySelector('.gruppi-moduli-container');
                        gruppiContainer.innerHTML = ''; // Rimuovi eventuali gruppi predefiniti
                        
                        faldaData.gruppiModuli.forEach((gruppoData, gruppoIndex) => {
                            const gruppoId = gruppoIndex;
                            gruppiContainer.insertAdjacentHTML('beforeend', createGruppoModuliTemplate(index, gruppoId));
                            const newGruppo = gruppiContainer.lastElementChild;
                            setupGruppoModuliEventListeners(newGruppo, index, gruppoId);
                            
                            // Imposta i valori del gruppo
                            newGruppo.querySelector('.gruppo-nome').value = gruppoData.nome || `Gruppo ${gruppoId + 1}`;
                            newGruppo.querySelector('.gruppo-orientamento').value = gruppoData.orientamento || 'verticale';
                            newGruppo.querySelector('.gruppo-numero-file').value = gruppoData.numeroFile || '1';
                            newGruppo.querySelector('.gruppo-moduli-fila').value = gruppoData.moduliPerFila || '1';
                            newGruppo.querySelector('.gruppo-modulo').value = gruppoData.modulo || 'longi440';
                            
                            // Aggiorna il contatore per il prossimo gruppo
                            if (!gruppiCounters[index] || gruppiCounters[index] <= gruppoId) {
                                gruppiCounters[index] = gruppoId + 1;
                            }
                        });
                    } else if (faldaData.orientamento || faldaData.numeroFile || faldaData.moduliPerFila || faldaData.modulo) {
                        // Vecchia struttura - migra i dati a un nuovo gruppo di moduli
                        const gruppiContainer = newFalda.querySelector('.gruppi-moduli-container');
                        gruppiContainer.innerHTML = ''; // Rimuovi eventuali gruppi predefiniti
                        
                        const gruppoId = 0;
                        gruppiContainer.insertAdjacentHTML('beforeend', createGruppoModuliTemplate(index, gruppoId));
                        const newGruppo = gruppiContainer.lastElementChild;
                        setupGruppoModuliEventListeners(newGruppo, index, gruppoId);
                        
                        // Imposta i valori del gruppo dai dati della falda
                        newGruppo.querySelector('.gruppo-nome').value = `Gruppo 1`;
                        newGruppo.querySelector('.gruppo-orientamento').value = faldaData.orientamento || 'verticale';
                        newGruppo.querySelector('.gruppo-numero-file').value = faldaData.numeroFile || '1';
                        newGruppo.querySelector('.gruppo-moduli-fila').value = faldaData.moduliPerFila || '1';
                        newGruppo.querySelector('.gruppo-modulo').value = faldaData.modulo || 'longi440';
                        
                        // Imposta il contatore per il prossimo gruppo
                        gruppiCounters[index] = 1;
                    } else {
                        // Nessun dato di gruppo - aggiungi un gruppo predefinito
                        aggiungiGruppoModuli(index);
                    }
                    
                    faldeCounter++;
                });
            }
            
            // Importa gli inverter
            if (data.inverters && Array.isArray(data.inverters)) {
                const invertersContainer = document.getElementById('invertersContainer');
                
                data.inverters.forEach((inverterData, index) => {
                    const newInverterHTML = createInverterTemplate(index);
                    invertersContainer.insertAdjacentHTML('beforeend', newInverterHTML);
                    
                    const newInverter = invertersContainer.lastElementChild;
                    newInverter.querySelector('.rimuovi-inverter').addEventListener('click', function() {
                        newInverter.remove();
                        calcolaPreventivoInRealTime();
                    });
                    
                    newInverter.querySelector('.inverter-select').addEventListener('change', calcolaPreventivoInRealTime);
                    newInverter.querySelector('.numero-stringhe').addEventListener('input', calcolaPreventivoInRealTime);
                    newInverter.querySelector('.numero-inverter').addEventListener('input', calcolaPreventivoInRealTime);
                    
                    // Imposta i valori dell'inverter
                    newInverter.querySelector('.inverter-select').value = inverterData.model || 'none';
                    newInverter.querySelector('.numero-stringhe').value = inverterData.stringhe || '1';
                    newInverter.querySelector('.numero-inverter').value = inverterData.quantita || '1';
                    
                    inverterCounter++;
                });
            }
            
            // Importa le batterie
            if (data.batterie && Array.isArray(data.batterie)) {
                const batterieContainer = document.getElementById('batterieContainer');
                
                data.batterie.forEach((batteriaData, index) => {
                    const newBatteriaHTML = createBatteriaTemplate(index);
                    batterieContainer.insertAdjacentHTML('beforeend', newBatteriaHTML);
                    
                    const newBatteria = batterieContainer.lastElementChild;
                    newBatteria.querySelector('.rimuovi-batteria').addEventListener('click', function() {
                        newBatteria.remove();
                        calcolaPreventivoInRealTime();
                        toggleParallelBoxVisibility();
                    });
                    
                    newBatteria.querySelector('.batteria-select').addEventListener('change', calcolaPreventivoInRealTime);
                    newBatteria.querySelector('.numero-batterie').addEventListener('input', calcolaPreventivoInRealTime);
                    
                    // Imposta i valori della batteria
                    newBatteria.querySelector('.batteria-select').value = batteriaData.model || 'none';
                    newBatteria.querySelector('.numero-batterie').value = batteriaData.quantita || '1';
                    
                    batterieCounter++;
                });
            }
            
            // Aggiorna la visibilità degli elementi condizionali
            toggleEvChargerNumber();
            toggleParallelBoxNumber();
            toggleEssCabinetNumber();
            aggiornaDimensioniModulo();
            toggleStaffeInput();
            toggleParallelBoxVisibility();
        }

        // Funzione per mostrare un messaggio di errore
        function showImportError(message) {
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) {
                saveStatus.textContent = message;
                saveStatus.style.backgroundColor = 'rgba(220, 38, 38, 0.8)';
                saveStatus.style.opacity = '1';
                
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                    setTimeout(() => {
                        saveStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    }, 300);
                }, 3000);
            } else {
                alert(message);
            }
        }

        // Funzione per mostrare un messaggio di successo
        function showImportSuccess(message) {
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) {
                saveStatus.textContent = message;
                saveStatus.style.backgroundColor = 'rgba(16, 185, 129, 0.8)';
                saveStatus.style.opacity = '1';
                
                setTimeout(() => {
                    saveStatus.style.opacity = '0';
                    setTimeout(() => {
                        saveStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    }, 300);
                }, 3000);
            }
        }

        // Funzione di inizializzazione principale
        function initializeImportSystem() {
            addImportButton();
        }

        // Funzione per pulire la cache e liberare memoria
        function clearCacheAndMemory() {
            console.log("Inizio pulizia cache e memoria...");
            
            // Rimuovi tutte le immagini usando la funzione removeImage esistente
            for (let i = 0; i < renderImages.length; i++) {
                if (renderImages[i] !== null) {
                    console.log(`Rimozione immagine ${i+1}...`);
                    removeImage(i);
                }
            }
            
            // Rilascia URL blob esistenti
            const blobUrls = document.querySelectorAll('img[src^="blob:"], a[href^="blob:"]');
            console.log(`Trovati ${blobUrls.length} URL blob da rilasciare`);
            blobUrls.forEach(element => {
                if (element.src) {
                    URL.revokeObjectURL(element.src);
                } else if (element.href) {
                    URL.revokeObjectURL(element.href);
                }
            });
            
            // Resetta gli input file per le immagini
            ['renderImage1', 'renderImage2', 'renderImage3'].forEach(id => {
                const fileInput = document.getElementById(id);
                if (fileInput) {
                    fileInput.value = "";
                }
            });
            
            // Pulisci createdBlobUrls se esiste
            if (typeof createdBlobUrls !== 'undefined') {
                console.log(`Rilascio di ${createdBlobUrls.length} blob URL memorizzati`);
                createdBlobUrls.forEach(url => {
                    URL.revokeObjectURL(url);
                });
                createdBlobUrls = [];
            } else {
                // Se non esiste, crealo
                window.createdBlobUrls = [];
            }
            
            // Forza garbage collection se possibile
            if (window.gc) {
                console.log("Esecuzione garbage collection esplicito...");
                window.gc();
            }
            
            // Pulisci eventuale memoria allocata per il file PVGIS
            if (window.pvgisData && window.pvgisData.outputs) {
                console.log("Pulizia dati PVGIS temporanei...");
                // Mantieni solo le informazioni essenziali
                const essentialData = {
                    outputs: {
                        totals: window.pvgisData.outputs.totals
                    }
                };
                window.pvgisData = essentialData;
            }
            
            // Stampa informazioni sulla memoria prima e dopo la pulizia
            if (window.performance && window.performance.memory) {
                const memoryBefore = window.performance.memory.usedJSHeapSize;
                console.log(`Memoria usata prima della pulizia finale: ${(memoryBefore / (1024 * 1024)).toFixed(2)} MB`);
                
                // Suggerisci ancora una volta al browser di raccogliere la spazzatura
                setTimeout(() => {
                    if (window.performance && window.performance.memory) {
                        const memoryAfter = window.performance.memory.usedJSHeapSize;
                        console.log(`Memoria usata dopo la pulizia: ${(memoryAfter / (1024 * 1024)).toFixed(2)} MB`);
                        console.log(`Differenza: ${((memoryBefore - memoryAfter) / (1024 * 1024)).toFixed(2)} MB liberati`);
                    }
                }, 3000);
            }
            
            console.log("Cache pulita e memoria liberata");
            return true;
        }

        function addCacheCleanButton() {
            // Crea un nuovo pulsante
            const cleanCacheButton = document.createElement('button');
            cleanCacheButton.className = 'clean-cache-button';
            cleanCacheButton.style.padding = '8px 15px';
            cleanCacheButton.style.backgroundColor = '#edf2f7';
            cleanCacheButton.style.color = '#4a5568';
            cleanCacheButton.style.border = '1px solid #cbd5e0';
            cleanCacheButton.style.borderRadius = '4px';
            cleanCacheButton.style.cursor = 'pointer';
            cleanCacheButton.style.display = 'flex';
            cleanCacheButton.style.alignItems = 'center';
            cleanCacheButton.style.gap = '5px';
            cleanCacheButton.style.fontWeight = '500';
            cleanCacheButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>Pulisci Cache`;
            
            // Aggiungi l'event listener
            cleanCacheButton.onclick = function() {
                clearCacheAndMemory();
                
                // Feedback all'utente
                const saveStatus = document.getElementById('saveStatus');
                if (saveStatus) {
                    saveStatus.textContent = 'Cache pulita con successo';
                    saveStatus.style.backgroundColor = 'rgba(16, 185, 129, 0.8)';
                    saveStatus.style.opacity = '1';
                    
                    setTimeout(() => {
                        saveStatus.style.opacity = '0';
                        setTimeout(() => {
                            saveStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                        }, 300);
                    }, 3000);
                }
            };
            
            // Trova il container per i controlli e aggiungi il pulsante
            let controlsContainer = document.querySelector('.save-controls');
            if (controlsContainer) {
                controlsContainer.appendChild(cleanCacheButton);
            } else {
                // Se il container non esiste, creane uno nuovo
                controlsContainer = document.createElement('div');
                controlsContainer.className = 'save-controls';
                controlsContainer.style.display = 'flex';
                controlsContainer.style.gap = '10px';
                controlsContainer.style.marginTop = '10px';
                
                controlsContainer.appendChild(cleanCacheButton);
                
                // Inserisci nel header area
                const header = document.querySelector('.max-w-4xl.mx-auto.bg-white.bg-opacity-50');
                if (header) {
                    header.insertBefore(controlsContainer, header.querySelector('form'));
                } else {
                    document.body.appendChild(controlsContainer);
                }
            }
        }

        // Inizializza il sistema quando il documento è pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza il sistema di importazione
            setTimeout(initializeImportSystem, 500); // Breve delay per assicurarsi che altri componenti siano inizializzati

            // Genera il numero preventivo
            numeroPreventivo = generateRiferimentoPreventivo();

            addVersionButton_alternative();
            addSaveStatusElement();
            addManualControls();
            addCacheCleanButton();
            
            // Controlla se ci sono dati salvati con prefisso "prisma_autosave_"
            let hasStoredData = false;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith('prisma_autosave_')) {
                    hasStoredData = true;
                    break;
                }
            }

            if (hasStoredData) {
                showRestoreDialog();
            } else {
                // Se non ci sono dati salvati, inizializza le falde e avvia il salvataggio automatico
                initializeFalde();
                startAutoSave();
            }
        });

        // Modifica alla funzione generaPreventivo
        document.getElementById('generaPreventivo').addEventListener('click', function() {
            // Recupera le guide totali
            const { guideTotali, staffeTotali, prolungheTotali } = aggiornaGuideTotali();
            const acCableLength = parseFloat(document.getElementById('lunghezzaCaviCA').value) || 0;

            // Usa la variabile globale, o se l'utente ha inserito un valore personalizzato, usa quello
            const riferimentoPreventivo = document.getElementById('riferimentoPreventivo').value || numeroPreventivo;
    
            // Calculate totalLengthCavi the same way as in calcolaPreventivoInRealTime
            const altezzaCapannone = parseFloat(document.getElementById('altezzaCapannone').value) || 0;
            const profonditaCapannone = parseFloat(document.getElementById('profonditaCapannone').value) || 0;
            const margin = 1.2; // 20% margine
            const falde = getFaldeData();
            let baseLengthCavi = 0;
            for (const falda of falde) {
                baseLengthCavi += falda.larghezza + profonditaCapannone + altezzaCapannone + 10;
            }
            const totalLengthCavi = baseLengthCavi * margin;
            
            // Cerca la sezione del grafico di produzione nel codice HTML del preventivo
            if (pvgisData && pvgisData.outputs && pvgisData.outputs.monthly && pvgisData.outputs.monthly.fixed) {
                const monthlyData = pvgisData.outputs.monthly.fixed;
                const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                const maxProduction = Math.max(...monthlyData.map(m => m.E_m || 0));
                
                // Modifica alla funzione per generare il grafico PVGIS
                const originalCreatePVGISChart = function(monthlyData) {
                    let chartHTML = `
                    <div style="height: 200px; position: relative;">
                        <div style="display: flex; height: 150px; align-items: flex-end; justify-content: space-between; margin-top: 20px;">
                    `;
                    
                    monthlyData.forEach((data, index) => {
                        const production = data.E_m || 0;
                        const percentage = (production / maxProduction) * 100;
                        const height = Math.max(5, (percentage * 140) / 100);
                        
                        chartHTML += `
                        <div style="display: flex; flex-direction: column; align-items: center; width: 30px;">
                            <div style="height: ${height}px; width: 20px; background-color: var(--primary-color); border-radius: 2px 2px 0 0;"></div>
                            <div style="margin-top: 5px; font-size: 10px;">${months[index]}</div>
                        </div>`;
                    });
                    
                    // Aggiungiamo le informazioni sulla produzione annuale
                    const totalData = pvgisData.outputs.totals.fixed;
                    const annualProduction = totalData.E_y ? totalData.E_y.toFixed(0) : '---';
                    
                    chartHTML += `
                        </div>
                        <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #666; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 4px;">
                            Produzione annuale stimata: ${annualProduction} kWh (dati PVGIS)
                        </div>
                    </div>`;
                    
                    return chartHTML;
                };
                
                // Aggiunta di intercettazione per modificare il preventivo HTML
                const originalCreateHTML = window.preventivoHTML;
                window.preventivoHTML = function(html) {
                    // Sostituisci la sezione del grafico con quella basata sui dati PVGIS
                    const pvgisChartHTML = originalCreatePVGISChart(monthlyData);
                    
                    return html.replace(
                        /<!-- Simulazione grafico di produzione mensile -->[\s\S]*?<\/div>/,
                        `<!-- Grafico di produzione basato su dati PVGIS -->${pvgisChartHTML}`
                    );
                };
            }
            
            // Se ci sono dati PVGIS, aggiorna il campo della produzione annua
            if (pvgisData && pvgisData.outputs && pvgisData.outputs.totals && pvgisData.outputs.totals.fixed) {
                const potenzaTotale = calcolaPotenzaTotale();
                const totalData = pvgisData.outputs.totals.fixed;
                
                // Aggiorna il campo della produzione annua kWh/kWp
                if (totalData.E_y && potenzaTotale > 0) {
                    const produzionePerKwp = totalData.E_y / potenzaTotale;
                    document.getElementById('produzioneAnnuaKw').value = produzionePerKwp.toFixed(0);
                }
            }
        });

        // Calcolo iniziale
        toggleEvChargerNumber();
        toggleParallelBoxNumber();
        toggleEssCabinetNumber();
        aggiornaDimensioniModulo();
        calcolaPreventivoInRealTime();
        calcolaPotenzaTotale();
        aggiornaGuideTotali();
        toggleStaffeInput();
        calcolaPreventivoInRealTime();
    </script>
</body>
</html>
